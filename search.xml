<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>BeanDefinitionè¯¦ç»†è§£æ</title>
    <url>/posts/60fee82c.html</url>
    <content><![CDATA[<blockquote>
<p>æœ¬æ–‡åŸºäº<code>Spring Boot 2.7.9</code>ä¸<code>Spring Framework 5.3.25</code></p>
</blockquote>
<p>å¯¹äºSpringæ¥è¯´ï¼Œä¸»æµçš„beanåŠ è½½æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§</p>
<ol>
<li>xmlåŠ è½½bean</li>
<li>@ConfigurationåŠ è½½bean</li>
<li>æ‰«æåŠ è½½bean</li>
<li>æ‰‹åŠ¨åŠ è½½bean</li>
</ol>
<p>ä¸Šé¢4ç§æ–¹å¼ä¸­ï¼Œé™¤äº†ç¬¬å››ç‚¹ä½¿ç”¨äº†<code>registerSingleton</code>ç›´æ¥æ³¨å†Œä¸€ä¸ªbeanä»¥å¤–ï¼Œå…¶ä»–ä¸‰ç§æ–¹å¼éƒ½éœ€è¦è§£æå‡ºBeanDefinitionï¼Œæœ€ç»ˆé€šè¿‡BeanDefinitionåˆ›å»ºå‡ºBeanã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºBeanDefinitionåœ¨Springä¸­çš„æ ¸å¿ƒåœ°ä½ï¼Œä»Šå¤©æˆ‘ä»¬å°±ä¸€èµ·çœ‹çœ‹ï¼ŒBeanDefinitionåœ¨Springä¸­æ˜¯æ€ä¹ˆå·¥ä½œçš„</p>
<span id="more"></span>
<h2 id="BeanDefinitionä¾èµ–åˆ†æ">BeanDefinitionä¾èµ–åˆ†æ</h2>
<p>BeanDefinitionä¾èµ–å›¾æ¯”è¾ƒå¤§ï¼Œè¿™é‡Œæ‹†è§£ä¸ºä¸‰ä¸ªå›¾</p>
<ol>
<li>æ ¸å¿ƒä¾èµ–</li>
<li>GenericBeanDefinition</li>
<li>RootBeanDefinition</li>
</ol>
<h3 id="æ ¸å¿ƒä¾èµ–">æ ¸å¿ƒä¾èµ–</h3>
<p>ä»æ ¸å¿ƒä¾èµ–å›¾ä¸Šå¯ä»¥çœ‹åˆ°</p>
<ol>
<li>BeanDefinitioné™¤äº†ä¿æŒBeanå®šä¹‰æ•°æ®ä¹‹å¤–ï¼Œè¿˜æä¾›äº†<code>Attibute</code>å’Œ<code>Metadata</code>çš„ä¿å­˜æ¥å£ï¼Œå¤§å¤§æé«˜äº†BeanDefinitionçš„çµæ´»æ€§</li>
<li>AnnotatedBeanDefinintionç»§æ‰¿BeanDefinitionï¼Œä¸ºæ³¨è§£å®šä¹‰Beançš„åŸºç¡€</li>
<li>æ ¸å¿ƒçš„BeanDefinitionæœ‰ä¸‰ä¸ªï¼Œå‡ç»§æ‰¿äº†AbstractBeanDefinition
<ol>
<li>ChildBeanDefinitionï¼šç”¨æˆ·çˆ¶å­å…³ç³»çš„BeanDefinitionï¼ŒSpringå·²ç»ä¸å»ºè®®ä½¿ç”¨ï¼Œæ¨èä½¿ç”¨GenericBeanDefintion</li>
<li>GenericBeanDefinitionï¼šé€šç”¨çš„BeanDefinition</li>
<li>RootBeanDefinitionï¼šä¸èƒ½ä½œä¸ºå­BeanDefintion</li>
</ol>
</li>
</ol>
<p><img src="/posts/60fee82c/BeanDefinitionCore.svg" alt="BeanDefinitionCore"></p>
<h3 id="GenericBeanDefinition">GenericBeanDefinition</h3>
<p>GenericBeanDefinitionæœ‰äº”ä¸ªæ‰©å±•å®ç°ç±»ï¼Œåˆ†åˆ«åœ¨GenericBeanDefinitionç»§æ‰¿ä¸Šæ‰©å±•äº†å…¶ä»–èƒ½åŠ›</p>
<ol>
<li>ScannedGenericBeanDefinitionï¼šå®ç°äº†<code>AnnotatedBeanDefinition</code>ç”¨äºä¿å­˜æ³¨è§£ç›¸å…³ä¿¡æ¯ï¼Œè¢«<code>@ComponentScan</code>æˆ–è€…<code>context:component-scan</code>æ‰«æå‡ºæ¥çš„Beanä¼šè¢«åˆ›å»ºä¸ºScannedGenericBeanDefinitionã€‚èƒ½è¢«æ‰«æå‡ºæ¥ï¼Œè¯´æ˜å®šä¹‰Beanæ—¶æœ‰<code>@Configuration</code></li>
<li>AnnotatedGenericBeanDefinitionï¼šå’ŒScannedGenericBeanDefinitionç±»ä¼¼ï¼Œåœ¨importå¯¼å…¥Beanæ—¶ä¼šä½¿ç”¨åˆ°</li>
<li>EntityScanPackagesBeanDefinitionï¼šå’Œ<code>@EntityScan</code>ç›¸å…³ï¼ŒSpringè‡ªå·±æ³¨å†Œçš„ä¸€ä¸ªInfrastructureBean</li>
<li>BasePackagesBeanDefinitionï¼šå’Œ<code>@AutoConfigurationPackage</code>ç›¸å…³ï¼ŒSpringè‡ªå·±æ³¨å†Œçš„ä¸€ä¸ªInfrastructureBean</li>
<li>ServletComponentRegisteringPostProcessorBeanDefinitionï¼šå’Œ<code>@ServletComponentScan</code>ç›¸å…³ï¼ŒSpringè‡ªå·±æ³¨å†Œçš„ä¸€ä¸ªInfrastructureBean</li>
</ol>
<p><img src="/posts/60fee82c/BeanDefinitionGeneric.svg" alt="BeanDefinitionGeneric"></p>
<h2 id="RootBeanDefinition">RootBeanDefinition</h2>
<p>RootBeanDefinitionæœ‰ä¸¤ä¸ªä¸ªæ‰©å±•å®ç°ç±»ï¼Œåˆ†åˆ«åœ¨RootBeanDefinitionç»§æ‰¿ä¸Šæ‰©å±•äº†å…¶ä»–èƒ½åŠ›</p>
<ol>
<li>ClassDerivedBeanDefinitionï¼šåªåœ¨<code>GenericApplicationContext</code>ä¸­ä½¿ç”¨ï¼Œä½¿ç”¨BeanClassæ³¨å†ŒBeanæ—¶ä½¿ç”¨</li>
<li>ConfigurationClassBeanDefinitionï¼šè¢«<code>@Bean</code>æ³¨è§£çš„Beanä¼šè¢«æ³¨å†Œä¸ºConfigurationClassBeanDefinitionï¼Œè¿™é‡Œæ³¨æ„å’Œ<br>
ScannedGenericBeanDefinitionçš„åŒºåˆ«ã€‚è¢«<code>@Configuration</code>æ³¨è§£çš„Beanä¼šè¢«æ³¨å†Œä¸ºScannedGenericBeanDefinition</li>
</ol>
<p><img src="/posts/60fee82c/BeanDefinitionRoot.svg" alt="BeanDefinitionRoot"></p>
<h2 id="BeanDefinftionçˆ¶æ¥å£">BeanDefinftionçˆ¶æ¥å£</h2>
<p>BeanDefinitionçš„çˆ¶æ¥å£æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯BeanMetadataElementå’ŒAttributeAccessor</p>
<h3 id="BeanMetadataElement">BeanMetadataElement</h3>
<p>BeanMetadataElementæ¥å£å¾ˆç®€å•åªæœ‰ä¸€ä¸ªgetSourceæ–¹æ³•ï¼Œè¿™é‡Œçš„é—®é¢˜å°±æ˜¯sourceç©¶ç«Ÿæ˜¯å•¥ï¼Œç±»å‹è¿˜æ˜¯ä¸€ä¸ªObejct</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;**
 * Interface to be implemented by bean metadata elements
 * that carry a configuration source object.
 *
 * @author Juergen Hoeller
 * @since 2.0
 *&#x2F;
public interface BeanMetadataElement &#123;
    
    @Nullable
    default Object getSource() &#123;
        return null;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨java docé‡Œé¢å·²ç»å†™äº†ï¼Œè¿™ä¸ªsourceçš„å«ä¹‰æ˜¯<code>configuration source</code>ï¼Œè¿™ä¸ªå’Œbeançš„è§£ææ–¹å¼æœ‰å…³ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€æ®µä»£ç ä½“éªŒä¸‹</p>
<p>è¿™é‡Œå®šä¹‰äº†ä¸‰ä¸ªBean</p>
<ol>
<li>ScanBeanï¼Œç±»ä¸Šæ·»åŠ äº†@Componentï¼Œä¸€ä¼šå„¿ä¼šè¢«æ‰«æå‡ºæ¥</li>
<li>GenericBeanï¼Œåœ¨xmlä¸­åŠ è½½</li>
<li>ConfigurationBeanï¼Œåœ¨@Configurationä¸­åŠ è½½</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">@Component
public class ScanBean &#123;
&#125;

public class GenericBean &#123;
&#125;

public class ConfigurationBean &#123;
&#125;

@Configuration
public class Config &#123;

    @Bean
    public ConfigurationBean configurationBean()&#123;
        return new ConfigurationBean();
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ‰äº†ä¸Šé¢çš„è®¾è®¡åï¼Œæˆ‘ä»¬å°±å¯ä»¥å†™å‡ºå¯¹åº”çš„xml</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
	   http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>genericBean<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.polaris.he.spring.bean.GenericBean<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.polaris.he.spring.bean<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<code>ClassPathXmlApplicationContext</code>æ¥åŠ è½½è¿™å‡ ä¸ªbeanï¼Œå¹¶æ‰“å°å¯¹åº”çš„source</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public class ClassPathApplication &#123;

    public static void main(String[] args) &#123;
        ClassPathXmlApplicationContext ctx &#x3D; new ClassPathXmlApplicationContext(&quot;classpath:application.xml&quot;);
        printSource(ctx, &quot;genericBean&quot;);
        printSource(ctx, &quot;scanBean&quot;);
        printSource(ctx, &quot;configurationBean&quot;);
    &#125;

    private static void printSource(AbstractApplicationContext ctx, String beanName) &#123;
        Object source &#x3D; ctx.getBeanFactory().getBeanDefinition(beanName).getSource();
        String sourceClazzName &#x3D; Optional.ofNullable(source).map(Object::getClass).map(Class::getName).orElse(null);
        System.out.printf(&quot;%s [%s] %s%n&quot;, beanName, sourceClazzName, source);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºä¸åŒæ–¹å¼åŠ è½½çš„beanï¼Œå¯¹åº”çš„sourceéƒ½ä¸åŒï¼Œè¿™ä¸ªsourceä¿ç•™äº†åŠ è½½beanæ—¶çš„åŸå§‹ä¿¡æ¯</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">genericBean [null] null
scanBean [org.springframework.core.io.FileSystemResource] file [C:\Users\xxxx\IdeaProjects\Spring\target\classes\com\polaris\he\spring\bean\ScanBean.class]
configurationBean [org.springframework.core.type.classreading.SimpleMethodMetadata] com.polaris.he.spring.bean.Config.configurationBean()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>xmlæ˜¯ç”±<code>XmlBeanDefinitionReader</code>è§£æï¼Œsourceè§£æå™¨ä¸º<code>NullSourceExtractor</code>ï¼Œè¿”å›ä¸ºå›ºå®šå€¼null</li>
<li>component-scanæ˜¯ç”±<code>ClassPathScanningCandidateComponentProvider</code>è§£æï¼Œsourceä¸º<code>basePackage</code>è·¯å¾„ä¸‹æ‰«æå‡ºæ¥çš„class resource</li>
<li>@Configurationæ˜¯ç”±<code>ConfigurationClassBeanDefinitionReader</code>è§£æï¼Œsourceè§£æå™¨ä¸º<code>PassThroughSourceExtractor</code>ï¼Œæ˜¯å°†@Configurationä¸­æ‰«æå‡ºçš„<code>MethodMetadata</code>ä¿å­˜ä¸ºäº†source</li>
</ul>
<h3 id="AttributeAccessor">AttributeAccessor</h3>
<p>AttributeAccessorè®¾ç½®è·å–å±æ€§çš„ä¸€ç³»åˆ—æ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public interface AttributeAccessor &#123;

    void setAttribute(String name, @Nullable Object value);

    @Nullable
    Object getAttribute(String name);

    
    @SuppressWarnings(&quot;unchecked&quot;)
    default &lt;T&gt; T computeAttribute(String name, Function&lt;String, T&gt; computeFunction) &#123;
        Assert.notNull(name, &quot;Name must not be null&quot;);
        Assert.notNull(computeFunction, &quot;Compute function must not be null&quot;);
        Object value &#x3D; getAttribute(name);
        if (value &#x3D;&#x3D; null) &#123;
            value &#x3D; computeFunction.apply(name);
            Assert.state(value !&#x3D; null,
                    () -&gt; String.format(&quot;Compute function must not return null for attribute named &#39;%s&#39;&quot;, name));
            setAttribute(name, value);
        &#125;
        return (T) value;
    &#125;

    @Nullable
    Object removeAttribute(String name);

    boolean hasAttribute(String name);

    String[] attributeNames();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å…¶å®çœ‹åˆ°è¿™é‡Œï¼Œç»å¸¸å†™ä¸šåŠ¡ä»£ç çš„å¤§ä½¬ä»¬åº”è¯¥éƒ½ç¬‘äº†ï¼Œè¿™ä¸å°±æ˜¯ä¸šåŠ¡ä»£ç ä¸­ä¸ºäº†æ‰©å±•æ€§è€Œç»å¸¸å‡ºç°çš„<code>Map&lt;String,Obejct&gt; ext</code>å—ï¼Ÿ<br>
æˆ‘ä»¬ç»†ç©¶ä¸‹Springä¸­çš„å®ç°ç±»<code>AttributeAccessorSupport</code>ï¼Œä¹Ÿæ˜¯ä½¿ç”¨äº†LinkedHashMapæ¥å­˜å‚¨é¢å¤–çš„å±æ€§å€¼</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public abstract class AttributeAccessorSupport implements AttributeAccessor, Serializable &#123;

    &#x2F;** Map with String keys and Object values. *&#x2F;
    private final Map&lt;String, Object&gt; attributes &#x3D; new LinkedHashMap&lt;&gt;();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="BeanDefintionæ ¸å¿ƒå®ç°ç±»">BeanDefintionæ ¸å¿ƒå®ç°ç±»</h2>
<h3 id="AbstractBeanDefinition">AbstractBeanDefinition</h3>
<h3 id="GenericBeanDefinition-v2">GenericBeanDefinition</h3>
<h3 id="RootBeanDefinition-v2">RootBeanDefinition</h3>
<h2 id="BeanFactoryå¯¹BeanDefinitionå¤„ç†">BeanFactoryå¯¹BeanDefinitionå¤„ç†</h2>
<p>BeanFactoryä½“ç³»ä¸­ï¼ŒBeanFactoryå„è‡ªæä¾›äº†ä¸åŒçš„æ–¹æ³•ç®¡ç†BeanDefinition</p>
<h3 id="ListableBeanFactory">ListableBeanFactory</h3>
<p>ListableBeanFactoryä¸­ï¼Œå¯ä»¥è·å–ä¸€å…±æœ‰å¤šå°‘/æœ‰å“ªäº›BeanDefinitionï¼Œå¯ä»¥æŸ¥é˜…BeanDefinintionæ˜¯å¦åœ¨BeanFactoryä¸­</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public interface ListableBeanFactory extends BeanFactory &#123;

    &#x2F;**
     * æ˜¯å¦åŒ…å«ç»™å®šåå­—çš„BeanDefinition
     *&#x2F;
    boolean containsBeanDefinition(String beanName);

    &#x2F;**
     * BeanDefinitionæ•°é‡
     *&#x2F;
    int getBeanDefinitionCount();

    &#x2F;**
     * BeanDefinitionåç§°æšä¸¾ï¼Œå¦‚æœæœ‰çˆ¶å·¥å‚ï¼Œä¸åŒ…å«çˆ¶å·¥å‚çš„BeanDefinitionï¼Œä¸åŒ…å«æ‰‹å·¥æ³¨å…¥Bean
     *&#x2F;
    String[] getBeanDefinitionNames();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ConfigurableListableBeanFactory">ConfigurableListableBeanFactory</h3>
<p>ConfigurableListableBeanFactoryä¸­è·å–</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public interface ConfigurableListableBeanFactory
            extends ListableBeanFactory, AutowireCapableBeanFactory, ConfigurableBeanFactory &#123;

    &#x2F;**
     * è·å–BeanDefinition
     *&#x2F;
    BeanDefinition getBeanDefinition(String beanName) throws NoSuchBeanDefinitionException;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ConfigurableBeanFactory">ConfigurableBeanFactory</h3>
<p>ConfigurableBeanFactoryä¸­å¯ä»¥è·å–åˆå¹¶åçš„BeanDefintionï¼ŒSpringæœ€ç»ˆåˆ›å»ºBeanæ—¶éƒ½æ˜¯ä½¿ç”¨çš„MergedBeanDefinition</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public interface ConfigurableBeanFactory extends HierarchicalBeanFactory, SingletonBeanRegistry &#123;

    &#x2F;**
     * è·å–åˆå¹¶åçš„BeanDefinition
     *&#x2F;
    BeanDefinition getMergedBeanDefinition(String beanName) throws NoSuchBeanDefinitionException;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="BeanDefinitionRegistry">BeanDefinitionRegistry</h3>
<p>BeanFactoryä¸­å¯¹äºBeanDefitionéƒ½æ˜¯è¯»æ“ä½œï¼Œå¯¹BeanDefitionå®Œæ•´çš„ç®¡ç†ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰éƒ½æ”¶å£åˆ°äº†æ¥å£<code>BeanDefinitionRegistry</code>ä¸­ï¼ŒåŒæ—¶å¯¹åˆ«åè¿›è¡Œäº†ç®¡ç†</p>
<blockquote>
<p>BeanFactoryä¸­ï¼ŒDefaultListableBeanFactoryå®ç°äº†è¯¥æ¥å£</p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public interface BeanDefinitionRegistry extends AliasRegistry &#123;

    &#x2F;**
     * æ³¨å†ŒBeanBeanDefinition
     *&#x2F;
    void registerBeanDefinition(String beanName, BeanDefinition beanDefinition)
            throws BeanDefinitionStoreException;

    &#x2F;**
     * åˆ é™¤BeanBeanDefinition
     *&#x2F;
    void removeBeanDefinition(String beanName) throws NoSuchBeanDefinitionException;

    &#x2F;**
     * è·å–BeanDefinition
     *&#x2F;
    BeanDefinition getBeanDefinition(String beanName) throws NoSuchBeanDefinitionException;

    &#x2F;**
     * æ˜¯å¦åŒ…å«ç»™å®šåå­—çš„BeanDefinition
     *&#x2F;
    boolean containsBeanDefinition(String beanName);

    &#x2F;**
     * è·å–BeanDefinitionåå­—æšä¸¾
     *&#x2F;
    String[] getBeanDefinitionNames();

    &#x2F;**
     * BeanDefinitionæ•°é‡
     *&#x2F;
    int getBeanDefinitionCount();

    &#x2F;**
     * BeanNameæ˜¯å¦è¢«å ç”¨
     *&#x2F;
    boolean isBeanNameInUse(String beanName);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç»†å¿ƒçš„æœ‹å‹å¯èƒ½å·²ç»å‘ç°äº†ï¼Œ<code>BeanDefinitionRegistry</code>ä¸­ä¹±å…¥äº†ä¸€ä¸ªæ–¹æ³•<code>isBeanNameInUse</code></p>
<ul>
<li>BeanDefinitionRegistryç®¡ç†BeanDefinitionï¼Œåœ¨è¿™å †æ–¹æ³•ä¸­çªç„¶å‡ºç°äº†ä¸€ä¸ªé’ˆå¯¹Beançš„æ–¹æ³•</li>
<li>Springå¤§éƒ¨åˆ†Beanéƒ½æ˜¯é€šè¿‡BeanDefinition</li>
<li>Springä¹Ÿå¯ä»¥é€šè¿‡<code>registerSingleton</code>æ‰‹åŠ¨æ³¨å…¥Beanï¼Œæ‰‹åŠ¨æ³¨å…¥çš„Beanæ²¡æœ‰BeanDefinition</li>
<li>ä»ä»£ç å±‚é¢çœ‹
<ul>
<li>BeanDefinitionRegistryå¤§éƒ¨åˆ†æ–¹æ³•éƒ½æ˜¯åœ¨å’Œ<code>beanDefinitionMap</code>æ‰“äº¤é“</li>
<li>isBeanNameInUseå®Œå…¨å’Œ<code>beanDefinitionMap</code>æ— å…³</li>
</ul>
</li>
</ul>
<p>è¿™é‡Œæä¾›äº†ä»£ç ä¸€æ¢ç©¶ç«Ÿ</p>
<ul>
<li>application.xmlé€šè¿‡å®šä¹‰æˆ–æ‰«æçš„æ–¹å¼åŠ è½½Bean</li>
<li>AbstractApplicationContextåœ¨refreshæ—¶ï¼Œä¼šé€šè¿‡<code>registerSingleton</code>æ‰‹åŠ¨æ³¨å…¥InfrastructureBean</li>
<li>åœ¨refrshåï¼Œé€šè¿‡getBeanDefinitionNamesï¼ŒgetBeanNamesIteratoræ‰“å°BeanDefinitionName</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public class PrintBeanName &#123;

    public static void main(String[] args) &#123;
        ClassPathXmlApplicationContext ctx &#x3D; new ClassPathXmlApplicationContext(&quot;classpath:application.xml&quot;);

        String[] beanName &#x3D; ctx.getBeanFactory().getBeanDefinitionNames();
        String beanNameStr &#x3D; Arrays.stream(beanName)
                .filter(l -&gt; !l.startsWith(&quot;org.springframework&quot;))
                .collect(Collectors.joining(&quot;,&quot;));
        System.out.println(beanNameStr);

        Iterator&lt;String&gt; beanNameIterator &#x3D; ctx.getBeanFactory().getBeanNamesIterator();
        String beanNameIteratorStr &#x3D; StreamSupport.stream(Spliterators.spliteratorUnknownSize(beanNameIterator, Spliterator.ORDERED), false).
                filter(l -&gt; !l.startsWith(&quot;org.springframework&quot;))
                .collect(Collectors.joining(&quot;,&quot;));
        System.out.println(beanNameIteratorStr);
        System.out.println(&quot;containsBeanDefinition environment: &quot; + ctx.getBeanFactory().containsBeanDefinition(&quot;environment&quot;));
        System.out.println(&quot;isBeanNameInUse environment: &quot; + ((BeanDefinitionRegistry) ctx.getBeanFactory()).isBeanNameInUse(&quot;environment&quot;));
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»ç»“æœä¸­å¯ä»¥çœ‹åˆ°</p>
<ul>
<li>getBeanDefinitionNamesåªèƒ½è·å–æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„Bean</li>
<li>æ‰‹åŠ¨æ³¨å…¥çš„Bean<code>æ²¡æœ‰</code>BeanDefinition</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">getBeanDefinitionNames: genericBean,config,scanBean,configurationBean
getBeanNamesIterator: genericBean,config,scanBean,configurationBean,environment,systemProperties,systemEnvironment,applicationStartup,messageSource,applicationEventMulticaster,lifecycleProcessor
containsBeanDefinition environment: false
isBeanNameInUse environment: true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="BeanDefinitionåˆå¹¶">BeanDefinitionåˆå¹¶</h2>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring IOC</tag>
      </tags>
  </entry>
  <entry>
    <title>MockMvcå¯¹form/multipartæ”¯æŒçš„é—®é¢˜</title>
    <url>/posts/ddf27974.html</url>
    <content><![CDATA[<blockquote>
<p>æœ¬æ–‡åˆ†æä½¿ç”¨Spring Boot 2.4.1ï¼Œå¯¹åº”Spring Framework 5.3.1</p>
</blockquote>
<p>å¥½å§ï¼Œæˆ‘å†™è¿™ç¯‡æ–‡ç« æ—¶ï¼Œé—®é¢˜å·²ç»è¢«Springå®˜æ–¹ä¿®å¤äº†ã€‚åœ¨<code>5.3.2</code>è¿›è¡Œreleaseã€‚<br>
è¿™æ˜¯æˆ‘å½“æ—¶ç»™githubæçš„issueï¼š<a href="https://github.com/spring-projects/spring-framework/issues/26097">MockHttpServletRequest getParameter(String name) can not get string value parts</a>ï¼Œç”±äºæˆ‘æ‰æ€¥è‹±æ–‡æ°´å¹³å’Œæ²Ÿé€šæ–¹å¼ï¼Œå®˜æ–¹åœ¨å›å¤æˆ‘è®¤ä¸ºä¸æ˜¯ä¸€ä¸ªé—®é¢˜åæˆ‘å°±æ²¡ç†ç¬äº†ã€‚ä»Šå¤©æ‰å‘ç°å·²ç»è§£å†³ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™ä¸ªé—®é¢˜æ€ä¹ˆäº§ç”Ÿçš„ï¼Œå’Œå¯¹åº”çš„<code>Servlet3.0</code>åè®®æ˜¯æ€ä¹ˆæè¿°è¿™éƒ¨åˆ†çš„ã€‚</p>
<blockquote>
<p>MockMvc ignores MultipartFile registrations when both files and parts are registered <a href="https://github.com/spring-projects/spring-framework/issues/26166">#26166</a></p>
</blockquote>
<span id="more"></span>
<h2 id="åœºæ™¯">åœºæ™¯</h2>
<p>Springæ–‡ä»¶ä¸Šä¼ æ˜¯ä¸ªå¾ˆå¸¸è§çš„åœºæ™¯ï¼Œä½¿ç”¨Httpçš„<code>multipart/form-data</code>å¯ä»¥ä¸Šä¼ æ–‡ä»¶ï¼Œmultipart/form-dataåœ¨<a href="https://tools.ietf.org/html/rfc2388">rfc2388</a>ä¸­å®šä¹‰ã€‚multipart/form-dataä¸€æ¬¡å¯ä»¥æäº¤å¤šä¸ª<strong>Parts</strong>ï¼Œæ¯ä¸ª Part å¯ä»¥æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè¡¨å•æ•°æ®ã€‚<br>
å¤æ‚æ–‡ä»¶ä¸Šä¼ åœºæ™¯ï¼Œå¯èƒ½æäº¤è¿‡æ¥çš„ä¸æ­¢ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿˜å¯èƒ½åŒ…å«å…¶ä»–æè¿°å­—æ®µã€‚ç°åœ¨æ„é€ äº†ä¸€ä¸ªä½¿ç”¨åœºæ™¯ï¼Œformæäº¤äº†ä¸€ä¸ªæ–‡ä»¶å’Œè¿™ä¸ªæ–‡ä»¶å¯¹åº”çš„codeã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">@Getter
@Setter
@ToString
public class UploadEntity &#123;
    private String code;
    private MultipartFile file;
&#125;
@PostMapping(&quot;&#x2F;upload&quot;)
public String upload(UploadEntity file)&#123;
 return file.toString();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ®µä»£ç ä½¿ç”¨postmanæ¥æäº¤æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ã€‚<br>
<img src="/posts/ddf27974/1.jpg" alt="ç¤ºä¾‹"><br>
ä½†æˆ‘ä»¬ä½¿ç”¨MockMvcæ¥å†™test caseå‘¢ï¼Ÿ</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"> @Test
public void test() throws Exception &#123;
    mockMvc.perform(
            MockMvcRequestBuilders.multipart(&quot;&#x2F;upload&quot;)
                    .file(new MockMultipartFile(&quot;file&quot;, &quot;1.txt&quot;, null, &quot;123&quot;.getBytes(StandardCharsets.UTF_8)))
                    .part(new MockPart(&quot;code&quot;, &quot;123&quot;.getBytes(StandardCharsets.UTF_8)))
    ).andDo(MockMvcResultHandlers.print());
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»responseä¸Šçœ‹ï¼Œ<strong>code=null</strong>ï¼Œè¿™è¯´æ˜mockMvcå¯¹Partçš„è§£æå‡ºäº†é—®é¢˜ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">MockHttpServletResponse:
           Status &#x3D; 200
    Error message &#x3D; null
          Headers &#x3D; [Content-Type:&quot;text&#x2F;plain;charset&#x3D;UTF-8&quot;, Content-Length:&quot;138&quot;]
     Content type &#x3D; text&#x2F;plain;charset&#x3D;UTF-8
             Body &#x3D; UploadEntity(code&#x3D;null, file&#x3D;org.springframework.web.multipart.support.StandardMultipartHttpServletRequest$StandardMultipartFile@46866946)
    Forwarded URL &#x3D; null
   Redirected URL &#x3D; null
          Cookies &#x3D; []<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="åˆ†æ">åˆ†æ</h2>
<p>ç°åœ¨è¿›å…¥ä»£ç è·Ÿè¸ªç¯èŠ‚ğŸ˜„<br>
ä»ä¸Šé¢æ—¥å¿—å¯ä»¥çœ‹å‡ºï¼ŒMultipartfileæ˜¯<code>StandardMultipartFile</code>è¿™ä¸ªç±»å¤„ç†çš„ï¼ŒæŸ¥æ‰¾è¿™ä¸ªç±»çš„å¼•ç”¨ï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªæ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•çš„å¤§è‡´æ„æ€æ˜¯ï¼ŒHttpæäº¤çš„partè¢«åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†äº†ï¼š<code>æœ‰filename</code>ã€<code>æ²¡æœ‰filename</code>ã€‚æœ‰filenameè§†ä¸ºæäº¤æ–‡ä»¶ï¼Œæ²¡æœ‰filenameè§†ä¸º<code>RequestParam</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">private void parseRequest(HttpServletRequest request) &#123;
    try &#123;
        Collection&lt;Part&gt; parts &#x3D; request.getParts();
        this.multipartParameterNames &#x3D; new LinkedHashSet&lt;&gt;(parts.size());
        MultiValueMap&lt;String, MultipartFile&gt; files &#x3D; new LinkedMultiValueMap&lt;&gt;(parts.size());
        for (Part part : parts) &#123;
            String headerValue &#x3D; part.getHeader(HttpHeaders.CONTENT_DISPOSITION);
            ContentDisposition disposition &#x3D; ContentDisposition.parse(headerValue);
            String filename &#x3D; disposition.getFilename();
            if (filename !&#x3D; null) &#123;
                if (filename.startsWith(&quot;&#x3D;?&quot;) &amp;&amp; filename.endsWith(&quot;?&#x3D;&quot;)) &#123;
                    filename &#x3D; MimeDelegate.decode(filename);
                &#125;
                files.add(part.getName(), new StandardMultipartFile(part, filename));
            &#125;
            else &#123;
                this.multipartParameterNames.add(part.getName());
            &#125;
        &#125;
        setMultipartFiles(files);
    &#125;
    catch (Throwable ex) &#123;
        handleParseFailure(ex);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œéœ€è¦æ˜ç¡®ä¸€ä¸ªæ¦‚å¿µï¼ŒPartsæ˜¯Httpå®šä¹‰çš„æ ‡å‡†ï¼Œä½†ç›´åˆ°<code>Servlet3.0</code>æ‰èƒ½ç›´æ¥å¤„ç†Partsã€‚è¿™ç‚¹åœ¨HttpServletRequestä¸­å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼Œ<code>getParts</code>æ˜¯Servlet 3.0æ‰æä¾›çš„æ–¹æ³•ï¼Œè¿™ä¹Ÿè¯´æ˜äº†ä¸ºä»€ä¹ˆåœ¨Servlet2.5æ—¶ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨<code>CommonsMultipartResolver</code>è¿™ä¸ªç±»æ¥å¤„ç†æ–‡ä»¶ä¸Šä¼ ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;**
 * Return a collection of all uploaded Parts.
 *
 * @return A collection of all uploaded Parts.
 * @throws IOException
 *             if an I&#x2F;O error occurs
 * @throws IllegalStateException
 *             if size limits are exceeded or no multipart configuration is
 *             provided
 * @throws ServletException
 *             if the request is not multipart&#x2F;form-data
 * @since Servlet 3.0
 *&#x2F;
public Collection&lt;Part&gt; getParts() throws IOException,
        ServletException;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åŒæ—¶Servlet3.0å¯¹Partsçš„å¤„ç†æœ‰é¢å¤–çš„è¦æ±‚ï¼Œ<code>getParts</code>é‡Œé¢çš„stringç±»å‹ï¼ˆæ²¡æœ‰filenameï¼‰çš„æ•°æ®ï¼Œéœ€è¦èƒ½ä½¿ç”¨<code>getParameter</code>è·å–åˆ°ã€‚<br>
<a href="https://download.oracle.com/otn-pub/jcp/servlet-3.0-fr-eval-oth-JSpec/servlet-3_0-final-spec.pdf">Javaâ„¢ Servlet Specification Version 3.0</a></p>
<blockquote>
<p>For parts with form-data as the Content-Disposition, but without a filename,<br>
the string value of the part will also be available via the getParameter /<br>
getParameterValues methods on HttpServletRequest, using the name of the part.</p>
</blockquote>
<p>ç°åœ¨æ¥ç€çœ‹<code>StandardMultipartHttpServletRequest</code>ï¼Œå·²ç»é‡å†™çš„<code>getParameterNames</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å·²ç»èƒ½è·å–åˆ°äº†Partsä¸­çš„å¯¹åº”å˜é‡ã€‚ä½†é—®é¢˜å°±åœ¨äºMockMvcå¹¶æ²¡æœ‰å°†Partsä¸­éæ–‡ä»¶çš„éƒ¨åˆ†æ³¨å†Œåˆ°parameterä¸­ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">@Override
public Enumeration&lt;String&gt; getParameterNames() &#123;
 if (this.multipartParameterNames &#x3D;&#x3D; null) &#123;
  initializeMultipart();
 &#125;
 if (this.multipartParameterNames.isEmpty()) &#123;
  return super.getParameterNames();
 &#125;
  
 &#x2F;&#x2F; Servlet 3.0 getParameterNames() not guaranteed to include multipart form items
 &#x2F;&#x2F; (e.g. on WebLogic 12) -&gt; need to merge them here to be on the safe side
 Set&lt;String&gt; paramNames &#x3D; new LinkedHashSet&lt;&gt;();
 Enumeration&lt;String&gt; paramEnum &#x3D; super.getParameterNames();
 while (paramEnum.hasMoreElements()) &#123;
  paramNames.add(paramEnum.nextElement());
 &#125;
 paramNames.addAll(this.multipartParameterNames);
 return Collections.enumeration(paramNames);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ä¿®å¤æ–¹æ³•">ä¿®å¤æ–¹æ³•</h2>
<p>å…¶å®ä¿®å¤æ–¹æ³•å¾ˆç®€å•ï¼Œå°†Partsä¸­éæ–‡ä»¶éƒ¨åˆ†æ³¨å†Œåˆ°parameterä¸­å°±å¯ä»¥äº†ã€‚å¦‚æœä½ ä¸æ–¹ä¾¿å‡çº§Springç‰ˆæœ¬ï¼ŒSpringä¹Ÿæœ‰ä¸€ä¸ªæ‰©å±•æ¥å£<code>RequestPostProcessor</code>æ¥å¹²è¿™äº‹ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">protected final MockHttpServletRequest createServletRequest(ServletContext servletContext) &#123;
    MockMultipartHttpServletRequest request &#x3D; new MockMultipartHttpServletRequest(servletContext);
    this.files.forEach(request::addFile);
    this.parts.values().stream().flatMap(Collection::stream).forEach((part) -&gt; &#123;
        request.addPart(part);
        try &#123;
            MultipartFile file &#x3D; this.asMultipartFile(part);
            if (file !&#x3D; null) &#123;
                request.addFile(file);
            &#125; else &#123;
                String value &#x3D; this.toParameterValue(part);
                if (value !&#x3D; null) &#123;
                    request.addParameter(part.getName(), this.toParameterValue(part));
                &#125;
            &#125;
        &#125; catch (IOException var5) &#123;
            throw new IllegalStateException(&quot;Failed to read content for part &quot; + part.getName(), var5);
        &#125;
    &#125;);
    return request;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Tomcatå¯¹Partsçš„å¤„ç†">Tomcatå¯¹Partsçš„å¤„ç†</h2>
<p>ä¸Šé¢è¯´äº†è¿™ä¹ˆå¤šï¼Œå…¶å®å°±æ˜¯å¯¹åè®®çš„å¤„ç†è¿‡ç¨‹ï¼Œæ ¸å¿ƒæ˜¯ï¼šå¯¹Partsä¸­çš„éæ–‡ä»¶éƒ¨åˆ†ï¼Œéœ€è¦æ·»åŠ åˆ°parameterä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹Tomcatæ˜¯æ€ä¹ˆå¤„ç†è¿™éƒ¨åˆ†çš„ã€‚<br>
ä»£ç æ¯”è¾ƒé•¿ï¼Œå–äº†æ ¸å¿ƒéƒ¨åˆ†ã€‚ä»£ç åœ¨org.apache.catalina.connector.Request#parsePartsã€‚è¿™ä¸ªæ ‡å‡†çš„å®ç°æ˜¯åœ¨2010å¹´<a href="https://github.com/apache/tomcat/commit/17e1a5ae5d8232ed6a838211813f2592d91392bf#diff-9c26b293a31c898f3153e5575a98f8f9b767f55d31b4e3f5d9dd8e047004d3b0https://github.com/apache/tomcat/commit/17e1a5ae5d8232ed6a838211813f2592d91392bf#diff-9c26b293a31c898f3153e5575a98f8f9b767f55d31b4e3f5d9dd8e047004d3b0">Implement SRV.3.2. Non file parts should be exposed via getParameters()</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">for (FileItem item : items) &#123;
    ApplicationPart part &#x3D; new ApplicationPart(item, location);
    parts.add(part);
    if (part.getSubmittedFileName() &#x3D;&#x3D; null) &#123;
        String name &#x3D; part.getName();
        String value &#x3D; null;
        try &#123;
            value &#x3D; part.getString(charset.name());
        &#125; catch (UnsupportedEncodingException uee) &#123;
            &#x2F;&#x2F; Not possible
        &#125;
        if (maxPostSize &gt;&#x3D; 0) &#123;
            &#x2F;&#x2F; Have to calculate equivalent size. Not completely
            &#x2F;&#x2F; accurate but close enough.
            postSize +&#x3D; name.getBytes(charset).length;
            if (value !&#x3D; null) &#123;
                &#x2F;&#x2F; Equals sign
                postSize++;
                &#x2F;&#x2F; Value length
                postSize +&#x3D; part.getSize();
            &#125;
            &#x2F;&#x2F; Value separator
            postSize++;
            if (postSize &gt; maxPostSize) &#123;
                parameters.setParseFailedReason(FailReason.POST_TOO_LARGE);
                throw new IllegalStateException(sm.getString(
                        &quot;coyoteRequest.maxPostSizeExceeded&quot;));
            &#125;
        &#125;
        parameters.addParameter(name, value);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring Test</tag>
        <tag>Servlet</tag>
        <tag>Bug</tag>
      </tags>
  </entry>
  <entry>
    <title>Prismå’ŒHexoçš„æ•´åˆ</title>
    <url>/posts/be0090e6.html</url>
    <content><![CDATA[<p>Hexoæä¾›äº†<code>highlight</code>å’Œ<code>prism</code>ä¸¤ç§ä»£ç é«˜äº®æ’ä»¶ï¼Œæœ¬åšå®¢åœ¨å¤šæ¬¡å°è¯•å¯¹<code>hightlight</code>è§£æçš„è¯­æ³•æ ‘ä¸å¤ªæ»¡æ„ï¼Œé‡‡ç”¨Prismçš„æ–¹å¼å®ç°äº†ä»£ç é«˜äº®<br>
æœ¬åšå®¢é‡‡ç”¨ä¸»è¦çš„ä¾èµ–å¦‚ä¸‹ã€‚</p>
<blockquote>
<p>Hexo  6.3.0<br>
NexT  8.17.1<br>
hexo-asset-image 1.0.0</p>
</blockquote>
<p>æ³¨æ„<code>hexo-asset-image</code>ï¼Œè¿™ä¸ªå’Œå¼•å…¥jsæ–‡ä»¶æœ‰ä¸€å®šå†²çªï¼Œéœ€è¦åšä¿®æ”¹</p>
<span id="more"></span>
<h2 id="Hexoé…ç½®">Hexoé…ç½®</h2>
<p>ç”±äºå¯¹Hexoè‡ªå¸¦çš„ä»£ç é«˜äº®åŠŸèƒ½ä¸å¤ªæ»¡æ„ï¼Œæœ¬æ–¹æ¡ˆç›´æ¥å°†Hexoè‡ªåŠ¨çš„ä»£ç é«˜äº®åŠŸèƒ½å…¨éƒ¨å…³é—­äº†<br>
åœ¨<code>_config.yml</code>ä¸­ï¼Œå°†<code>hightlight.enable</code>è®¾ç½®ä¸ºfalse</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">highlight:
  enable: false
  line_number: true
  auto_detect: false
  tab_replace: &#39;&#39;
  wrap: true
  hljs: false
prism_plugin:
  mode: &#39;preprocess&#39;
  theme: &#39;&#39;
  line_number: true
prismjs:
  enable: true
  preprocess: true
  line_number: true
  tab_replace: &#39;&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Prismé…ç½®">Prismé…ç½®</h2>
<h3 id="Prismæ–‡ä»¶å‡†å¤‡">Prismæ–‡ä»¶å‡†å¤‡</h3>
<p>åœ¨<a href="https://prismjs.com/download.html#themes=prism&amp;languages=markup+css+clike+javascript">Prism</a>ä¸­é€‰æ‹©è‡ªå·±æƒ³è¦ä»£ç é«˜äº®çš„è¯­è¨€ã€ä¸»é¢˜å’Œæ’ä»¶<br>
æœ¬åšå®¢çš„é€‰æ‹©äº†ä¸‹åˆ—<a href="https://prismjs.com/download.html#themes=prism-solarizedlight&amp;languages=markup+css+clike+javascript+c+cpp+css-extras+diff+go+java+json+json5+regex+sql+xml-doc+yaml&amp;plugins=line-numbers+toolbar+diff-highlight">è¯­è¨€ã€æ ·å¼å’Œæ’ä»¶</a></p>
<ul>
<li>è¯­éŸ³
<ul>
<li>markup-css</li>
<li>clike</li>
<li>javascript</li>
<li>c</li>
<li>cpp</li>
<li>css-extras</li>
<li>diff</li>
<li>go</li>
<li>java</li>
<li>json</li>
<li>json5</li>
<li>regex</li>
<li>sql</li>
<li>xml-doc</li>
<li>yaml</li>
</ul>
</li>
<li>ä¸»é¢˜
<ul>
<li>prism-solarizedlight</li>
</ul>
</li>
<li>æ’ä»¶
<ul>
<li>line-numbers</li>
<li>toolbar</li>
<li>diff-highlight</li>
</ul>
</li>
</ul>
<p>åœ¨é€‰æ‹©å¥½æ»¡æ„çš„è¯­è¨€ã€ä¸»é¢˜å’Œæ’ä»¶åï¼Œæ‹‰å€’æœ€ä¸‹æ–¹ï¼Œå°†jså’Œcssä¸‹è½½ä¸‹æ¥ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ä¸‰æ–¹ä¾èµ–</p>
<p><img src="/posts/be0090e6/prismjs.jpg" alt="prismjs"></p>
<p>å°†ä¸‹è½½åçš„prism.jsæ”¾åˆ°<code>source/js/prism/</code>ä¸‹,prism.cssæ”¾åˆ°<code>csss/js/prism/</code>ä¸‹<br>
<img src="/posts/be0090e6/download.jpg" alt="download"></p>
<h3 id="NexTä¿®æ”¹">NexTä¿®æ”¹</h3>
<p>æˆ‘ä»¬å®šåˆ¶å¥½æˆ‘ä»¬çš„prismåº“åï¼Œéœ€è¦å°†å®šåˆ¶çš„åº“å¼•å…¥NexT</p>
<h4 id="å¼•å…¥js">å¼•å…¥js</h4>
<p>åœ¨<code>themes/next/layout/_scripts/index.njk</code>ä¸­æ·»åŠ js</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">&#123;&#123;- next_js('prism/prism.js') &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="æ˜ å…¥css">æ˜ å…¥css</h4>
<p>åœ¨<code>themes/next/layout/_partials/head/index.njk</code>ä¸­æ·»åŠ css</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; url_for(theme.css) &#125;&#125;/main.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; url_for(theme.css) &#125;&#125;/prism/prism.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="hexo-asset-imageä¿®æ”¹">hexo-asset-imageä¿®æ”¹</h3>
<p>é€šè¿‡ä»¥ä¸Šä¸¤æ­¥ä¿®æ”¹åï¼Œå°±å°†prismå’Œhexoæ•´åˆèµ·æ¥äº†ï¼Œä½†å¦‚æœä½ ä½¿ç”¨äº†hexo-asset-imageï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹æŠ¥é”™</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Uncaught SyntaxError<span class="token operator">:</span> Invalid regular expression<span class="token operator">:</span> missing <span class="token operator">/</span> prism<span class="token punctuation">.</span>js<span class="token operator">:</span><span class="token number">3</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¿™æ˜¯ç”±äºhexo-asset-imageå¯¹æˆ‘ä»¬imageé‡å†™æ—¶ï¼Œå¯¹jsæ–‡ä»¶è¿›è¡Œäº†è¯»å–å¹¶å†™å…¥ï¼Œå¯¼è‡´jsæ–‡ä»¶è¢«ç ´å<br>
æˆ‘ä»¬æ‰¾åˆ°<code>node_modules/hexo-asset-image/index.js</code>åœ¨<code>25è¡Œ</code>åæ·»åŠ é€»è¾‘</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> cheerio <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cheerio'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// http://stackoverflow.com/questions/14480345/how-to-get-the-nth-occurrence-in-a-string</span>
<span class="token keyword">function</span> <span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token parameter">str<span class="token punctuation">,</span> m<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

hexo<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>filter<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'after_post_render'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> config <span class="token operator">=</span> hexo<span class="token punctuation">.</span>config<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>post_asset_folder<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> link <span class="token operator">=</span> data<span class="token punctuation">.</span>permalink<span class="token punctuation">;</span>
    <span class="token keyword">var</span> beginPos <span class="token operator">=</span> <span class="token function">getPosition</span><span class="token punctuation">(</span>link<span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> appendLink <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token comment">// In hexo 3.1.1, the permalink of "about" page is like ".../about/index.html".</span>
    <span class="token comment">// if not with index.html endpos = link.lastIndexOf('.') + 1 support hexo-abbrlink</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*\/index\.html$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// when permalink is end with index.html, for example 2019/02/20/xxtitle/index.html</span>
      <span class="token comment">// image in xxtitle/ will go to xxtitle/index/</span>
      appendLink <span class="token operator">=</span> <span class="token string">'index/'</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> endPos <span class="token operator">=</span> link<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">var</span> endPos <span class="token operator">=</span> link<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    link <span class="token operator">=</span> link<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>beginPos<span class="token punctuation">,</span> endPos<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> appendLink<span class="token punctuation">;</span>
    <span class="token comment">// æ·»åŠ ä»¥ä¸‹é€»è¾‘</span>
    <span class="token comment">// å¦‚æœè¯»å–çš„æ˜¯æˆ‘ä»¬jsç›®å½•ä¸‹é¢çš„æ–‡ä»¶ï¼Œè·³è¿‡å¤„ç†</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^js\/.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">var</span> toprocess <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'excerpt'</span><span class="token punctuation">,</span> <span class="token string">'more'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> toprocess<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">var</span> key <span class="token operator">=</span> toprocess<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">var</span> $ <span class="token operator">=</span> cheerio<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">ignoreWhitespace</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token literal-property property">xmlMode</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token literal-property property">lowerCaseTags</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token literal-property property">decodeEntities</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
          <span class="token comment">// For windows style path, we replace '\' to '/'.</span>
          <span class="token keyword">var</span> src <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">http[s]*.*|\/\/.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s+\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*\/uploads|images\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// For "about" page, the first part of "src" can't be removed.</span>
            <span class="token comment">// In addition, to support multi-level local directory.</span>
            <span class="token keyword">var</span> linkArray <span class="token operator">=</span> link<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">elem</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
              <span class="token keyword">return</span> elem <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> srcArray <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">elem</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
              <span class="token keyword">return</span> elem <span class="token operator">!=</span> <span class="token string">''</span> <span class="token operator">&amp;&amp;</span> elem <span class="token operator">!=</span> <span class="token string">'.'</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>srcArray<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span>
            srcArray<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            src <span class="token operator">=</span> srcArray<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>root <span class="token operator">+</span> link <span class="token operator">+</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span>info<span class="token operator">&amp;&amp;</span>console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"update link as:-->"</span><span class="token operator">+</span>config<span class="token punctuation">.</span>root <span class="token operator">+</span> link <span class="token operator">+</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
          console<span class="token punctuation">.</span>info<span class="token operator">&amp;&amp;</span>console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"no src attr, skipped..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          console<span class="token punctuation">.</span>info<span class="token operator">&amp;&amp;</span>console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// $.html()ä¼šä¸¢å¤± > ç­‰ç¬¦å·</span>
      data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="é™„">é™„</h2>
<h3 id="è‡ªå®šä¹‰cssæ ·å¼">è‡ªå®šä¹‰cssæ ·å¼</h3>
<p>ç¬”è€…æ¯”è¾ƒå–œæ¬¢vscodeæä¾›markdownçš„ä»£ç é«˜äº®é£æ ¼ï¼Œè¿™é‡Œæ˜¯ç¬”è€…è‡ªå®šä¹‰ä»¿ç…§vscodeçš„cssæ ·å¼</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">code[class*="language-"],
pre[class*="language-"]</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #9FDDFD<span class="token punctuation">;</span>
    <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"Source Code Pro"</span><span class="token punctuation">,</span> <span class="token string">"Consolas"</span><span class="token punctuation">,</span> <span class="token string">"Bitstream Vera Sans Mono"</span><span class="token punctuation">,</span> <span class="token string">"Courier New"</span><span class="token punctuation">,</span> Courier<span class="token punctuation">,</span> monospace<span class="token punctuation">;</span>
    <span class="token property">direction</span><span class="token punctuation">:</span> ltr<span class="token punctuation">;</span>
    <span class="token property">text-align</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>
    <span class="token property">white-space</span><span class="token punctuation">:</span> pre<span class="token punctuation">;</span>
    <span class="token property">word-spacing</span><span class="token punctuation">:</span> normal<span class="token punctuation">;</span>
    <span class="token property">word-break</span><span class="token punctuation">:</span> normal<span class="token punctuation">;</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> .75em<span class="token punctuation">;</span>
    <span class="token property">line-height</span><span class="token punctuation">:</span> 1.2em<span class="token punctuation">;</span>

    <span class="token property">-moz-tab-size</span><span class="token punctuation">:</span> 4<span class="token punctuation">;</span>
    <span class="token property">-o-tab-size</span><span class="token punctuation">:</span> 4<span class="token punctuation">;</span>
    <span class="token property">tab-size</span><span class="token punctuation">:</span> 4<span class="token punctuation">;</span>

    <span class="token property">-webkit-hyphens</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
    <span class="token property">-moz-hyphens</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
    <span class="token property">-ms-hyphens</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
    <span class="token property">hyphens</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">pre > code[class*="language-"]</span> <span class="token punctuation">&#123;</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 1em<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection</span> <span class="token punctuation">&#123;</span>
    <span class="token property">background</span><span class="token punctuation">:</span> #C1DEF1<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection</span> <span class="token punctuation">&#123;</span>
    <span class="token property">background</span><span class="token punctuation">:</span> #C1DEF1<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* Code blocks */</span>
<span class="token selector">pre[class*="language-"]</span> <span class="token punctuation">&#123;</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 1em<span class="token punctuation">;</span>
    <span class="token property">margin</span><span class="token punctuation">:</span> .5em 0<span class="token punctuation">;</span>
    <span class="token property">overflow</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
    <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #dddddd<span class="token punctuation">;</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">rgb</span><span class="token punctuation">(</span>21<span class="token punctuation">,</span>21<span class="token punctuation">,</span>21<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* Inline code */</span>
<span class="token selector">:not(pre) > code[class*="language-"]</span> <span class="token punctuation">&#123;</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> .2em<span class="token punctuation">;</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 1px<span class="token punctuation">;</span>
    <span class="token property">padding-bottom</span><span class="token punctuation">:</span> 1px<span class="token punctuation">;</span>
    <span class="token property">background</span><span class="token punctuation">:</span> #f8f8f8<span class="token punctuation">;</span>
    <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #dddddd<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.comment,
.token.prolog,
.token.doctype,
.token.cdata</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #0A9858<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.namespace</span> <span class="token punctuation">&#123;</span>
    <span class="token property">opacity</span><span class="token punctuation">:</span> .7<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.string</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #CD917A<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.punctuation</span> <span class="token punctuation">&#123;</span>
   <span class="token property">color</span><span class="token punctuation">:</span> #C169BD<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.annotation,
.token.operator</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #51C0A9<span class="token punctuation">;</span> <span class="token comment">/* no highlight */</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.url,
.token.symbol,
.token.number,
.token.boolean,
.token.variable,
.token.constant,
.token.inserted</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #9FDDFD<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.atrule,
.token.keyword,
.token.attr-value,
.language-autohotkey .token.selector,
.language-json .token.boolean,
.language-json .token.number,
code[class*="language-css"]</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #599DD4<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.function</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #DADBAB<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.deleted,
.language-autohotkey .token.tag</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #9a050f<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.selector,
.language-autohotkey .token.keyword</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #00009f<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.important</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #e90<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.important,
.token.bold</span> <span class="token punctuation">&#123;</span>
    <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.italic</span> <span class="token punctuation">&#123;</span>
    <span class="token property">font-style</span><span class="token punctuation">:</span> italic<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.class-name,
.language-json .token.property</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #51C0A9<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.tag,
.token.selector</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #800000<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.attr-name,
.token.property,
.token.regex,
.token.entity</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #ff0000<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.token.directive.tag .tag</span> <span class="token punctuation">&#123;</span>
    <span class="token property">background</span><span class="token punctuation">:</span> #ffff00<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #393A34<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* overrides color-values for the Line Numbers plugin
 * http://prismjs.com/plugins/line-numbers/
 */</span>
<span class="token selector">.line-numbers.line-numbers .line-numbers-rows</span> <span class="token punctuation">&#123;</span>
    <span class="token property">border-right-color</span><span class="token punctuation">:</span> #a5a5a5<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">.line-numbers .line-numbers-rows > span:before</span> <span class="token punctuation">&#123;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #2B91AF<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* overrides color-values for the Line Highlight plugin
* http://prismjs.com/plugins/line-highlight/
*/</span>
<span class="token selector">.line-highlight.line-highlight</span> <span class="token punctuation">&#123;</span>
    <span class="token property">background</span><span class="token punctuation">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span>193<span class="token punctuation">,</span> 222<span class="token punctuation">,</span> 241<span class="token punctuation">,</span> 0.2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">background</span><span class="token punctuation">:</span> <span class="token function">-webkit-linear-gradient</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> <span class="token function">rgba</span><span class="token punctuation">(</span>193<span class="token punctuation">,</span> 222<span class="token punctuation">,</span> 241<span class="token punctuation">,</span> 0.2<span class="token punctuation">)</span> 70%<span class="token punctuation">,</span> <span class="token function">rgba</span><span class="token punctuation">(</span>221<span class="token punctuation">,</span> 222<span class="token punctuation">,</span> 241<span class="token punctuation">,</span> 0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">background</span><span class="token punctuation">:</span> <span class="token function">linear-gradient</span><span class="token punctuation">(</span>to right<span class="token punctuation">,</span> <span class="token function">rgba</span><span class="token punctuation">(</span>193<span class="token punctuation">,</span> 222<span class="token punctuation">,</span> 241<span class="token punctuation">,</span> 0.2<span class="token punctuation">)</span> 70%<span class="token punctuation">,</span> <span class="token function">rgba</span><span class="token punctuation">(</span>221<span class="token punctuation">,</span> 222<span class="token punctuation">,</span> 241<span class="token punctuation">,</span> 0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      <tags>
        <tag>NexT</tag>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>RedisDesktopManagerç¼–è¯‘</title>
    <url>/posts/cfa83ab0.html</url>
    <content><![CDATA[<p><strong>æœ€è¿‘é‡è£…äº†ç³»ç»Ÿï¼Œé‡æ–°ç¼–è¯‘äº†ä¸‹2022.5.1ï¼Œç¼–è¯‘è¿‡ç¨‹åŸºæœ¬ä¸€è‡´ï¼Œæœ‰äº›è®¸å·®åˆ«</strong></p>
<blockquote>
<p><a href="https://rdm.dev/">RedisDesktopManager</a>æ˜¯æˆ‘å¹³æ—¶å·¥ä½œä¸­ç‰¹åˆ«å–œæ¬¢çš„Rediså·¥å…·ï¼Œæœ‰ä¸€ä¸ªé—æ†¾å°±æ˜¯ä½œè€…å¼€æ”¾äº†RDMçš„<a href="https://github.com/uglide/RedisDesktopManager">æºä»£ç </a>ï¼Œä½†æ²¡æœ‰æä¾›å¯¹åº”çš„äºŒè¿›åˆ¶åŒ…ã€‚æœ¬æ–‡å°±å¦‚ä½•é€šè¿‡SourceCodeç¼–è¯‘åˆ°Windowsä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶åšä¸€ä¸ªè®°å½•ã€‚<br>
åœ¨æ­¤æ„Ÿè°¢RedisDesktopManagerçš„ä½œè€…<strong>Igor Malinovskiy</strong></p>
</blockquote>
<span id="more"></span>
<h2 id="å‰è¨€">å‰è¨€</h2>
<p><a href="http://docs.redisdesktop.com/en/latest/install/#build-from-source">RDMå·²ç»æä¾›äº†ç¼–è¯‘å®‰è£…æ–¹æ³•</a>,åªæ˜¯æä¾›çš„æ­¥éª¤æ¯”è¾ƒç®€å•ï¼Œä¸­é—´ç•¥è¿‡äº†å¾ˆå¤šæ­¥éª¤ï¼Œæœ¬æ–‡å°†å®Œæ•´çš„ç¼–è¯‘è¿‡ç¨‹è®°å½•ä¸‹æ¥ã€‚</p>
<blockquote>
<p>æœ¬æ¬¡ç¼–è¯‘è¿‡ç¨‹åŸºäºRedisDesktopManagerï¼ˆ2021.10ï¼‰</p>
</blockquote>
<h2 id="ç¯å¢ƒå‡†å¤‡">ç¯å¢ƒå‡†å¤‡</h2>
<h3 id="ç³»ç»Ÿ">ç³»ç»Ÿ</h3>
<blockquote>
<p>Windows 10 21H2<br>
Windows 11 22H2</p>
</blockquote>
<h3 id="git-clone">git clone</h3>
<ol>
<li>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤clone RedisDesktopManagerçš„é¡¹ç›®ä»“åº“
<blockquote>
<p>git clone --recursive <a href="https://github.com/uglide/RedisDesktopManager.git">https://github.com/uglide/RedisDesktopManager.git</a></p>
</blockquote>
</li>
<li>éœ€è¦æ³¨æ„submoduleå¤„ç†
<ul>
<li>RedisDesktopManageråŒ…å«submoduleï¼Œåœ¨3rdpartyä¸‹</li>
<li>submoduleé‡Œé¢ä¹ŸåŒ…å«submoduleï¼Œå¦‚3rdparty/qredisclient/hiredisç­‰</li>
<li>éœ€è¦ä½¿ç”¨--recursiveé€’å½’clone</li>
<li>å¦‚æœæ²¡æœ‰ä½¿ç”¨--recursiveæ¥cloneï¼Œéœ€è¦äººä¸ºä¿è¯submoduleéƒ½downä¸‹æ¥äº†</li>
</ul>
</li>
</ol>
<blockquote>
<p>å®Œå…¨cloneçš„ä»“åº“ä¸€å…±277å…†ï¼ŒåŒ…å«3058ä¸ªæ–‡ä»¶å’Œ610ä¸ªç›®å½•<br>
<img src="/posts/cfa83ab0/2.png" alt="é¡¹ç›®æ¦‚è¿°"></p>
</blockquote>
<h3 id="Microsoft-Visual-Studio-Community-2022-64-ä½">Microsoft Visual Studio Community 2022 (64 ä½)</h3>
<p><a href="https://visualstudio.microsoft.com/zh-hans/">ä¸‹è½½VS2022ç¤¾åŒºç‰ˆåœ¨çº¿å®‰è£…åŒ…</a>ï¼Œé€‰æ‹©ä½¿ç”¨C++åœ¨çº¿å®‰è£…<br>
<img src="/posts/cfa83ab0/1.png" alt="é€‰æ‹©ä½¿ç”¨C++åœ¨çº¿å®‰è£…"></p>
<h3 id="ä¸‹è½½QT5-15">ä¸‹è½½QT5.15</h3>
<p>Qt5.15åªèƒ½åœ¨çº¿å®‰è£…ï¼Œä¸‹è½½<a href="http://iso.mirrors.ustc.edu.cn/qtproject/archive/online_installers/4.2/qt-unified-windows-x86-4.2.0-online.exe">qt-unified-windows-x86-4.2.0-online.exe</a>ã€‚éœ€è¦å®‰è£…Qt5.15å’ŒQt charts</p>
<blockquote>
<p>Qtä¸‹è½½æ—¶é—´å¾ˆé•¿ï¼Œç½‘ä¸å¥½å®¹æ˜“æ–­ï¼Œè¯·ä¿æŒè€å¿ƒ</p>
</blockquote>
<p><img src="/posts/cfa83ab0/3.png" alt="Qtå®‰è£…"></p>
<h3 id="Python-3-9-9">Python 3.9.9</h3>
<p>ä¸‹è½½<a href="https://www.python.org/downloads/release/python-399/">Python3.9.9</a>ï¼Œéœ€è¦æ³¨æ„</p>
<ul>
<li>Pythonè¦å®‰è£…åˆ°<code>æŒ‡å®šç›®å½•</code>ï¼Œä¸ç„¶åé¢éœ€è¦æ‰‹åŠ¨æŒ‡å®šPythonçš„ä½ç½®</li>
</ul>
<p><img src="/posts/cfa83ab0/4.png" alt="Pythonå®‰è£…"><br>
<img src="/posts/cfa83ab0/5.png" alt="Pythonå®‰è£…"><br>
<img src="/posts/cfa83ab0/6.png" alt="Pythonå®‰è£…"></p>
<h3 id="Cmake">Cmake</h3>
<p>ä¸‹è½½<a href="https://github.com/Kitware/CMake/releases/download/v3.22.1/cmake-3.22.1-windows-x86_64.msi">Cmake</a>ï¼Œä¸€è·¯nextå°±è¡Œäº†</p>
<h3 id="nuget">nuget</h3>
<p>ä¸‹è½½<a href="https://dist.nuget.org/win-x86-commandline/latest/nuget.exe">nuget.exe</a>ï¼Œæ”¾åˆ°3rdpartyä¸‹</p>
<h2 id="Pythonä¾èµ–å®‰è£…">Pythonä¾èµ–å®‰è£…</h2>
<p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…Pythonä¾èµ–</p>
<blockquote>
<p>pip3 install -r src/py/requirements.txt</p>
</blockquote>
<p>å¦‚æœå‡ºç°gitä»“åº“SSLæ¡æ‰‹å¤±è´¥ï¼Œå¯ä»¥å°†requirementsä¸­gitçš„httpsåè®®æ¢æˆgitåè®®ã€‚</p>
<ul>
<li>åŸå§‹requirementså†…å®¹
<blockquote>
<p>bitstring<br>
cbor<br>
msgpack<br>
git+<a href="https://github.com/mrnom/phpserialize.git#egg=phpserialize">https://github.com/mrnom/phpserialize.git#egg=phpserialize</a><br>
git+<a href="https://github.com/uglide/redis-rdb-tools#egg=rdbtools">https://github.com/uglide/redis-rdb-tools#egg=rdbtools</a><br>
python-lzf</p>
</blockquote>
</li>
<li>æ›¿æ¢årequirementså†…å®¹
<blockquote>
<p>bitstring<br>
cbor<br>
msgpack<br>
git+git://github.com/mrnom/phpserialize.git#egg=phpserialize<br>
git+git://github.com/uglide/redis-rdb-tools#egg=rdbtools<br>
python-lzf</p>
</blockquote>
</li>
</ul>
<h2 id="ä¸‰æ–¹ä¾èµ–ç¼–è¯‘">ä¸‰æ–¹ä¾èµ–ç¼–è¯‘</h2>
<h3 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</h3>
<h4 id="å®‰è£…zlib">å®‰è£…zlib</h4>
<p>åœ¨<code>3rdparty</code>ç›®å½•ä¸‹ï¼Œä½¿ç”¨<code>nuget</code>å®‰è£…zlib</p>
<blockquote>
<p>nuget install zlib-msvc14-x64 -Version 1.2.11.7795</p>
</blockquote>
<h4 id="hiredisåœ¨Windownsä¸‹ç¼–è¯‘ä¿®æ­£">hiredisåœ¨Windownsä¸‹ç¼–è¯‘ä¿®æ­£</h4>
<p><strong>2022.5.1å·²ç»æ²¡æœ‰è¿™ä¸€æ­¥äº†</strong><br>
<s>åœ¨<code>3rdparty/qredisclient/3rdparty/hiredis</code>ç›®å½•ä¸‹ï¼Œä¸º<code>hirdis</code>æ‰“<code>patch</code></s></p>
<blockquote>
<p><s>git apply â€¦/hiredis-win.patch</s></p>
</blockquote>
<h3 id="lz4ç¼–è¯‘">lz4ç¼–è¯‘</h3>
<p>å®˜æ–¹æ–‡æ¡£ä¸­å·²ç»ç»™å‡ºäº†lz4çš„ç¼–è¯‘æ–¹æ³•ï¼Œåªæ˜¯Windowsæ²¡æœ‰makeå‘½ä»¤ï¼Œéœ€è¦ä½¿ç”¨<code>VS</code>æ¥æ›¿ä»£makeç¼–è¯‘é¡¹ç›®</p>
<blockquote>
<p>cd 3rdparty/lz4/build/cmake<br>
cmake -DLZ4_BUNDLED_MODE=ON  .<br>
make</p>
</blockquote>
<ol>
<li>Cmakeç”Ÿæˆç¼–è¯‘æ–‡ä»¶<br>
<img src="/posts/cfa83ab0/7.png" alt="cmake"></li>
<li>ç”¨VS2022æ‰“å¼€<code>LZ4.sln</code><br>
<img src="/posts/cfa83ab0/8.png" alt="cmake"></li>
<li>ç¼–è¯‘<br>
<img src="/posts/cfa83ab0/9.png" alt="cmake"></li>
</ol>
<h3 id="zstdç¼–è¯‘">zstdç¼–è¯‘</h3>
<p>å®˜æ–¹Windowsç¼–è¯‘æ–‡æ¡£ä¸­æ²¡æœ‰æåŠzstdçš„ç¼–è¯‘ï¼Œä½†åé¢ç¡®å®æ˜¯éœ€è¦çš„ï¼Œä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ç¼–è¯‘zstd</p>
<ol>
<li>æ‰§è¡Œcmakeï¼Œæ‰§è¡Œç›®å½•ä¸º<code>3rdparty\zstd\build\cmake</code>
<blockquote>
<p>cmake ./</p>
</blockquote>
</li>
<li>ä½¿ç”¨<code>4.2</code>åŒæ ·çš„æ–¹æ³•æ‰¾åˆ°<code>zstd.sln</code>ç¼–è¯‘</li>
</ol>
<h3 id="snappyç¼–è¯‘">snappyç¼–è¯‘</h3>
<p>å®˜æ–¹Windowsç¼–è¯‘æ–‡æ¡£ä¸­åŒæ ·æ²¡æœ‰æåŠ\snappyã€‚ç¼–è¯‘æ–¹å¼å¦‚ä¸‹</p>
<ol>
<li>æ‰§è¡Œcmakeï¼Œæ‰§è¡Œç›®å½•ä¸º<code>3rdparty\snappy\cmake</code>
<blockquote>
<p>cmake ./</p>
</blockquote>
</li>
<li>ä½¿ç”¨<code>4.2</code>åŒæ ·çš„æ–¹æ³•æ‰¾åˆ°<code>Snappy.sln</code>ç¼–è¯‘</li>
<li>å°†ç›®å½•<code>3rdparty\snappy\cmake\Release</code>æ‹·è´åˆ°<code>3rdparty\snappy</code>ä¸‹</li>
</ol>
<h3 id="brotliç¼–è¯‘">brotliç¼–è¯‘</h3>
<ol>
<li>æ‰§è¡Œcmakeæ‰§è¡Œç›®å½•ä¸º<code>3rdparty\brotli</code>
<blockquote>
<p>cmake -DBUILD_SHARED_LIBS=OFF</p>
</blockquote>
</li>
<li>ä½¿ç”¨<code>4.2</code>åŒæ ·çš„æ–¹æ³•æ‰¾åˆ°<code>brotli.sln</code>ç¼–è¯‘</li>
</ol>
<h2 id="RedisDesktopManagerç¼–è¯‘">RedisDesktopManagerç¼–è¯‘</h2>
<h3 id="ç¼–è¯‘">ç¼–è¯‘</h3>
<ol>
<li>æ‰“å¼€src/rdm.proï¼Œä½¿ç”¨Desktop Qt5.15.2 MSVC2019 64bité…ç½®å·¥ç¨‹<br>
<img src="/posts/cfa83ab0/10.png" alt="qtå·¥ç¨‹"></li>
<li>ä¿®æ”¹<code>pyotherside.pri</code>ä¸­çš„Pythonç‰ˆæœ¬ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é¡¹ç›®å†™æ­»çš„Pythonç›®å½•<br>
<img src="/posts/cfa83ab0/12.png" alt="å‘å¸ƒæ›´æ–°"></li>
<li>é€‰æ‹©<code>å‘å¸ƒæ›´æ–°</code>ï¼Œç¼–è¯‘ç‰ˆæœ¬é€‰æ‹©<code>Release</code>ï¼Œå¹¶ç‚¹å‡»å·¦ä¸‹è§’<code>é”¤å­</code>æ„å»º<br>
<img src="/posts/cfa83ab0/11.png" alt="å‘å¸ƒæ›´æ–°"></li>
<li>ç¼–è¯‘å®Œæˆåç‚¹å‡»<code>è¿è¡Œ</code>æŒ‰é’®ï¼ˆé”¤å­ä¸Šé¢é‚£ä¸ªï¼‰å¯ä»¥çœ‹åˆ°ä»¥ä¸‹ç•Œé¢äº†<br>
<img src="/posts/cfa83ab0/13.png" alt="å‘å¸ƒæ›´æ–°"></li>
</ol>
<h3 id="æ‰“åŒ…">æ‰“åŒ…</h3>
<p>ç°åœ¨åœ¨<code>bin\windows\release</code>ä¸‹å·²ç»å¯ä»¥æ‰¾åˆ°<code>rdm.exe</code>äº†ï¼Œä½†åŒå‡»ä¼šæç¤ºæ‰¾ä¸åˆ°<code>Qt5Quick.dll</code>ç­‰ä¸€ç³»åˆ—æ–‡ä»¶ï¼Œè¿™å°±éœ€è¦æ‰“åŒ…ã€‚</p>
<ol>
<li>
<p>å°†<code>bin\windows\release\rdm.exe</code>æ‹·è´åˆ°<code>build\windows\installer\resources</code>ä¸‹</p>
</li>
<li>
<p>ä¸ºäº†æä¾›Pythonè¿è¡Œç¯å¢ƒï¼Œä¸‹è½½<a href="https://www.python.org/ftp/python/3.9.9/python-3.9.9-embed-amd64.zip">python-3.9.9-embed-amd64</a>ï¼Œå¹¶å°†<code>python39.dll</code>å’Œ<code>python39.zip</code>æ‹·è´åˆ°<code>build\windows\installer\resources</code></p>
</li>
<li>
<p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p>
<blockquote>
<p>C:\Qt\5.15.2\msvc2019_64\bin\windeployqt --release --qmldir C:\RedisDesktopManager\src\qml rdm.exe</p>
</blockquote>
</li>
<li>
<p>ä¸‹è½½<a href="https://nsis.sourceforge.io/Download">nsis</a>åˆ¶ä½œWindowså®‰è£…åŒ…</p>
</li>
<li>
<p>å®‰è£…å¥½<code>nsis</code>åæ‰“å¼€<code>build\windows\installer\installer.nsi</code></p>
<ol>
<li>installer.nsiéœ€è¦åŠ ä¸€è¡Œå®šä¹‰ç‰ˆæœ¬å·ï¼Œå¦åˆ™ä¼šæŠ¥é”™<code>!define VERSION &quot;2021.10.0&quot;</code><br>
<img src="/posts/cfa83ab0/15.png" alt="nsi"><br>
<img src="/posts/cfa83ab0/14.png" alt="nsi"></li>
</ol>
</li>
<li>
<p>ç­‰å¾…nsisæ‰§è¡Œå®Œæ¯•åï¼Œå½“å‰ç›®å½•å°±å¾—åˆ°äº†å®‰è£…åŒ…<code>rdm-2021.11.0.exe</code></p>
</li>
</ol>
<h2 id="å®Œç»“æ•£èŠ±">å®Œç»“æ•£èŠ±</h2>
<p><a href="https://www.aliyundrive.com/s/goXTba7Bfgo">RedisDesktopManager2022.5.1 Windows 64bit å®‰è£…åŒ…</a></p>
]]></content>
      <categories>
        <category>redis</category>
      </categories>
      <tags>
        <tag>redis</tag>
        <tag>RDM</tag>
      </tags>
  </entry>
  <entry>
    <title>Redisson Scan Bug</title>
    <url>/posts/f2e3320d.html</url>
    <content><![CDATA[<p><a href="https://github.com/redisson/redisson">Redisson - Easy Redis Java client with features of In-Memory Data Grid</a><br>
ä¸€ä¸ªè¢«å¹¿æ³›ä½¿ç”¨çš„ï¼ŒåŠŸèƒ½å¼ºï¼Œæ€§èƒ½é«˜Redisåº“ï¼Œä½†ä¸å¾—ä¸è¯´ï¼ŒRedissonçš„BugæŒºå¤šçš„ï¼Œå·¥ä½œä»¥æ¥é™†é™†ç»­ç»­é‡åˆ°äº†å¥½å‡ ä¸ªã€‚æœ€è¿‘ç”±é‡åˆ°ä¸€ä¸ªRedisson Scançš„é—®é¢˜ï¼Œæ­£å¥½è®°å½•ä¸‹</p>
<p>æœ¬æ–‡æ¶‰åŠä¾èµ–å¦‚ä¸‹</p>
<blockquote>
<p>redis: 6.2.9<br>
redisson: 3.15.6<br>
redisson-spring-boot-starter: 3.15.6<br>
spring boot: 2.7.14<br>
spring boot starter data redis: 2.7.14</p>
</blockquote>
<span id="more"></span>
<h2 id="é—®é¢˜å¤ç°">é—®é¢˜å¤ç°</h2>
<p>ä¸ºäº†å¤ç°è¿™ä¸ªé—®é¢˜ï¼Œç¬”è€…åœ¨æœ¬åœ°æ­å»ºäº†ç®€å•çš„Redis Clusterï¼Œä¸‰ä¸»ä¸‰ä»<br>
<img src="/posts/f2e3320d/clusternodes.png" alt="clusternodes.png"></p>
<p>ç„¶åå†™å…¥30ç»„æ•°æ®ä½œä¸ºæµ‹è¯•æ•°æ®</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">@Slf4j
@SpringBootTest
public class RedisScanTest extends AbstractTestNGSpringContextTests &#123;

    @Autowired
    private StringRedisTemplate redisTemplate;

    @Test
    public void writeData2Redis() &#123;
        for (var i &#x3D; 0; i &lt; 30; i++) &#123;
            var ops &#x3D; redisTemplate.boundValueOps(&quot;redisson_scan_&quot; + i);
            ops.set(String.valueOf(i));
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ¥ä¸‹æ¥ä½¿ç”¨RedisTemplateæä¾›çš„scanæ¥æ‰«æRedisä¸­çš„æ•°æ®</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">@Slf4j
@SpringBootTest
public class RedisScanTest extends AbstractTestNGSpringContextTests &#123;

    @Autowired
    private StringRedisTemplate redisTemplate;

    @Test
    public void scanRedis() &#123;
        List&lt;String&gt; list &#x3D; new ArrayList&lt;&gt;();
        try (RedisConnection connection &#x3D; getRedisConnection(redisTemplate)) &#123;
            ScanOptions options &#x3D; ScanOptions.scanOptions().match(&quot;redisson_scan_*&quot;).count(500).build();
            try (Cursor&lt;byte[]&gt; cursor &#x3D; connection.scan(options)) &#123;
                while (cursor.hasNext()) &#123;
                    list.add(new String(cursor.next()));
                &#125;
            &#125;
        &#125;
        var set &#x3D; new HashSet&lt;&gt;(list);
        log.info(&quot;list size&#x3D;&#123;&#125;,list&#x3D;&#123;&#125;&quot;, list.size(), list);
        log.info(&quot;set size&#x3D;&#123;&#125;,set&#x3D;&#123;&#125;&quot;, set.size(), set);
    &#125;

    public RedisConnection getRedisConnection(StringRedisTemplate redisTemplate) &#123;
        return Optional.ofNullable(redisTemplate)
                .map(RedisAccessor::getConnectionFactory)
                .map(RedisConnectionFactory::getConnection)
                .orElseThrow(RuntimeException::new);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸€å…±æœ‰30ä¸ªå…ƒç´ ï¼Œå´æ‰«æå‡ºæ¥çš„33ä¸ªå…ƒç´ ï¼Œå†ä»”ç»†çœ‹ä¸‹<code>redisson_scan_29</code>ï¼Œåœ¨åˆ—è¡¨ä¸­é‡å¤äº†ä¸‰æ¬¡</p>
<pre class="line-numbers language-none"><code class="language-none">list size&#x3D;33,list&#x3D;[redisson_scan_29, redisson_scan_20, redisson_scan_15, redisson_scan_19, redisson_scan_25, redisson_scan_11, redisson_scan_2, redisson_scan_6, redisson_scan_21, redisson_scan_24, redisson_scan_28, redisson_scan_29, redisson_scan_20, redisson_scan_15, redisson_scan_19, redisson_scan_25, redisson_scan_11, redisson_scan_2, redisson_scan_6, redisson_scan_21, redisson_scan_24, redisson_scan_28, redisson_scan_29, redisson_scan_20, redisson_scan_15, redisson_scan_19, redisson_scan_25, redisson_scan_11, redisson_scan_2, redisson_scan_6, redisson_scan_21, redisson_scan_24, redisson_scan_28]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æˆ‘ä»¬å†å¯¹liståšä¸€æ¬¡å»é‡ï¼Œå¯ä»¥çœ‹å‡ºredisTemplatåªæ‰«æå‡ºæ¥äº†11ä¸ªæ•°æ®ï¼Œä½†éƒ½é‡å¤äº†ä¸‰æ¬¡</p>
<pre class="line-numbers language-none"><code class="language-none">set size&#x3D;11,set&#x3D;[redisson_scan_19, redisson_scan_6, redisson_scan_2, redisson_scan_25, redisson_scan_24, redisson_scan_21, redisson_scan_20, redisson_scan_29, redisson_scan_28, redisson_scan_15, redisson_scan_11]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ä¸ºäº†è¯å®çŒœæƒ³ï¼ŒæŸ¥çœ‹äº†éƒ¨åˆ†keyå¯¹åº”çš„slotsï¼ŒredisTemplateæ‰«æå‡ºæ¥çš„keyéƒ½æ˜¯åœ¨<code>dd9318300d4d6a82b783b760693bc1fbb716c61b</code>è¿™ä¸ªèŠ‚ç‚¹ä¸Š</p>
<p><img src="/posts/f2e3320d/slots.png" alt="slots.png"></p>
<h2 id="é—®é¢˜å®šä½">é—®é¢˜å®šä½</h2>
<p>æœ€å¼€å§‹åŒäº‹å‘Šè¯‰æˆ‘ï¼Œéœ€è¦ä½¿ç”¨<code>RedisClusterConnection</code>ï¼Œé‡‡ç”¨ä»¥ä¸‹æ–¹å¼æ‰èƒ½æ‰§è¡Œscanã€‚è®©ç¬”è€…ä¸€åº¦æ€€ç–‘æ˜¯æˆ‘ä½¿ç”¨æ–¹å¼çš„é—®é¢˜ï¼Œä½†ç»†æƒ³ï¼š<code>RedisConnection</code>ä½œä¸ºæœ€åŸºç¡€çš„è¿æ¥ç±»ï¼Œåº”è¯¥å»å±è”½åº•å±‚ä¸åŒé“¾æ¥çš„ç»†èŠ‚æ‰å¯¹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">try (RedisClusterConnection connection &#x3D; getRedisClusterConnection(redisTemplate)) &#123;
    ScanOptions options &#x3D; ScanOptions.scanOptions().match(&quot;redisson_scan_*&quot;).count(500).build();
    for (RedisClusterNode clusterGetNode : connection.clusterGetNodes()) &#123;
        try (Cursor&lt;byte[]&gt; cursor &#x3D; connection.scan(clusterGetNode, options)) &#123;
            while (cursor.hasNext()) &#123;
                list.add(new String(cursor.next()));
            &#125;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>RedisTemplate.scançš„å®ç°åœ¨<code>org.redisson.spring.data.connection.RedissonConnection</code>ä¸­ï¼Œé€»è¾‘ä¹Ÿä¸å¤æ‚</p>
<ol>
<li>è·å–clientå’ŒMasterSlaveEntryè¿­ä»£å™¨</li>
<li>é€šè¿‡MasterSlaveEntryè¿­ä»£å™¨ä¸­çš„entryå¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œscanæ“ä½œï¼Œå¹¶ä¿å­˜scanç»“æœ</li>
<li><strong>åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œé™¤äº†æœ€å¼€å§‹ä¸€æ¬¡ï¼Œclientçš„å€¼éƒ½ä¸ä¼šå˜</strong></li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">@Override
public Cursor&lt;byte[]&gt; scan(ScanOptions options) &#123;
    return new ScanCursor&lt;byte[]&gt;(0, options) &#123;

        &#x2F;&#x2F; æ³¨æ„clientï¼Œç¬¬ä¸€æ¬¡scançš„æ—¶å€™clientæ˜¯null
        private RedisClient client;
        &#x2F;&#x2F; è·å–äº†redisçš„æ‰€æœ‰ç»“ç‚¹ä¿¡æ¯
        private Iterator&lt;MasterSlaveEntry&gt; entries &#x3D; redisson.getConnectionManager().getEntrySet().iterator();
        &#x2F;&#x2F; è·å–ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¿¡æ¯ä¼ å…¥äº†doScan
        private MasterSlaveEntry entry &#x3D; entries.next();
        
        @Override
        protected ScanIteration&lt;byte[]&gt; doScan(long cursorId, ScanOptions options) &#123;
            if (isQueueing() || isPipelined()) &#123;
                throw new UnsupportedOperationException(&quot;&#39;SSCAN&#39; cannot be called in pipeline &#x2F; transaction mode.&quot;);
            &#125;

            &#x2F;&#x2F; entryå¾ªç¯å®Œæ¯•ï¼Œè¿­ä»£å™¨å®Œæ¯•
            if (entry &#x3D;&#x3D; null) &#123;
                return null;
            &#125;
            
            List&lt;Object&gt; args &#x3D; new ArrayList&lt;Object&gt;();
            &#x2F;&#x2F; to avoid negative value
            cursorId &#x3D; Math.max(cursorId, 0);
            args.add(cursorId);
            if (options.getPattern() !&#x3D; null) &#123;
                args.add(&quot;MATCH&quot;);
                args.add(options.getPattern());
            &#125;
            if (options.getCount() !&#x3D; null) &#123;
                args.add(&quot;COUNT&quot;);
                args.add(options.getCount());
            &#125;
            
            &#x2F;&#x2F; æ³¨æ„è¿™é‡Œï¼Œæ‰§è¡Œå™¨ä¸­ä¼ å…¥äº†clientå’Œentryä¿¡æ¯
            RFuture&lt;ListScanResult&lt;byte[]&gt;&gt; f &#x3D; executorService.readAsync(client, entry, ByteArrayCodec.INSTANCE, RedisCommands.SCAN, args.toArray());
            ListScanResult&lt;byte[]&gt; res &#x3D; syncFuture(f);
            long pos &#x3D; res.getPos();
            &#x2F;&#x2F; è¿™é‡Œæœ‰ä¿å­˜scanè¿”å›ç»“æœçš„clientï¼Œæ„å‘³ç€åœ¨scanæ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œé™¤äº†ç¬¬ä¸€æ¬¡æ˜¯nullï¼Œä¹‹åçš„clientæ˜¯æ²¡æœ‰å˜åŒ–çš„
            client &#x3D; res.getRedisClient();
            if (pos &#x3D;&#x3D; 0) &#123;
                if (entries.hasNext()) &#123;
                    pos &#x3D; -1;
                    &#x2F;&#x2F; å¦‚æœscanå®Œæ¯•ï¼Œä½¿ç”¨ä¸‹ä¸€ä¸ªentry
                    entry &#x3D; entries.next();
                &#125; else &#123;
                    entry &#x3D; null;
                &#125;
            &#125;
            
            return new ScanIteration&lt;byte[]&gt;(pos, res.getValues());
        &#125;
    &#125;.open();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç»§ç»­è·Ÿè¸ªåˆ°<code>executorService.readAsync</code>ï¼Œæ³¨æ„è¿™ä¸ª<code>NodeSource</code>ï¼Œä¿å­˜äº†<code>MasterSlaveEntry</code>å’Œ<code>RedisClient</code>ä¿¡æ¯</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">@Override
public &lt;T, R&gt; RFuture&lt;R&gt; readAsync(RedisClient client, MasterSlaveEntry entry, Codec codec, RedisCommand&lt;T&gt; command, Object... params) &#123;
    RPromise&lt;R&gt; mainPromise &#x3D; createPromise();
    async(true, new NodeSource(entry, client), codec, command, params, mainPromise, false, false);
    return mainPromise;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç»§ç»­å¾€ä¸‹èµ°ï¼Œåˆ°äº†è·å–é“¾æ¥çš„åœ°æ–¹äº†</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">@Override
public RFuture&lt;RedisConnection&gt; connectionReadOp(NodeSource source, RedisCommand&lt;?&gt; command) &#123;
    MasterSlaveEntry entry &#x3D; getEntry(source);
    if (entry &#x3D;&#x3D; null) &#123;
        return RedissonPromise.newFailedFuture(createNodeNotFoundException(source));
    &#125;

    if (source.getRedirect() !&#x3D; null) &#123;
        return entry.connectionReadOp(command, source.getAddr());
    &#125;
    &#x2F;&#x2F; å¦‚æœRedisClientä¸ä¸ºnullï¼Œä½¿ç”¨RedisClientè·å–Connection
    if (source.getRedisClient() !&#x3D; null) &#123;
        return entry.connectionReadOp(command, source.getRedisClient());
    &#125;
    
    &#x2F;&#x2F; å¦‚æœRedisClientä¸ºnullï¼Œä½¿ç”¨ä¼ å…¥çš„entryè·å–Connection
    return entry.connectionReadOp(command);
&#125;

private MasterSlaveEntry getEntry(NodeSource source) &#123;
    if (source.getRedirect() !&#x3D; null) &#123;
        return getEntry(source.getAddr());
    &#125;

    MasterSlaveEntry entry &#x3D; source.getEntry();
    &#x2F;&#x2F; å¦‚æœRedisClientä¸ä¸ºnullï¼Œé€šè¿‡RedisClientè·å–entry
    if (source.getRedisClient() !&#x3D; null) &#123;
        entry &#x3D; getEntry(source.getRedisClient());
    &#125;
    if (entry &#x3D;&#x3D; null &amp;&amp; source.getSlot() !&#x3D; null) &#123;
        entry &#x3D; getEntry(source.getSlot());
    &#125;
    &#x2F;&#x2F; å¦‚æœRedisClientä¸nullï¼Œä½¿ç”¨ä¼ å…¥çš„entry
    return entry;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>getEntryä¸­é€»è¾‘æ¯”è¾ƒç®€å•</p>
<ul>
<li>å¦‚æœclientä¸ºç©ºï¼Œä½¿ç”¨doScanä¸­ä¼ å…¥çš„entryåˆ›å»ºconnection</li>
<li>å¦‚æœclientä¸ä¸ºç©ºï¼Œä½¿ç”¨clientåˆ›å»ºconnection</li>
</ul>
<p>åˆ°è¿™é‡Œï¼Œæ•´ä¸ªbugå°±æ¯”è¾ƒæ¸…æ™°äº†</p>
<ol>
<li>ç¬¬ä¸€æ¬¡doScanæ—¶ï¼Œclientä¸ºnullï¼Œè·å–connectionæ—¶é€‰æ‹©äº†ä¸€ä¸ªentryï¼ˆå¯¹åº”åˆ°redisçš„ä¸€ä¸ªä»èŠ‚ç‚¹ï¼‰</li>
<li>ä¹‹ådoScanæ—¶ï¼Œclentå·²ç»èµ‹å€¼äº†ï¼Œè€Œä¸”æ²¡æœ‰åˆ‡æ¢é€»è¾‘ï¼Œåº•å±‚æ¯æ¬¡éƒ½ä¼šè·å–åˆ°åŒä¸€ä¸ªconnection</li>
<li>åœ¨ä¸‰ä¸»ä¸‰ä»çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œscanï¼Œå®é™…æ—¶å¯¹åŒä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œäº†3æ¬¡scan</li>
</ol>
<h2 id="é—®é¢˜è§£å†³">é—®é¢˜è§£å†³</h2>
<p>æ˜ç¡®äº†æ˜¯Redissonçš„bugäº†ï¼Œé—®é¢˜å°±æ¯”è¾ƒå¥½è§£å†³äº†ï¼Œå»githubæ‰¾Redissonçš„release noteå°±è¡Œäº†</p>
<p>åœ¨redisson-3.17.1çš„releaseä¸­ï¼Œæ‰¾åˆ°äº†è¿™æ ·ä¸€æ¡fix</p>
<blockquote>
<p>Fixed - Spring Data Redis module. Scan In cluster mode, other nodes cannot be scanned</p>
</blockquote>
<p>å®˜æ–¹ä¿®å¤ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨ä¸€ä¸ªèŠ‚ç‚¹scanå®Œæ¯•åï¼Œå°†clientè®¾ç½®ä¸ºnullï¼Œä½¿ä¸‹ä¸€è½®doScanå¯ä»¥åˆ‡æ¢åˆ°ä¸åŒèŠ‚ç‚¹ä¸Š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">if (pos &#x3D;&#x3D; 0) &#123;
    if (entries.hasNext()) &#123;
        pos &#x3D; -1;
        entry &#x3D; entries.next();
        &#x2F;&#x2F; clientè®¾ç½®ä¸ºnullï¼Œä½¿å…¶å¯ä»¥åˆ‡æ¢èŠ‚ç‚¹
        client &#x3D; null;
    &#125; else &#123;
        entry &#x3D; null;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‡çº§redissonå’Œredisson-spring-boot-starteråï¼Œå†è·‘ä¸€æ¬¡scanï¼Œç°åœ¨ä¸€åˆ‡æ­£å¸¸äº†</p>
<pre class="line-numbers language-none"><code class="language-none">ist size&#x3D;30,list&#x3D;[redisson_scan_0, redisson_scan_7, redisson_scan_13, redisson_scan_14, redisson_scan_4, redisson_scan_17, redisson_scan_26, redisson_scan_18, redisson_scan_10, redisson_scan_22, redisson_scan_8, redisson_scan_3, redisson_scan_9, redisson_scan_16, redisson_scan_27, redisson_scan_5, redisson_scan_23, redisson_scan_1, redisson_scan_12, redisson_scan_29, redisson_scan_20, redisson_scan_15, redisson_scan_19, redisson_scan_25, redisson_scan_11, redisson_scan_2, redisson_scan_6, redisson_scan_21, redisson_scan_24, redisson_scan_28]
set size&#x3D;30,set&#x3D;[redisson_scan_0, redisson_scan_1, redisson_scan_18, redisson_scan_17, redisson_scan_19, redisson_scan_8, redisson_scan_9, redisson_scan_6, redisson_scan_7, redisson_scan_4, redisson_scan_5, redisson_scan_2, redisson_scan_3, redisson_scan_25, redisson_scan_24, redisson_scan_27, redisson_scan_26, redisson_scan_21, redisson_scan_20, redisson_scan_23, redisson_scan_22, redisson_scan_29, redisson_scan_28, redisson_scan_14, redisson_scan_13, redisson_scan_16, redisson_scan_15, redisson_scan_10, redisson_scan_12, redisson_scan_11]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      <tags>
        <tag>Bug</tag>
        <tag>Redisson</tag>
      </tags>
  </entry>
  <entry>
    <title>dictå­—å…¸</title>
    <url>/posts/4fcbe513.html</url>
    <content><![CDATA[<blockquote>
<p><strong>æœ¬æ–‡æºç <a href="https://download.redis.io/releases/redis-5.0.12.tar.gz">redis5.0.12</a></strong><br>
dictçš„æ•°æ®ç»“æ„ï¼Œå®šä¹‰åœ¨<code>dict.h</code>ï¼Œå®ç°åœ¨<code>dict.c</code>ä¸­</p>
</blockquote>
<p>hashä¹Ÿæ˜¯redisä¸­å¾ˆå¸¸ç”¨çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå…¶å®å„ä¸ªè¯­è¨€çš„hashï¼Œmapæˆ–å­—å…¸çš„å®ç°éƒ½å¤§åŒå°å¼‚ã€‚redisçš„hashå®ç°æœ‰ziplistå’Œdictä¸¤ç§ç­–ç•¥ã€‚æœ¬æ–‡ä¸»è¦åˆ†æå­—å…¸</p>
<span id="more"></span>
<h2 id="DICTæ•°æ®ç»“æ„">DICTæ•°æ®ç»“æ„</h2>
<h3 id="Hashè¡¨èŠ‚ç‚¹">Hashè¡¨èŠ‚ç‚¹</h3>
<p>dictEntryä¿å­˜äº†å­—å…¸ä¸­çš„èŠ‚ç‚¹ï¼Œæ•°æ®ç»“æ„æ¯”è¾ƒç®€å•ï¼Œè®°å½•äº†keyï¼Œvalueå’Œhashå†²çªåé‡‡ç”¨<code>é“¾åœ°å€æ³•</code>çš„é“¾è¡¨headerã€‚</p>
<ul>
<li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œvalueé‡‡ç”¨äº†unionï¼Œä¸»è¦æ˜¯å­—å…¸åœ¨redisä¸­è¢«å¹¿æ³›ä½¿ç”¨äº†ã€‚å¦‚ï¼šhashæŒ‡ä»¤ï¼Œè®°å½•å„ä¸ªé”®çš„TTLç­‰ï¼Œåœ¨ä¸åŒçš„åœºæ™¯ä¸‹ä¼šä½¿ç”¨ä¸åŒçš„æˆå‘˜ï¼Œå¦‚è®°å½•TTLæ—¶ä½¿ç”¨äº†<code>s64</code>ã€‚è¿™æ ·è®¾è®¡çš„åŸå› ä¹Ÿæ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ã€‚</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">typedef struct dictEntry &#123;
    &#x2F;&#x2F; key
    void *key;
    &#x2F;&#x2F; valueï¼Œcè¯­è¨€ä¸­çš„å…±ç”¨ä½“
    union &#123;
        void *val;
        uint64_t u64;
        int64_t s64;
        double d;
    &#125; v;
    &#x2F;&#x2F; hashå†²çªåä½¿ç”¨å•é“¾è¡¨å­˜å‚¨
    struct dictEntry *next;
&#125; dictEntry;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Hashè¡¨">Hashè¡¨</h3>
<p>Hashè¡¨ä¸»è¦è®°å½•äº†entryæ•°ç»„ç­‰ä¿¡æ¯ã€‚</p>
<ul>
<li>tableï¼šä¸€ç»´æ•°ç»„ï¼Œhashåçš„æ•°æ®å°±å­˜åœ¨è¿™é‡Œï¼Œç›¸å½“äºslotçš„æ¦‚å¿µ</li>
<li>sizeï¼štableæ•°ç»„å¤§å°ï¼Œæœ€å°4ï¼Œå¿…é¡»æ˜¯2^n</li>
<li>sizemaskï¼šå›ºå®šä¸ºsize-1ï¼Œè¿™ä¹ˆåšçš„ç›®çš„æ˜¯æ–¹ä¾¿è®¡ç®—å…ƒç´ çš„ç´¢å¼•ã€‚
<ul>
<li>å› ä¸ºsizeå›ºå®šæ˜¯<code>2^n</code>ï¼Œå¦‚4ï¼Œ8â€¦â€¦è¿™æ ·sizemaskå›ºå®šä¸ºï¼š3ï¼Œ7â€¦â€¦æ³¨æ„åˆ°3çš„äºŒè¿›åˆ¶æ˜¯<code>11</code>ï¼Œ7çš„äºŒè¿›åˆ¶æ˜¯<code>111</code>ã€‚è¿™æ ·è®¡ç®—<code>index=hash &amp; sizemask</code></li>
</ul>
</li>
<li>usedï¼šè®°å½•Hashè¡¨ä¸­ä¿å­˜çš„æ•°æ®ä¸ªæ•°</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;* This is our hash table structure. Every dictionary has two of this as we
 * implement incremental rehashing, for the old to the new table. *&#x2F;
typedef struct dictht &#123;
    &#x2F;&#x2F; äºŒç»´æ•°ç»„ï¼ŒæŒ‡å‘kvå¯¹
    dictEntry **table;   
    &#x2F;&#x2F; tableçš„å¤§å°
    unsigned long size;  
    &#x2F;&#x2F; æ©ç ï¼Œtableçš„å¤§å°å›ºå®šä¸º2^nï¼Œsizemaskä¸ºsize-1ï¼Œå³2^n-1ï¼Œè¿™æ ·sizemaskçš„æ¯ä¸€ä½éƒ½æ˜¯1
    unsigned long sizemask; 
    &#x2F;&#x2F; å·²ä¿å­˜kvå¯¹çš„ä¸ªæ•°
    unsigned long used;
&#125; dictht;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸ªåœ°æ–¹è¦æ³¨æ„ä¸‹**tableã€‚èœé¸¡å¦‚æˆ‘çœ‹åˆ°**tableä»¥ä¸ºæ˜¯ä¸ªäºŒç»´æ•°ç»„ï¼Œå¯ä»¥é€štable[1][1]è®¿é—®è¿™ç§ã€‚å…¶å®ä¸æ˜¯ï¼Œtableåº”è¯¥ç†è§£æˆä¸€ç»´æ•°ç»„ï¼Œä½¿ç”¨äºŒç»´æŒ‡é’ˆåªæ˜¯æ–¹ä¾¿<code>dictEntry-&gt;next</code>çš„è®¿é—®ã€‚<br>
<img src="/posts/4fcbe513/dictht.svg" alt="dict"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">dictht *ht
for (i &#x3D; 0; i &lt; ht-&gt;size; i++) &#123;
 dictEntry *he &#x3D; ht-&gt;table[i];
 while(he) &#123;
  chainlen++;
  he &#x3D; he-&gt;next;
 &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Dictå­—å…¸">Dictå­—å…¸</h3>
<p>æœ‰äº†hash tableï¼Œå°±å¯ä»¥å¾ˆå®¹æ˜“å¾—åˆ°å­—å…¸æ•°æ®ç»“æ„ã€‚</p>
<ul>
<li>dictTypeï¼šæŒ‡å‘äº†dictTypeç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº†è¿™ä¸ªdictçš„ä¸€äº›åŸºæœ¬æ“ä½œå‡½æ•°ï¼Œå¦‚ï¼šhashå‡½æ•°</li>
<li>privdataï¼šè¯¥å­—å…¸çš„metadataï¼Œé…åˆdictTypeé‡Œé¢çš„å‡½æ•°ä½¿ç”¨</li>
<li>ht[2]ï¼šå­—å…¸æœ€ä¸»è¦çš„æ•°æ®ç»“æ„ï¼Œhash table
<ul>
<li>è¿™é‡Œçš„hash tableå®šä¹‰çš„æ˜¯å¤§å°ä¸º2çš„æ•°ç»„ï¼Œè¿™æ ·ä¸»è¦æ˜¯æ–¹ä¾¿rehashã€‚</li>
<li>å¹³æ—¶ä½¿ç”¨çš„æ˜¯ht[0]ï¼Œrehashæ—¶ï¼Œä¸ºäº†ä¸é˜»å¡æ“ä½œï¼Œä¼šåœ¨æ–°å»ºht[1]ï¼Œå¹¶é€æ­¥æŠŠæ•°æ®è¿ç§»åˆ°ht[1]ï¼Œè¿ç§»å®Œæˆåht[1]å°±å˜æˆäº†ht[0]ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡rehashã€‚è¿™é‡Œçš„æ€æƒ³ç±»ä¼¼äºjava gcæ—¶çš„å¤åˆ¶ç®—æ³•</li>
</ul>
</li>
<li>rehashidxï¼šrehashæ—¶ä½¿ç”¨ï¼Œæ ‡è®°rehashåˆ°hash tableçš„å“ªä¸ªä½ç½®äº†ã€‚è¿™é‡Œå¯ä»¥å›å¿†ä¸‹dicthtçš„ç»“æ„ï¼Œé‡Œé¢çš„tableæ˜¯ä¸€ä¸ªä¸€ç»´æ•°ç»„ï¼Œè¿™ä¸ªrehashidxå°±æ˜¯æ ‡ç¤ºtableçš„rehashåˆ°å“ªå„¿çš„indexã€‚å¦‚æœæ²¡æœ‰rehashï¼Œrehashidx=-1</li>
<li>iteratorsï¼šè®°å½•è¿­ä»£å™¨çš„æ•°é‡ï¼Œè¿­ä»£å™¨å‚è€ƒä¸‹æ–‡</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">typedef struct dict &#123;
    dictType *type;
    void *privdata;
    dictht ht[2];
    long rehashidx; &#x2F;* rehashing not in progress if rehashidx &#x3D;&#x3D; -1 *&#x2F;
    unsigned long iterators; &#x2F;* number of iterators currently running *&#x2F;
&#125; dict;

typedef struct dictType &#123;
    &#x2F;&#x2F; hashå‡½æ•°
    uint64_t (*hashFunction)(const void *key);
    &#x2F;&#x2F; keyå¯¹åº”çš„å¤åˆ¶å‡½æ•°
    void *(*keyDup)(void *privdata, const void *key);
    &#x2F;&#x2F; valå¯¹åº”çš„å¤åˆ¶å‡½æ•°
    void *(*valDup)(void *privdata, const void *obj);
    &#x2F;&#x2F; keyçš„compareå‡½æ•°
    int (*keyCompare)(void *privdata, const void *key1, const void *key2);
    &#x2F;&#x2F; keyçš„ææ„å‡½æ•°
    void (*keyDestructor)(void *privdata, void *key);
    &#x2F;&#x2F; valçš„ææ„å‡½æ•°
    void (*valDestructor)(void *privdata, void *obj);
&#125; dictType;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="DICTåŸºæœ¬æ“ä½œ">DICTåŸºæœ¬æ“ä½œ</h2>
<h3 id="åˆ›å»ºDict">åˆ›å»ºDict</h3>
<p>dictçš„åˆ›å»ºå¾ˆç®€å•ã€‚æ³¨æ„åˆšåˆ›å»ºçš„dictå¤§å°ä¸º0ï¼Œé‡Œé¢çš„ht.tableä¹Ÿéƒ½æ˜¯nullï¼Œå½“ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ—¶ï¼Œä¼šåœ¨<code>_dictExpandIfNeeded</code>å‡½æ•°ä¸­å¯¹htè¿›è¡Œåˆå§‹åŒ–</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;* Create a new hash table *&#x2F;
dict *dictCreate(dictType *type,
        void *privDataPtr)
&#123;
    dict *d &#x3D; zmalloc(sizeof(*d));

    _dictInit(d,type,privDataPtr);
    return d;
&#125;
&#x2F;* Initialize the hash table *&#x2F;
int _dictInit(dict *d, dictType *type,
        void *privDataPtr)
&#123;
    _dictReset(&amp;d-&gt;ht[0]);
    _dictReset(&amp;d-&gt;ht[1]);
    d-&gt;type &#x3D; type;
    d-&gt;privdata &#x3D; privDataPtr;
    d-&gt;rehashidx &#x3D; -1;
    d-&gt;iterators &#x3D; 0;
    return DICT_OK;
&#125;
&#x2F;* Reset a hash table already initialized with ht_init().
 * NOTE: This function should only be called by ht_destroy(). *&#x2F;
static void _dictReset(dictht *ht)
&#123;
    ht-&gt;table &#x3D; NULL;
    ht-&gt;size &#x3D; 0;
    ht-&gt;sizemask &#x3D; 0;
    ht-&gt;used &#x3D; 0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="æ·»åŠ å…ƒç´ ">æ·»åŠ å…ƒç´ </h3>
<p>æ·»åŠ å…ƒç´ åŸºæœ¬é€»è¾‘å¾ˆç®€å•</p>
<ol>
<li>ä½¿ç”¨<code>dictAddRaw</code>æ‰¾åˆ°åˆé€‚çš„dictEntry</li>
<li>æ‰¾åˆ°åä½¿ç”¨å®<code>dictSetVal</code>å§valueæ”¾åˆ°dictEntryä¸­</li>
</ol>
<ul>
<li>æ³¨æ„å®é‡Œé¢ä½¿ç”¨äº†ï¼Œ<code>do&#123;â€¦â€¦&#125;while(0)</code>è¿™ä¸ªæŠ€å·§ã€‚å¯¹cä¸ç†Ÿæ‚‰çš„ä¼šæ‘¸ä¸ç€å¤´è„‘ï¼Œå…¶å®å°±æ˜¯ä¿è¯å®åœ¨ä»»ä½•åœ°æ–¹éƒ½èƒ½ä»¥æœŸæœ›çš„è¯­ä¹‰å±•å¼€ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« <a href="https://www.cnblogs.com/lanxuezaipiao/p/3535626.html">do {â€¦} while (0) åœ¨å®å®šä¹‰ä¸­çš„ä½œç”¨</a></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;* Add an element to the target hash table *&#x2F;
int dictAdd(dict *d, void *key, void *val)
&#123;
    dictEntry *entry &#x3D; dictAddRaw(d,key,NULL);

    if (!entry) return DICT_ERR;
    dictSetVal(d, entry, val);
    return DICT_OK;
&#125;

#define dictSetVal(d, entry, _val_) do &#123; \
    if ((d)-&gt;type-&gt;valDup) \
        (entry)-&gt;v.val &#x3D; (d)-&gt;type-&gt;valDup((d)-&gt;privdata, _val_); \
    else \
        (entry)-&gt;v.val &#x3D; (_val_); \
&#125; while(0)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»ä¸Šæ–‡ä¸­å¯ä»¥çœ‹å‡ºï¼Œ<code>dictAddRaw</code>æ‰æ˜¯æ­£æ–‡ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹è¿™ä¸ªå‡½æ•°ã€‚</p>
<ol>
<li>å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯åœ¨rehashè¿‡ç¨‹ä¸­ï¼Œåˆ¤æ–­dict.rehashidxæ˜¯ä¸æ˜¯-1ï¼Œå¦‚æœä¸æ˜¯-1ã€‚åˆ™æ‰§è¡Œä¸€æ¬¡rehash stepï¼Œrehashè¿‡ç¨‹åœ¨ä¸‹æ–‡è¯¦ç»†è¯´æ˜ã€‚</li>
</ol>
<blockquote>
<p><strong>ä»€ä¹ˆæ˜¯rehash step</strong><br>
redisæ‰§è¡Œå‘½ä»¤éƒ½æ˜¯å•çº¿ç¨‹æ“ä½œï¼Œå¾ˆæ˜æ˜¾åœ¨å­—å…¸rehashçš„è¿‡ç¨‹ä¸­ä¼šé˜»å¡æ“ä½œï¼Œä¸ºäº†å‡å°‘è¿™ç§é˜»å¡ï¼Œredisçš„rehashé‡‡ç”¨äº†æ¸è¿›å¼çš„rehashã€‚<br>
ä¸Šæ–‡æåˆ°äº†ï¼Œdictä¸­å®šä¹‰äº†htæ•°ç»„ï¼Œå¹³æ—¶ä½¿ç”¨ht[0]ï¼Œrehashæ—¶æ–°å»ºht[1]ï¼Œå¹¶é€æ­¥å°†ht[0]çš„æ•°æ®è¿ç§»åˆ°ht[1]ã€‚æ²¡åšä¸€æ¬¡è¿ç§»ï¼Œå°±æ˜¯rehash step</p>
</blockquote>
<ol start="2">
<li>æ ¹æ®keyè®¡ç®—æ•°æ®å­˜å‚¨æ‰€åœ¨çš„indexï¼Œå¦‚æœkeyåœ¨dictä¸­å·²ç»å­˜åœ¨ï¼Œåˆ™<strong>æ·»åŠ é”™è¯¯</strong>ã€‚</li>
<li>æ˜¯å¦å¤„äºrehashè¿‡ç¨‹ä¸­ï¼Œæ˜¯çš„è¯é€‰æ‹©ht[1]ï¼Œå¦åˆ™é€‰æ‹©ht[0]æ”¾ç½®æ•°æ®</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">dictEntry *dictAddRaw(dict *d, void *key, dictEntry **existing)
&#123;
    long index;
    dictEntry *entry;
    dictht *ht;

    if (dictIsRehashing(d)) _dictRehashStep(d);

    &#x2F;* Get the index of the new element, or -1 if
     * the element already exists. *&#x2F;
    &#x2F;&#x2F; #define dictHashKey(d, key) (d)-&gt;type-&gt;hashFunction(key)
    if ((index &#x3D; _dictKeyIndex(d, key, dictHashKey(d,key), existing)) &#x3D;&#x3D; -1)
        return NULL;

    &#x2F;* Allocate the memory and store the new entry.
     * Insert the element in top, with the assumption that in a database
     * system it is more likely that recently added entries are accessed
     * more frequently. *&#x2F;
    ht &#x3D; dictIsRehashing(d) ? &amp;d-&gt;ht[1] : &amp;d-&gt;ht[0];
    entry &#x3D; zmalloc(sizeof(*entry));
    &#x2F;&#x2F; å¦‚æœhashå†²çªï¼Œæ”¾åˆ°é“¾è¡¨ä¸­
    entry-&gt;next &#x3D; ht-&gt;table[index];
    ht-&gt;table[index] &#x3D; entry;
    ht-&gt;used++;

    &#x2F;* Set the hash entry fields. *&#x2F;
    dictSetKey(d, entry, key);
    return entry;
&#125;

#define dictSetKey(d, entry, _key_) do &#123; \
    if ((d)-&gt;type-&gt;keyDup) \
        (entry)-&gt;key &#x3D; (d)-&gt;type-&gt;keyDup((d)-&gt;privdata, _key_); \
    else \
        (entry)-&gt;key &#x3D; (_key_); \
&#125; while(0)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>çœ‹å®Œè¿™æ®µä»£ç ï¼Œæˆ‘ä»¬å‘ç°è¿™ä¸ªçš„æ ¸å¿ƒä¼˜åŠ¿è¿™ä¹ˆæ‰¾åˆ°keyåœ¨tableä¸­çš„ä½ç½®ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯<code>_dictKeyIndex</code>ã€‚</p>
<ol>
<li>æ·»åŠ æ—¶å…ˆåˆ¤æ–­é€‰æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œå¦‚æœå®¹é‡ä¸å¤Ÿå…ˆæ‰©å®¹ã€‚</li>
<li>æ ¹æ®hashå€¼å’Œsizemaskè®¡ç®—å‡ºæ•°æ®åº”è¯¥å­˜æ”¾çš„indexã€‚</li>
<li>æ ¹æ®indexï¼Œåœ¨ä¸¤ä¸ªhtä¸­æŸ¥æ‰¾keyæ˜¯å¦å­˜åœ¨ï¼ˆåŒ…æ‹¬å•é“¾è¡¨ï¼‰ï¼Œå¦‚æœkeyå·²ç»æœ‰äº†ï¼Œè¿”å›é”™è¯¯ã€‚æ£€æŸ¥å®Œæˆåè¿”å›indexä½œä¸ºæ•°æ®çš„å­˜æ”¾ç´¢å¼•</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">static long _dictKeyIndex(dict *d, const void *key, uint64_t hash, dictEntry **existing)
&#123;
    unsigned long idx, table;
    dictEntry *he;
    if (existing) *existing &#x3D; NULL;

    &#x2F;* Expand the hash table if needed *&#x2F;
    if (_dictExpandIfNeeded(d) &#x3D;&#x3D; DICT_ERR)
        return -1;
    for (table &#x3D; 0; table &lt;&#x3D; 1; table++) &#123;
        idx &#x3D; hash &amp; d-&gt;ht[table].sizemask;
        &#x2F;* Search if this slot does not already contain the given key *&#x2F;
        he &#x3D; d-&gt;ht[table].table[idx];
        while(he) &#123;
            if (key&#x3D;&#x3D;he-&gt;key || dictCompareKeys(d, key, he-&gt;key)) &#123;
                if (existing) *existing &#x3D; he;
                return -1;
            &#125;
            he &#x3D; he-&gt;next;
        &#125;
        if (!dictIsRehashing(d)) break;
    &#125;
    return idx;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="rehash">rehash</h3>
<h3 id="æ‰©å®¹">æ‰©å®¹</h3>
<h3 id="éå†">éå†</h3>
<h2 id="APIåˆ—è¡¨">APIåˆ—è¡¨</h2>
<table>
<thead>
<tr>
<th>API</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>dict <em>dictCreate(dictType</em>type, void *privDataPtr);</td>
<td>åˆ›å»ºå­—å…¸</td>
</tr>
<tr>
<td>int dictExpand(dict *d, unsigned long size);</td>
<td>å­—å…¸æ‰©å®¹</td>
</tr>
<tr>
<td>int dictAdd(dict <em>d, void</em>key, void *val);</td>
<td>æ·»åŠ å¢æ•°æ®ï¼Œä¸èƒ½é‡å¤æ·»åŠ </td>
</tr>
<tr>
<td>dictEntry <em>dictAddRaw(dict</em>d, void *key, dictEntry **existing);</td>
<td>æ·»åŠ æ•°æ®ï¼Œå¦‚æœé‡å¤æ·»åŠ ï¼Œæ”¾å…¥existing</td>
</tr>
<tr>
<td>dictEntry <em>dictAddOrFind(dict</em>d, void *key);</td>
<td>æ·»åŠ æˆ–æŸ¥æ‰¾</td>
</tr>
<tr>
<td>int dictReplace(dict <em>d, void</em>key, void *val);</td>
<td>æ·»åŠ æ•°æ®ï¼Œå¦‚æœå­˜åœ¨å°±æ›´æ–°ï¼Œä¸å­˜åœ¨å°±æ·»åŠ </td>
</tr>
<tr>
<td>int dictDelete(dict <em>d, const void</em>key);</td>
<td>åˆ é™¤æ•°æ®</td>
</tr>
<tr>
<td>dictEntry <em>dictUnlink(dict</em>ht, const void *key);</td>
<td>åˆ é™¤æ•°æ®ï¼ˆæƒ°æ€§åˆ é™¤ï¼‰</td>
</tr>
<tr>
<td>void dictFreeUnlinkedEntry(dict <em>d, dictEntry</em>he);</td>
<td>é‡Šæ”¾æƒ°æ€§åˆ é™¤æ²¡æœ‰é‡Šæ”¾çš„å†…å­˜</td>
</tr>
<tr>
<td>void dictRelease(dict *d);</td>
<td>åˆ é™¤å­—æ®µå¹¶é‡Šæ”¾å†…å­˜</td>
</tr>
<tr>
<td>dictEntry <em>dictFind(dict</em>d, const void *key);</td>
<td>æ ¹æ®keyæŸ¥æ‰¾entry</td>
</tr>
<tr>
<td>void <em>dictFetchValue(dict</em>d, const void *key);</td>
<td>æ ¹æ®keyæŸ¥æ‰¾value</td>
</tr>
<tr>
<td>int dictResize(dict *d);</td>
<td>è°ƒæ•´å­—å…¸å¤§å°ï¼Œè°ƒæ•´åå¤§å°ä¸ºå½“å‰æ•°æ®é‡çš„æœ€å°å€¼</td>
</tr>
<tr>
<td>dictIterator <em>dictGetIterator(dict</em>d);</td>
<td>åˆå§‹åŒ–æ™®é€šè¿­ä»£å™¨</td>
</tr>
<tr>
<td>dictIterator <em>dictGetSafeIterator(dict</em>d);</td>
<td>åˆå§‹åŒ–å®‰å…¨è¿­ä»£å™¨</td>
</tr>
<tr>
<td>dictEntry <em>dictNext(dictIterator</em>iter);</td>
<td>è·å–ä¸‹ä¸€ä¸ªè¿­ä»£å™¨ï¼Œiter.next()</td>
</tr>
<tr>
<td>void dictReleaseIterator(dictIterator *iter);</td>
<td>é‡Šæ”¾è¿­ä»£å™¨</td>
</tr>
<tr>
<td>dictEntry <em>dictGetRandomKey(dict</em>d);</td>
<td>éšæœºè·å–ä¸€ä¸ªkey</td>
</tr>
<tr>
<td>unsigned int dictGetSomeKeys(dict *d, dictEntry **des, unsigned int count);</td>
<td>éšæœºè·å–countä¸ªå¯ç”¨</td>
</tr>
<tr>
<td>void dictGetStats(char <em>buf, size_t bufsize, dict</em>d);</td>
<td>è·å–å­—å…¸çš„çŠ¶æ€</td>
</tr>
<tr>
<td>uint64_t dictGenHashFunction(const void *key, int len);</td>
<td>è·å–hashå‡½æ•°ï¼ˆå¤§å°å†™æ•æ„Ÿï¼‰</td>
</tr>
<tr>
<td>uint64_t dictGenCaseHashFunction(const unsigned char *buf, int len);</td>
<td>è·å–hashå‡½æ•°ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰</td>
</tr>
<tr>
<td>void dictEmpty(dict <em>d, void(callback)(void</em>));</td>
<td>æ¸…ç©ºå­—å…¸</td>
</tr>
<tr>
<td>void dictEnableResize(void);</td>
<td>å…è®¸resize</td>
</tr>
<tr>
<td>void dictDisableResize(void);</td>
<td>ä¸å…è®¸resize</td>
</tr>
<tr>
<td>int dictRehash(dict *d, int n);</td>
<td>æ¸è¿›å¼rehashï¼Œnä¸ºstep</td>
</tr>
<tr>
<td>int dictRehashMilliseconds(dict *d, int ms);</td>
<td>æ‰§è¡Œè‹¥å¹²æ­¥rehashï¼Œä½†rehashä¸èƒ½è¶…è¿‡å›ºå®šæ—¶é•¿</td>
</tr>
<tr>
<td>void dictSetHashFunctionSeed(uint8_t *seed);</td>
<td>è®¾ç½®éšæœºç§å­</td>
</tr>
<tr>
<td>uint8_t *dictGetHashFunctionSeed(void);</td>
<td>è·å–éšæœºç§å­</td>
</tr>
<tr>
<td>unsigned long dictScan(dict <em>d, unsigned long v, dictScanFunction</em>fn, dictScanBucketFunction <em>bucketfn, void</em>privdata);</td>
<td>æ‰«æå­—å…¸</td>
</tr>
<tr>
<td>uint64_t dictGetHash(dict <em>d, const void</em>key);</td>
<td>è·å–keyçš„hash</td>
</tr>
<tr>
<td>dictEntry **dictFindEntryRefByPtrAndHash(dict *d, const void *oldptr, uint64_t hash);</td>
<td>é€šè¿‡å·²ç»è¢«æƒ°æ€§åˆ é™¤çš„æ•°æ®å’ŒhashæŸ¥æ‰¾entry</td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>redis</category>
      </categories>
      <tags>
        <tag>redisæºç </tag>
        <tag>redisæ•°æ®ç»“æ„</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Condition</title>
    <url>/posts/a7ee6b02.html</url>
    <content><![CDATA[<blockquote>
<p>æœ¬æ–‡åŸºäº<code>Spring Boot 2.7.9</code>ä¸<code>Spring Framework 5.3.25</code></p>
</blockquote>
<p>Spring Bootä¸­ï¼Œä¸€ä¸ªå¾ˆæ–¹ä¾¿ä¹Ÿæ˜¯å¾ˆé‡è¦çš„æœºåˆ¶å°±æ˜¯<code>spring-boot-starter</code>ï¼Œåªéœ€è¦åœ¨pomä¸­å¼•å…¥ç»„ä»¶å¯¹åº”çš„spring-boot-starterå°±å¯ä»¥å¼•å…¥å¹¶ä½¿ç”¨è¯¥ç»„ä»¶ã€‚<br>
Spring Boot Starterä¸­ï¼Œæ¡ä»¶åŠ è½½æ—¶å¾ˆé‡è¦çš„ä¸€ä¸ªç‰¹æ€§ï¼Œæœ¬æ–‡å°±çœ‹çœ‹æ¡ä»¶åŠ è½½åœ¨Springä¸­æ˜¯æ€ä¹ˆå‘æŒ¥ä½œç”¨çš„ã€‚</p>
<span id="more"></span>
<h2 id="å‰è¨€">å‰è¨€</h2>
<p>æ¡ä»¶åŠ è½½<code>Condition</code>æ˜¯Spring4å¼•å…¥çš„ä¸€ä¸ªæ–°ç‰¹æ€§ï¼ŒSpring Frameworkä¸­ï¼ŒConditionåªç”¨ä¸€ä¸ªä½¿ç”¨åœºæ™¯ï¼š<code>Profile</code>ã€‚ä½†è¿›å…¥Spring Bootæ—¶ä»£ï¼ŒConditionä½œä¸º<code>autoconfigure</code>çš„æ ¸å¿ƒåŸºçŸ³ï¼Œåœ¨Spring Bootä¸­å‘æ‰¬å…‰å¤§</p>
<h2 id="Spring-Framework">Spring Framework</h2>
<h3 id="æ ¸å¿ƒç±»">æ ¸å¿ƒç±»</h3>
<p>åœ¨<code>org.springframework.context.annotation</code>ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“æ‰¾åˆ°ä¸¤ä¸ªå’Œæ¡ä»¶åŠ è½½ç›¸å…³çš„ç±»ï¼š</p>
<ul>
<li>
<p>@Conditionalï¼šæ³¨è§£ï¼Œç”¨äºæ ‡è¯†beanæ˜¯å¦éœ€è¦æ¡ä»¶åŠ è½½ï¼Œå¯¹åº”Conditionæ¥å£ç”¨äºåˆ¤æ–­æ˜¯å¦èƒ½æ¡ä»¶åŠ è½½</p>
   <pre class="line-numbers language-java" data-language="java"><code class="language-java">public @interface Conditional &#123;
    Class&lt;? extends Condition&gt;[] value();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>Conditionï¼šæ¥å£ï¼Œå…¶å®ç°ç±»å’Œ@Conditionalä¸€èµ·åˆ¤æ–­beanæ˜¯å¦æ¡ä»¶åŠ è½½ã€‚è¯¥æ¥å£æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ç”¨æˆ·è·å–åº”ç”¨ä¸Šä¸‹æ–‡çš„ç›¸å…³ä¿¡æ¯å’Œbeanå¯¹åº”çš„æ³¨è§£ä¿¡æ¯</p>
  <pre class="line-numbers language-java" data-language="java"><code class="language-java">public interface Condition &#123;
    boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ä»ConditionContextæ¥å£å¯ä»¥çœ‹å‡ºï¼Œè¯¥æ¥å£å¯ä»¥è·å–åˆ°åº”ç”¨ä¸Šä¸‹æ–‡ï¼ˆApplicationContextï¼‰ä¸­çš„å‡ ä¹æ‰€æœ‰ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å¯ä»¥ä¸ºbeanæ¡ä»¶åŠ è½½æä¾›åŸºç¡€æ•°æ®</p>
  <pre class="line-numbers language-java" data-language="java"><code class="language-java">public interface ConditionContext &#123;

    &#x2F;**
    * è·å–beanDefinitionRegistry
    *&#x2F;
    BeanDefinitionRegistry getRegistry();

    &#x2F;**
    * è·å–beanFactory
    *&#x2F;
    ConfigurableListableBeanFactory getBeanFactory();

    &#x2F;**
    * è·å–enviroment
    *&#x2F;
    Environment getEnvironment();

    &#x2F;**
    * è·å–resourceLoader
    *&#x2F;
    ResourceLoader getResourceLoader();

    &#x2F;**
    * è·å–classLoader
    *&#x2F;
    ClassLoader getClassLoader();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»AnnotatedTypeMetadataæ¥å£ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¯¥æ¥å£å¯ä»¥è·å–beanä¸Šé¢çš„æ³¨è§£ç›¸å…³ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è‡ªå·±çš„beanä¸Šæ·»åŠ åˆé€‚çš„æ³¨è§£ï¼Œä½œä¸ºbeanæ¡ä»¶åŠ è½½çš„ä¸šåŠ¡è¾“å…¥æ•°æ®</p>
  <pre class="line-numbers language-java" data-language="java"><code class="language-java">public interface AnnotatedTypeMetadata &#123;

    &#x2F;**
    * è·å–beanä¸Šçš„Annotationï¼Œå·²ç»å¤„ç†è¿‡@AliasForç­‰Springè‡ªå·±æä¾›çš„æ–¹æ³•å·¥å…·
    *&#x2F;
    MergedAnnotations getAnnotations();

    &#x2F;**
    * å¯¹åº”æ³¨è§£æ˜¯å¦å­˜åœ¨
    *&#x2F;
    default boolean isAnnotated(String annotationName) &#123;
        return getAnnotations().isPresent(annotationName);
    &#125;

    &#x2F;**
    * è·å–æ³¨è§£å±æ€§
    *&#x2F;
    @Nullable
    default Map&lt;String, Object&gt; getAnnotationAttributes(String annotationName) &#123;
        return getAnnotationAttributes(annotationName, false);
    &#125;

    &#x2F;**
    * è·å–æ³¨è§£å±æ€§
    *&#x2F;
    @Nullable
    default Map&lt;String, Object&gt; getAnnotationAttributes(String annotationName,
            boolean classValuesAsString) &#123;

        MergedAnnotation&lt;Annotation&gt; annotation &#x3D; getAnnotations().get(annotationName,
                null, MergedAnnotationSelectors.firstDirectlyDeclared());
        if (!annotation.isPresent()) &#123;
            return null;
        &#125;
        return annotation.asAnnotationAttributes(Adapt.values(classValuesAsString, true));
    &#125;
    
    &#x2F;**
    * è·å–æ³¨è§£å±æ€§
    *&#x2F;
    @Nullable
    default MultiValueMap&lt;String, Object&gt; getAllAnnotationAttributes(String annotationName) &#123;
        return getAllAnnotationAttributes(annotationName, false);
    &#125;

    &#x2F;**
    * è·å–æ³¨è§£å±æ€§
    *&#x2F;
    @Nullable
    default MultiValueMap&lt;String, Object&gt; getAllAnnotationAttributes(
            String annotationName, boolean classValuesAsString) &#123;

        Adapt[] adaptations &#x3D; Adapt.values(classValuesAsString, true);
        return getAnnotations().stream(annotationName)
                .filter(MergedAnnotationPredicates.unique(MergedAnnotation::getMetaTypes))
                .map(MergedAnnotation::withNonMergedAttributes)
                .collect(MergedAnnotationCollectors.toMultiValueMap(map -&gt;
                        map.isEmpty() ? null : map, adaptations));
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h3 id="åŸç†">åŸç†</h3>
<p>beanæ¡ä»¶åŠ è½½å’Œbeançš„å£°æ˜æ¯æ¯ç›¸å…³ï¼Œåœ¨Springä¸­ï¼Œæˆ‘ä»¬å£°æ˜ä¸€ä¸ªbeanä¸€èˆ¬æœ‰ä¸€ä¸‹å‡ ç§æ–¹å¼</p>
<ol>
<li>xmlä¸­ç›´æ¥å®šä¹‰bean</li>
<li>ä½¿ç”¨<code>@Service</code>ç­‰ï¼Œå¹¶é…ç½®beanæ‰«æ</li>
<li>ä½¿ç”¨<code>@Configuration</code>å’Œ<code>@Bean</code>ï¼Œå¹¶é…ç½®beanæ‰«æ</li>
<li>ä½¿ç”¨<code>&lt;import&gt;</code>æˆ–è€…<code>@Import</code>å¯¼å…¥</li>
</ol>
<h4 id="xmlä¸­ç›´æ¥å£°æ˜beanæˆ–è€…FactoryBean">xmlä¸­ç›´æ¥å£°æ˜beanæˆ–è€…FactoryBean</h4>
<h5 id="ç›´æ¥å£°æ˜bean">ç›´æ¥å£°æ˜bean</h5>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>xxxx<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æˆ‘ä»¬å¯ä»¥åœ¨xmlä¸­ç›´æ¥å£°æ˜beanï¼Œè¯¥æ®µxmlä¼šè¢«<code>DefaultBeanDefinitionDocumentReader</code>ä¸­çš„<code>processBeanDefinition</code>è§£æä¸ºBeanDefinitionå¹¶æ³¨å†Œåˆ°BeanFactoryä¸­ã€‚<br>
ä»ä¸‹æ–‡ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œç›´æ¥å£°æ˜æ—¶ï¼ŒSpringå¯¹Conditonæ²¡æœ‰åšä»»ä½•å¤„ç†ï¼Œæ‰€ä»¥<code>xmlç›´æ¥å£°æ˜beanï¼Œæ¡ä»¶åŠ è½½å¹¶ä¸èµ·æ•ˆ</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">protected void processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) &#123;
    &#x2F;&#x2F; ä»xmlä¸­è§£æå‡ºBeanDefinition
    BeanDefinitionHolder bdHolder &#x3D; delegate.parseBeanDefinitionElement(ele);
    if (bdHolder !&#x3D; null) &#123;
        &#x2F;&#x2F; å¤„ç†è‡ªå®šä¹‰æ ‡ç­¾
        bdHolder &#x3D; delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);
        try &#123;
            &#x2F;&#x2F; å°†beanæ³¨å†Œåˆ°BeanFactoryä¸­
            BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());
        &#125; catch (BeanDefinitionStoreException ex) &#123;
            getReaderContext().error(&quot;Failed to register bean definition with name &#39;&quot; +
                    bdHolder.getBeanName() + &quot;&#39;&quot;, ele, ex);
        &#125;
        &#x2F;&#x2F; å‘é€beanæ³¨å†Œäº‹ä»¶
        getReaderContext().fireComponentRegistered(new BeanComponentDefinition(bdHolder));
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="ç›´æ¥å£°æ˜FactoryBean">ç›´æ¥å£°æ˜FactoryBean</h5>
<h4 id="ä½¿ç”¨-Serviceï¼Œå¹¶é…ç½®Conditon">ä½¿ç”¨@Serviceï¼Œå¹¶é…ç½®Conditon</h4>
<p>åœ¨ä»£ç ä¸­ä½¿ç”¨ä½¿ç”¨äº†@Serviceæ³¨è§£ï¼Œè¿™æ—¶@Conditonalä¸€å®šæ˜¯é…ç½®åœ¨Classä¸Šçš„ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬åœ¨æ‰«æbeanæ—¶å°±å¯ä»¥çŸ¥é“è¿™ä¸ªbeanæ˜¯å¦æ—¶éœ€è¦åŠ è½½çš„bean<br>
Springä¸­beanæ‰«æä¸€èˆ¬ç”±ä¸¤ç§æ–¹å¼</p>
<ul>
<li>&lt;context:component-scan/&gt;</li>
<li>@ComponentScan</li>
</ul>
<h5 id="context-component-scan">&lt;context:component-scan/&gt;</h5>
<p><code>&lt;context:component-scan/&gt;</code>æ˜¯Springå®šä¹‰çš„åå­—ç©ºé—´ï¼Œè¯¥åå­—ç©ºé—´ç”±<code>ComponentScanBeanDefinitionParser</code>å¤„ç†ï¼Œå¹¶ä¸”ä½¿ç”¨<code>ClassPathBeanDefinitionScanner</code>æ‰«ææ‰€æœ‰bean</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public BeanDefinition parse(Element element, ParserContext parserContext) &#123;
    &#x2F;&#x2F; åŒ…è·¯å¾„
    String basePackage &#x3D; element.getAttribute(BASE_PACKAGE_ATTRIBUTE);
    basePackage &#x3D; parserContext.getReaderContext().getEnvironment().resolvePlaceholders(basePackage);
    String[] basePackages &#x3D; StringUtils.tokenizeToStringArray(basePackage,
            ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);
    &#x2F;&#x2F; é…ç½®æ‰«æå™¨
    ClassPathBeanDefinitionScanner scanner &#x3D; configureScanner(parserContext, element);
    &#x2F;&#x2F; æ‰«æbean
    Set&lt;BeanDefinitionHolder&gt; beanDefinitions &#x3D; scanner.doScan(basePackages);
    &#x2F;&#x2F; æ³¨å†Œbean
    registerComponents(parserContext.getReaderContext(), beanDefinitions, element);

    return null;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ¥ç€è·Ÿè¸ªä¸‹å»ï¼Œåœ¨æ‰«æå™¨æ‰«æComponentsä¸­ï¼Œæœ‰ä¸€æ®µé€»è¾‘<code>isCandidateComponent(metadataReader)</code>ï¼Œè¿™ä¸ªé€»è¾‘åœ¨è¿‡æ»¤æ‰«æå‡ºæ¥çš„Classæ˜¯å¦è¦æ³¨å†Œä¸ºBeanDefinitionã€‚å› ä¸ºcomponent-scanæœ¬èº«æ˜¯æœ‰filterçš„ï¼ŒåŒæ—¶Conditionä¹Ÿæ˜¯åœ¨è¿™é‡Œé¢å¤„ç†çš„</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; æ‰«æBeanDefinitionï¼Œå»é™¤æ— å…³ä»£ç 
private Set&lt;BeanDefinition&gt; scanCandidateComponents(String basePackage) &#123;
    Set&lt;BeanDefinition&gt; candidates &#x3D; new LinkedHashSet&lt;&gt;();
    String packageSearchPath &#x3D; ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +
            resolveBasePackage(basePackage) + &#39;&#x2F;&#39; + this.resourcePattern;
    Resource[] resources &#x3D; getResourcePatternResolver().getResources(packageSearchPath);
    for (Resource resource : resources) &#123;
        try &#123;
            MetadataReader metadataReader &#x3D; getMetadataReaderFactory().getMetadataReader(resource);
            &#x2F;&#x2F; åˆ¤æ–­æ˜¯å¦è¦åŠ å…¥BeanDefinition
            if (isCandidateComponent(metadataReader)) &#123;
                ScannedGenericBeanDefinition sbd &#x3D; new ScannedGenericBeanDefinition(metadataReader);
                sbd.setSource(resource);
                if (isCandidateComponent(sbd)) &#123;
                    candidates.add(sbd);
                &#125;
            &#125;
        &#125; catch (FileNotFoundException ex) &#123;
        &#125; catch (Throwable ex) &#123;
        &#125;
    &#125;
    return candidates;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿›å…¥<code>isCandidateComponent</code>é€»è¾‘</p>
<ol>
<li>è¢«excludeFilterså‘½ä¸­ï¼Œç›´æ¥pass</li>
<li>è¢«includeFilterså‘½ä¸­ï¼Œå†æ£€æŸ¥condition</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">protected boolean isCandidateComponent(MetadataReader metadataReader) throws IOException &#123;
    for (TypeFilter tf : this.excludeFilters) &#123;
        &#x2F;&#x2F; è¢«excludeFilterså‘½ä¸­ï¼Œç›´æ¥pass
        if (tf.match(metadataReader, getMetadataReaderFactory())) &#123;
            return false;
        &#125;
    &#125;
    for (TypeFilter tf : this.includeFilters) &#123;
        if (tf.match(metadataReader, getMetadataReaderFactory())) &#123;
            &#x2F;&#x2F; è¢«includeFilterså‘½ä¸­ï¼Œå†æ£€æŸ¥condition
            return isConditionMatch(metadataReader);
        &#125;
    &#125;
    return false;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿›å…¥<code>isConditionMatch</code>ï¼ŒConditionçš„å¤„ç†è¿›å…¥äº†çœ¼å¸˜ï¼Œè¿™é‡Œæœ‰ä¸ª<code>ConfigurationPhase</code>å®šä¹‰äº†è§£æçš„ç±»å‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">private boolean isConditionMatch(MetadataReader metadataReader) &#123;
    if (this.conditionEvaluator &#x3D;&#x3D; null) &#123;
        this.conditionEvaluator &#x3D;
                new ConditionEvaluator(getRegistry(), this.environment, this.resourcePatternResolver);
    &#125;
    return !this.conditionEvaluator.shouldSkip(metadataReader.getAnnotationMetadata());
&#125;

public boolean shouldSkip(@Nullable AnnotatedTypeMetadata metadata, @Nullable ConfigurationPhase phase) &#123;
    if (metadata &#x3D;&#x3D; null || !metadata.isAnnotated(Conditional.class.getName())) &#123;
        return false;
    &#125;

    if (phase &#x3D;&#x3D; null) &#123;
        if (metadata instanceof AnnotationMetadata &amp;&amp;
                ConfigurationClassUtils.isConfigurationCandidate((AnnotationMetadata) metadata)) &#123;
            return shouldSkip(metadata, ConfigurationPhase.PARSE_CONFIGURATION);
        &#125;
        return shouldSkip(metadata, ConfigurationPhase.REGISTER_BEAN);
    &#125;

    List&lt;Condition&gt; conditions &#x3D; new ArrayList&lt;&gt;();
    for (String[] conditionClasses : getConditionClasses(metadata)) &#123;
        for (String conditionClass : conditionClasses) &#123;
            Condition condition &#x3D; getCondition(conditionClass, this.context.getClassLoader());
            conditions.add(condition);
        &#125;
    &#125;

    AnnotationAwareOrderComparator.sort(conditions);

    for (Condition condition : conditions) &#123;
        ConfigurationPhase requiredPhase &#x3D; null;
        if (condition instanceof ConfigurationCondition) &#123;
            requiredPhase &#x3D; ((ConfigurationCondition) condition).getConfigurationPhase();
        &#125;
        if ((requiredPhase &#x3D;&#x3D; null || requiredPhase &#x3D;&#x3D; phase) &amp;&amp; !condition.matches(this.context, metadata)) &#123;
            return true;
        &#125;
    &#125;

    return false;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="1-2-2-2-ComponentScan">1.2.2.2 @ComponentScan</h5>
<p>@ComponentScanåœ¨Springä¸­å¤„ç†æ—¶æœºä¸º<code>invokeBeanFactoryPostProcessors</code>ï¼Œç”±<code>ConfigurationClassPostProcessor</code>å¤„ç†çš„ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public void processConfigBeanDefinitions(BeanDefinitionRegistry registry) &#123;
    &#x2F;&#x2F; æ³¨é‡Šå†™ç€è§£ææ‰€æœ‰@Configurationç±»ï¼Œä½†è¿™é‡ŒæŠŠæ‰€æœ‰beanéƒ½è§£æå‡ºæ¥äº†
    ConfigurationClassParser parser &#x3D; new ConfigurationClassParser(
            this.metadataReaderFactory, this.problemReporter, this.environment,
            this.resourceLoader, this.componentScanBeanNameGenerator, registry);

    Set&lt;BeanDefinitionHolder&gt; candidates &#x3D; new LinkedHashSet&lt;&gt;(configCandidates);
    Set&lt;ConfigurationClass&gt; alreadyParsed &#x3D; new HashSet&lt;&gt;(configCandidates.size());
    do &#123;
        StartupStep processConfig &#x3D; this.applicationStartup.start(&quot;spring.context.config-classes.parse&quot;);
        &#x2F;&#x2F; è§£ææ‰€æœ‰bean
        parser.parse(candidates);
        parser.validate();
    &#125;while (!candidates.isEmpty());
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨parserè¿‡ç¨‹ä¸­ï¼Œå¤„ç†@ComponentScansæœ‰å¯¹Conditionå¤„ç†</p>
<ul>
<li>åˆ¤æ–­@ComponentScansä¸Šæ˜¯å¦æœ‰Conditionï¼Œå¦‚æœä¸ç”Ÿæ•ˆç›´æ¥è·³è¿‡è¯¥@ComponentScans</li>
<li>å¦‚æœè¯¥@ComponentScansæœ‰æ•ˆï¼Œä½¿ç”¨ComponentScanAnnotationParserå¯¹beanè¿›è¡Œæ‰«æ</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">protected final SourceClass doProcessConfigurationClass(
        ConfigurationClass configClass, SourceClass sourceClass, Predicate&lt;String&gt; filter)
        throws IOException &#123;
    &#x2F;&#x2F; å¤„ç†@ComponentScans
    Set&lt;AnnotationAttributes&gt; componentScans &#x3D; AnnotationConfigUtils.attributesForRepeatable(
            sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);
    &#x2F;&#x2F; åˆ¤æ–­@ComponentScansä¸Šæ˜¯å¦æœ‰Conditionç”Ÿæ•ˆ
    if (!componentScans.isEmpty() &amp;&amp;
            !this.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;
        for (AnnotationAttributes componentScan : componentScans) &#123;
            &#x2F;&#x2F; å¯¹@ComponentScansæ‰§è¡Œæ‰«æï¼Œæ‰«æç±»ï¼šComponentScanAnnotationParser
            Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions &#x3D;
                    this.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());
            for (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;
                BeanDefinition bdCand &#x3D; holder.getBeanDefinition().getOriginatingBeanDefinition();
                if (bdCand &#x3D;&#x3D; null) &#123;
                    bdCand &#x3D; holder.getBeanDefinition();
                &#125;
                if (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, this.metadataReaderFactory)) &#123;
                    parse(bdCand.getBeanClassName(), holder.getBeanName());
                &#125;
            &#125;
        &#125;
    &#125;

    return null;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿›ä¸€æ­¥è·Ÿè¸ªé€»è¾‘ï¼Œ<code>ComponentScanAnnotationParser.parser</code>æ ¸å¿ƒè¿˜æ˜¯é‡‡ç”¨çš„<a href="#1221-contextcomponent-scan">1.2.1 contextcomponent-scan</a>ä¸­åŒæ ·çš„<code>ClassPathBeanDefinitionScanner</code>ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public Set&lt;BeanDefinitionHolder&gt; parse(AnnotationAttributes componentScan, String declaringClass) &#123;
    ClassPathBeanDefinitionScanner scanner &#x3D; new ClassPathBeanDefinitionScanner(this.registry,
            componentScan.getBoolean(&quot;useDefaultFilters&quot;), this.environment, this.resourceLoader);
    &#x2F;&#x2F; scanneré…ç½®åˆå§‹åŒ–
    return scanner.doScan(StringUtils.toStringArray(basePackages));
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="ä½¿ç”¨-Configurationå’Œ-Beanï¼Œå¹¶é…ç½®Conditon">ä½¿ç”¨@Configurationå’Œ@Beanï¼Œå¹¶é…ç½®Conditon</h4>
<p>æˆ‘ä»¬åœ¨ä½¿ç”¨Configurationæ—¶ï¼Œä¸€èˆ¬æ—¶é…åˆ@Beanä½¿ç”¨çš„ï¼Œè¿™æ ·Conditonå°±ä¼šæœ‰ä¸¤ç§ä½¿ç”¨å¸¸è§</p>
<ul>
<li>å’Œ@Configurationä¸€èµ·é…ç½®åœ¨Classä¸Š</li>
<li>å’Œ@Beanä¸€èµ·é…ç½®åœ¨Methodä¸Š</li>
</ul>
<h5 id="é…ç½®åœ¨Classä¸Š">é…ç½®åœ¨Classä¸Š</h5>
<p>å½“Condtioné…ç½®åœ¨Classä¸Šæ—¶ï¼Œè¿™ä¸ªé—®é¢˜å·²ç»é€€åŒ–ä¸ºäº†<a href="#122-%E4%BD%BF%E7%94%A8service%E5%B9%B6%E9%85%8D%E7%BD%AEconditon">beanä¸Šé¢é…ç½®Condition</a>ï¼Œå› ä¸º@Configurationçš„æœ¬è´¨ä¹Ÿæ˜¯ä¸€ä¸ªå¹¶ï¼Œå½“ä¸æ»¡è¶³æ¡ä»¶æ—¶ï¼Œè¿™ä¸ª@Configurationéƒ½ä¸ä¼šè¢«Springæ‰«æå‡ºæ¥</p>
<h5 id="é…ç½®åœ¨Methodä¸Š">é…ç½®åœ¨Methodä¸Š</h5>
<p>å½“æ¡ä»¶é…ç½®åˆ°Methodä¸Šæ—¶ï¼Œè¿™ä¸ªé—®é¢˜ç±»ä¼¼äº<a href="#1222-componentscan">@ComponentScanæ‰«æbean</a>ï¼Œåªæ˜¯å¤„ç†çš„æ—¶æœºä¸åŒã€‚</p>
<ul>
<li>@ComponentScanæ‰«æbeanæ—¶ï¼Œåœ¨æ‰«æè¿‡ç¨‹ä¸­å°±ä¼šé€šè¿‡æ¡ä»¶è¿‡æ»¤bean</li>
<li>å½“æ¡ä»¶é…ç½®åœ¨Methodä¸Šæ—¶ï¼Œbeanæ‰«æè¿‡ç¨‹ä¸ä¼šæœ‰é—®é¢˜ï¼Œè¿‡æ»¤beançš„è¿‡ç¨‹æ˜¯å‘ç”Ÿåœ¨åŠ è½½beançš„è¿‡ç¨‹ä¸­</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public void processConfigBeanDefinitions(BeanDefinitionRegistry registry) &#123;
    &#x2F;&#x2F; æ³¨é‡Šå†™ç€è§£ææ‰€æœ‰@Configurationç±»ï¼Œä½†è¿™é‡ŒæŠŠæ‰€æœ‰beanéƒ½è§£æå‡ºæ¥äº†
    ConfigurationClassParser parser &#x3D; new ConfigurationClassParser(
            this.metadataReaderFactory, this.problemReporter, this.environment,
            this.resourceLoader, this.componentScanBeanNameGenerator, registry);

    Set&lt;BeanDefinitionHolder&gt; candidates &#x3D; new LinkedHashSet&lt;&gt;(configCandidates);
    Set&lt;ConfigurationClass&gt; alreadyParsed &#x3D; new HashSet&lt;&gt;(configCandidates.size());
    do &#123;
        StartupStep processConfig &#x3D; this.applicationStartup.start(&quot;spring.context.config-classes.parse&quot;);
        &#x2F;&#x2F; è§£ææ‰€æœ‰bean
        parser.parse(candidates);
        parser.validate();

        Set&lt;ConfigurationClass&gt; configClasses &#x3D; new LinkedHashSet&lt;&gt;(parser.getConfigurationClasses());
        configClasses.removeAll(alreadyParsed);

        if (this.reader &#x3D;&#x3D; null) &#123;
            this.reader &#x3D; new ConfigurationClassBeanDefinitionReader(
                    registry, this.sourceExtractor, this.resourceLoader, this.environment,
                    this.importBeanNameGenerator, parser.getImportRegistry());
        &#125;
        &#x2F;&#x2F; @Beanåœ¨åŠ è½½beançš„è¿‡ç¨‹ä¸­è¿‡æ»¤æ¡ä»¶
        this.reader.loadBeanDefinitions(configClasses);
    &#125;
    while (!candidates.isEmpty());
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">private void loadBeanDefinitionsForConfigurationClass(
        ConfigurationClass configClass, TrackedConditionEvaluator trackedConditionEvaluator) &#123;

    if (trackedConditionEvaluator.shouldSkip(configClass)) &#123;
        String beanName &#x3D; configClass.getBeanName();
        if (StringUtils.hasLength(beanName) &amp;&amp; this.registry.containsBeanDefinition(beanName)) &#123;
            this.registry.removeBeanDefinition(beanName);
        &#125;
        this.importRegistry.removeImportingClass(configClass.getMetadata().getClassName());
        return;
    &#125;

    if (configClass.isImported()) &#123;
        registerBeanDefinitionForImportedConfigurationClass(configClass);
    &#125;
    for (BeanMethod beanMethod : configClass.getBeanMethods()) &#123;
        &#x2F;&#x2F; å¤„ç†@Bean
        loadBeanDefinitionsForBeanMethod(beanMethod);
    &#125;

    loadBeanDefinitionsFromImportedResources(configClass.getImportedResources());
    loadBeanDefinitionsFromRegistrars(configClass.getImportBeanDefinitionRegistrars());
&#125;

private void loadBeanDefinitionsForBeanMethod(BeanMethod beanMethod) &#123;
    ConfigurationClass configClass &#x3D; beanMethod.getConfigurationClass();
    MethodMetadata metadata &#x3D; beanMethod.getMetadata();
    String methodName &#x3D; metadata.getMethodName();

    &#x2F;&#x2F; è¿›æ¥å…ˆåˆ¤æ–­æ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼Œä¸æ»¡è¶³ç›´æ¥è·³è¿‡
    if (this.conditionEvaluator.shouldSkip(metadata, ConfigurationPhase.REGISTER_BEAN)) &#123;
        configClass.skippedBeanMethods.add(methodName);
        return;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ä½¿ç”¨ç¤ºä¾‹">ä½¿ç”¨ç¤ºä¾‹</h3>
<p>é€šè¿‡æ ¸å¿ƒç±»å’ŒåŸç†çš„è¯´æ˜ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“çŸ¥é“äº†æ€ä¹ˆåœ¨Springä¸­ä½¿ç”¨Conditonã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå°ç¤ºä¾‹æ¥ç¤ºèŒƒä¸‹å¦‚ä½•ä½¿ç”¨Condition</p>
<blockquote>
<p>å¾ˆå¤šä¸šåŠ¡åœ¨windowså’Œlinuxçš„ä½¿ç”¨æ–¹æ³•æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¦‚epollå’Œselect</p>
<p>å…¶ä¸­ï¼šepollåœ¨Linuxä¸‹ä½¿ç”¨ï¼Œselectåœ¨windowsä¸‹ä½¿ç”¨ã€‚</p>
<p>åœ¨ä¸šåŠ¡ä¸­ï¼Œæˆ‘ä»¬æœŸæœ›æ ¹æ®ä¸åŒçš„ç³»ç»Ÿé€‰æ‹©åŠ è½½ä¸åŒçš„Serviceæ¥ä¸ºIOæœåŠ¡</p>
</blockquote>
<p>æ ¹æ®ä¹‹å‰çš„å™è¿°ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºä¸¤ä¸ªAnnotationï¼Œ<code>ConditionalOnLinux</code>å’Œ<code>ConditionalOnWindows</code>åˆ†åˆ«æ‰“ä¸Šåœ¨Linuxä¸‹è¿è¡Œå’ŒWindownsä¸‹è¿è¡Œçš„æ ‡è¯†ã€‚</p>
<p>è¿™ä¸¤ä¸ªAnnotaionéƒ½ç»§æ‰¿äº†<code>@Conditional</code>å¹¶ä¸”å£°æ˜äº†ä½¿ç”¨<code>OsCondition.class</code>ä½œä¸ºåˆ¤åˆ«ç±»</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">@Documented
@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)
@Retention(RetentionPolicy.RUNTIME)
@Conditional(OsCondition.class)
public @interface ConditionalOnLinux &#123;
&#125;

@Documented
@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)
@Retention(RetentionPolicy.RUNTIME)
@Conditional(OsCondition.class)
public @interface ConditionalOnWindows &#123;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åŒæ—¶æˆ‘ä»¬å¯ä»¥å®ç°<code>OsCondition</code>ï¼Œé…åˆ<code>ConditionalOnWindows</code>å’Œ<code>ConditionalOnLinux</code>å®ç°æ¡ä»¶åŠ è½½</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public class OsCondition implements Condition &#123;

    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) &#123;
        String os &#x3D; System.getProperty(&quot;os.name&quot;);
        &#x2F;&#x2F; æ˜¯å¦åœ¨windownsä¸­å¯åŠ¨
        boolean isWindow &#x3D; StringUtils.startsWithIgnoreCase(os, &quot;win&quot;);
        &#x2F;&#x2F; æ˜¯å¦åœ¨Linuxä¸­å¯åŠ¨
        boolean isLinux &#x3D; StringUtils.equalsIgnoreCase(os, &quot;Linux&quot;);
        &#x2F;&#x2F; windownsä¸­å¯åŠ¨ï¼Œè€Œä¸”æ ‡æ˜äº†ConditionalOnWindowsï¼Œé€‰ä¸­bean
        if (isWindow &amp;&amp; metadata.getAnnotations().isPresent(ConditionalOnWindows.class)) &#123;
            return true;
        &#125;
        &#x2F;&#x2F; Linuxä¸­å¯åŠ¨ï¼Œè€Œä¸”æ ‡æ˜äº†ConditionalOnLinuxï¼Œé€‰ä¸­bean
        if (isLinux &amp;&amp; metadata.getAnnotations().isPresent(ConditionalOnLinux.class)) &#123;
            return true;
        &#125;
        return false;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ‰äº†<code>OsCondition</code>ã€<code>ConditionalOnWindows</code>å’Œ<code>ConditionalOnLinux</code>è¿™ä¸‰æ ·å·¥å…·ï¼Œå°±å¯ä»¥å®ç°è¿è¡Œç¯èŠ‚ä¸åŒï¼ŒåŠ è½½ä¸åŒbean</p>
<blockquote>
<p>é€šè¿‡åŸç†åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸¤ç§å¸¸è§çš„Conditionä½¿ç”¨æ–¹å¼</p>
</blockquote>
<h4 id="ç›´æ¥åœ¨beanä¸Šæ·»åŠ æ³¨è§£">ç›´æ¥åœ¨beanä¸Šæ·»åŠ æ³¨è§£</h4>
<p>ä½¿ç”¨æ¡ä»¶åŠ è½½ååˆ†ç®€å•ï¼Œåªéœ€è¦åœ¨æˆ‘ä»¬è¦ä½¿ç”¨çš„beançš„ç±»ä¸ŠåŠ ä¸Šå¯¹åº”çš„æ³¨è§£å³å¯</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">@Service
@ConditionalOnWindows
public class WindowsService &#123;
&#125;

@Service
@ConditionalOnLinux
public class LinuxService &#123;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="åœ¨Confguationç±»ä¸Šæ·»åŠ æ³¨è§£">åœ¨Confguationç±»ä¸Šæ·»åŠ æ³¨è§£</h4>
<p>å¦‚æœä½¿ç”¨çš„æ˜¯<code>@Configuration</code>è¿™ç§æ–¹æ³•å®šä¹‰çš„beanï¼Œåªéœ€è¦åœ¨å¯¹åº”çš„<code>@Configuration</code>æˆ–<code>@Bean</code>ä¸ŠåŠ ä¸Šå¯¹åº”çš„æ³¨è§£å³å¯</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public class WindowsService &#123;
&#125;

public class LinuxService &#123;
&#125;

@Configuration
public class OsConfiguration &#123;
    @Bean
    @ConditionalOnWindows
    public WindowsService windowsService()&#123;
        return new WindowsService();
    &#125;

    @Bean
    @ConditionalOnLinux
    public LinuxService linuxService()&#123;
        return new LinuxService();
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Spring-Boot">Spring Boot</h2>
<p>Spring Bootçš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼š<code>çº¦å®šä¼˜äºé…ç½®</code>ã€‚è¯¥ç‰¹æ€§æ˜¯<code>spring-boot-autoconfigure</code>æä¾›çš„ï¼Œè€Œspring-boot-autoconfigureè¢«Spring Bootçš„åŸºç¡€åŒ…<code>spring-boot-starter</code>æ‰€ä¾èµ–</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">+- org.springframework.boot:spring-boot-starter:jar:2.7.9:compile
|  +- org.springframework.boot:spring-boot:jar:2.7.9:compile
|  |  \- org.springframework:spring-context:jar:5.3.25:compile
|  |     +- org.springframework:spring-aop:jar:5.3.25:compile
|  |     +- org.springframework:spring-beans:jar:5.3.25:compile
|  |     \- org.springframework:spring-expression:jar:5.3.25:compile
|  +- org.springframework.boot:spring-boot-autoconfigure:jar:2.7.9:compile
|  +- org.springframework.boot:spring-boot-starter-logging:jar:2.7.9:compile
|  |  +- ch.qos.logback:logback-classic:jar:1.2.11:compile
|  |  |  \- ch.qos.logback:logback-core:jar:1.2.11:compile
|  |  +- org.apache.logging.log4j:log4j-to-slf4j:jar:2.17.2:compile
|  |  |  \- org.apache.logging.log4j:log4j-api:jar:2.17.2:compile
|  |  \- org.slf4j:jul-to-slf4j:jar:1.7.36:compile
|  +- jakarta.annotation:jakarta.annotation-api:jar:1.3.5:compile
|  +- org.springframework:spring-core:jar:5.3.25:compile
|  |  \- org.springframework:spring-jcl:jar:5.3.25:compile
|  \- org.yaml:snakeyaml:jar:1.30:compile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨è®©æˆ‘ä»¬è¯¦ç»†æ‹†è§£<code>spring-boot-autoconfigure</code></p>
<h3 id="spring-boot-autoconfigureè§£è¯»">spring-boot-autoconfigureè§£è¯»</h3>
<p>spring-boot-autoconfigureä¸»è¦æä¾›ä»¥ä¸‹å››éƒ¨åˆ†å†…å®¹</p>
<ul>
<li>æ¡ä»¶åŠ è½½ä½¿èƒ½ä¸ç›¸å…³é…ç½®</li>
<li>Conditionå¢å¼º</li>
<li>IOCä¸­è‡ªåŠ¨beanåŠ è½½</li>
<li>å¸¸ç”¨ä¸‰æ–¹ä¾èµ–starter</li>
</ul>
<h4 id="æ¡ä»¶åŠ è½½ä½¿èƒ½ä¸ç›¸å…³é…ç½®">æ¡ä»¶åŠ è½½ä½¿èƒ½ä¸ç›¸å…³é…ç½®</h4>
<p>æˆ‘ä»¬ç›´æ¥æ‰¾åˆ°<code>org.springframework.boot.autoconfigure</code>åŒ…ï¼ŒæŸ¥çœ‹é‡Œé¢çš„ç±»ï¼Œå‘ç°äº†ä¸å°‘è€æœ‹å‹</p>
<table>
<thead>
<tr>
<th>æ³¨è§£</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>@SpringBootApplication</td>
<td>æ¯ä¸ªSpring Bootå·¥ç¨‹ä¸­å¯ä»¥çœ‹åˆ°</td>
</tr>
<tr>
<td>@EnableAutoConfiguration</td>
<td>è¢«@SpringBootApplicationç»§æ‰¿ï¼Œä½¿èƒ½Spring Bootçš„è‡ªåŠ¨é…ç½®åŠŸèƒ½ï¼Œç”±AutoConfigurationImportSelectorå¤„ç†</td>
</tr>
<tr>
<td>@AutoConfiguration</td>
<td>Spring Bootæä¾›çš„é…ç½®æ³¨è§£ï¼ŒåŠŸèƒ½åŒ@Configurationï¼Œåªæ˜¯ç»„åˆäº†@AutoConfigureBeforeï¼Œ@AutoConfigureAfterç”¨äºè®¾ç½®é…ç½®åŠ è½½é¡ºåº</td>
</tr>
<tr>
<td>@AutoConfiguration</td>
<td>æŒ‡å®šé…ç½®é¡ºåº</td>
</tr>
<tr>
<td>@AutoConfigurationPackage</td>
<td>é…ç½®@Configurationçš„æ‰«æåŒ…ï¼Œç”±AutoConfigrationPackages.Registrarå¤„ç†</td>
</tr>
<tr>
<td>@ImportAutoConfiguration</td>
<td>åŸºæœ¬åŒ@Importï¼Œç”±ImportAutoConfigurationImportSelectorå¤„ç†ï¼Œå…·ä½“åŒºåˆ«å¯è§å¦æ–‡è¯¦ç»†è®²è®²</td>
</tr>
</tbody>
</table>
<h4 id="Conditionå¢å¼º">Conditionå¢å¼º</h4>
<p>Spring Frameworkä¸­åªæä¾›äº†ä¸€ä¸ªConditionæ¥å£å’Œä¸€ä¸ª@Profileçš„å®ç°ã€‚åœ¨spring-boot-autoconfigureæä¾›äº†å¦‚ä¸‹æ³¨è§£ï¼Œå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬çš„å¼€å‘</p>
<table>
<thead>
<tr>
<th>æ³¨è§£</th>
<th>å¤„ç†ç±»</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>@ConditionalOnBean</td>
<td>OnBeanCondition</td>
<td>åªæœ‰å½“æŒ‡å®šçš„æ‰€æœ‰beanå‡å·²ç»åŒ…å«åœ¨BeanFactoryä¸­æ—¶æ‰åŒ¹é…</td>
</tr>
<tr>
<td>@ConditionalOnClass</td>
<td>OnClassCondition</td>
<td>åªæœ‰å½“æŒ‡å®šçš„æ‰€æœ‰classå‡å·²ç»åŒ…å«åœ¨classpathä¸­æ—¶æ‰åŒ¹é…</td>
</tr>
<tr>
<td>@ConditionalOnCloudPlatform</td>
<td>OnCloudPlatformCondition</td>
<td>æŒ‡å®šäº‘å¹³å°activeæ—¶æ‰åŒ¹é…ï¼Œæä¾›ç»™Spring Cloudä½¿ç”¨</td>
</tr>
<tr>
<td>@ConditionalOnExpression</td>
<td>OnExpressionCondition</td>
<td>å½“æŒ‡å®šçš„SpELè¡¨è¾¾å¼ä¸ºtrueæ—¶æ‰åŒ¹é…</td>
</tr>
<tr>
<td>@ConditionalOnJava</td>
<td>OnJavaCondition</td>
<td>å½“JREçš„ç‰ˆæœ¬åœ¨æŒ‡å®šèŒƒå›´å†…æ—¶æ‰åŒ¹é…</td>
</tr>
<tr>
<td>@ConditionalOnJndi</td>
<td>OnJndiCondition</td>
<td>å½“JNDIå­˜åœ¨æ—¶æ‰åŒ¹é…</td>
</tr>
<tr>
<td>@ConditionalOnMissingBean</td>
<td>OnBeanCondition</td>
<td>åªæœ‰å½“æŒ‡å®šçš„æ‰€æœ‰beanå‡æ²¡æœ‰åŒ…å«åœ¨BeanFactoryä¸­æ—¶æ‰åŒ¹é…</td>
</tr>
<tr>
<td>@ConditionalOnMissingClass</td>
<td>OnClassCondition</td>
<td>åªæœ‰å½“æŒ‡å®šçš„æ‰€æœ‰classå‡æ²¡æœ‰åŒ…å«åœ¨classpathä¸­æ—¶æ‰åŒ¹é…</td>
</tr>
<tr>
<td>@ConditionalOnNotWebApplication</td>
<td>OnWebApplicationCondition</td>
<td>å½“å¯åŠ¨å®¹å™¨ä¸æ˜¯WEBå®¹å™¨æ—¶æ‰åŒ¹é…</td>
</tr>
<tr>
<td>@ConditionalOnWebApplication</td>
<td>OnWebApplicationCondition</td>
<td>å½“å¯åŠ¨å®¹å™¨æ˜¯WEBå®¹å™¨æ—¶æ‰åŒ¹é…</td>
</tr>
<tr>
<td>@ConditionalOnProperty</td>
<td>OnPropertyCondition</td>
<td>å½“å­˜åœ¨æŒ‡å®šçš„propertyæ—¶æ‰åŒ¹é…</td>
</tr>
<tr>
<td>@ConditionalOnResource</td>
<td>OnResourceCondition</td>
<td>å½“æŒ‡å®šèµ„æºåœ¨classpathä¸‹å­˜åœ¨æ‰åŒ¹é…</td>
</tr>
<tr>
<td>@ConditionalOnSingleCandidate</td>
<td>OnBeanCondition</td>
<td>å½“æŒ‡å®šçš„beanåœ¨BeanFatoryé‡Œé¢åªæœ‰ä¸€ä¸ªæ—¶æ‰åŒ¹é…</td>
</tr>
<tr>
<td>@ConditionalOnWarDeployment</td>
<td>OnWarDeploymentCondition</td>
<td>å½“åº”ç”¨ä½¿ç”¨waréƒ¨ç½²æ—¶æ‰åŒ¹é…</td>
</tr>
</tbody>
</table>
<h4 id="IOCä¸­beanæ¡ä»¶åŠ è½½">IOCä¸­beanæ¡ä»¶åŠ è½½</h4>
<p>é€šè¿‡å¯¹å¤„ç†ç±»çš„åˆ†æï¼Œæˆ‘ä»¬å¾—åˆ°ä¾èµ–å…³ç³»å›¾,ä»ä¾èµ–å…³ç³»ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†ä»¥ä¸‹æŠ½è±¡æ ¸å¿ƒç±»ï¼ŒSpring Bootçš„Conditionéƒ½æ˜¯å®ç°è¿™ä¸¤æŠ½è±¡ç±»</p>
<ul>
<li>SpringBootCondition
<ul>
<li><img src="/posts/a7ee6b02/SpringBootConditon.svg" alt="SpringBootCondition"></li>
</ul>
</li>
<li>FilteringSpringBootConditon
<ul>
<li><img src="/posts/a7ee6b02/FilterSpringBootConditon.svg" alt="FilteringSpringBootConditon"></li>
</ul>
</li>
</ul>
<h5 id="SpringBootCondition">SpringBootCondition</h5>
<p>SpringBootConditionæ˜¯å¯¹Conditionçš„ç®€å•å°è£…ï¼Œé€»è¾‘ä¸Šé‡å†™äº†Conditionçš„matchæ–¹æ³•ï¼Œè¿™è¯´æ˜SpringBootConditionå¯¹beanåŠ è½½çš„å‡ºæ¥æ˜¯å’ŒSrping Frameworkæ˜¯ä¸€è‡´çš„</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public final boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) &#123;
    String classOrMethodName &#x3D; getClassOrMethodName(metadata);
    try &#123;
        &#x2F;&#x2F; è·å–ConditionOutcomeï¼ŒgetMatchOutcomeæ—¶æŠ½è±¡æ–¹æ³•ï¼Œéœ€è¦å„ä¸ªå­ç±»å»å®ç°
        ConditionOutcome outcome &#x3D; getMatchOutcome(context, metadata);
        &#x2F;&#x2F; æ‰“å°traceæ—¥å¿—
        logOutcome(classOrMethodName, outcome);
        &#x2F;&#x2F; è®°å½•åŒ¹é…ä¿¡æ¯
        recordEvaluation(context, classOrMethodName, outcome);
        return outcome.isMatch();
    &#125;
    catch (NoClassDefFoundError ex) &#123;
        throw new IllegalStateException(&quot;Could not evaluate condition on &quot; + classOrMethodName + &quot; due to &quot;
                + ex.getMessage() + &quot; not found. Make sure your own configuration does not rely on &quot;
                + &quot;that class. This can also happen if you are &quot;
                + &quot;@ComponentScanning a springframework package (e.g. if you &quot;
                + &quot;put a @ComponentScan in the default package by mistake)&quot;, ex);
    &#125;
    catch (RuntimeException ex) &#123;
        throw new IllegalStateException(&quot;Error processing condition on &quot; + getName(metadata), ex);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>SpringBootConditionå¼•å…¥äº†ä¸€ä¸ªæ–°çš„ç±»<code>ConditionOutcome</code>ï¼Œç”±ConditionOutcomeæ‰¿æ¥äº†matchä¿¡æ¯ï¼ŒSpringBootConditionå‰©ä¸‹çš„é€»è¾‘åŸºæœ¬æ˜¯åœ¨æ‰“æ—¥å¿—å’Œè®°å½•åŒ¹é…ä¿¡æ¯ä¸Š<br>
æ‰“å¼€å¯¹åº”çš„<code>ConditionOutcome</code>ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒConditionOutcomeé‡Œé¢å¹¶æ²¡æœ‰ä»€ä¹ˆé€»è¾‘ï¼Œåªæ˜¯å¯¹åŒ¹é…ä¿¡æ¯çš„è®°å½•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; è®°å½•æ˜¯å¦åŒ¹é…å’Œå¯¹åº”çš„message
public class ConditionOutcome &#123;

    private final boolean match;

    private final ConditionMessage message;
&#125;

public final class ConditionMessage &#123;

    private final String message;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬ä½¿ç”¨Spring Bootæ—¶ï¼Œå¦‚æœæ‰“å¼€debugæ—¥å¿—ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°<code>recordEvaluation</code>è®°å½•çš„ä¿¡æ¯</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
CONDITIONS EVALUATION REPORT
&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;


Positive matches:
-----------------

   AopAutoConfiguration matched:
      - @ConditionalOnProperty (spring.aop.auto&#x3D;true) matched (OnPropertyCondition)

   AopAutoConfiguration.ClassProxyingConfiguration matched:
      - @ConditionalOnMissingClass did not find unwanted class &#39;org.aspectj.weaver.Advice&#39; (OnClassCondition)
      - @ConditionalOnProperty (spring.aop.proxy-target-class&#x3D;true) matched (OnPropertyCondition)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬çŸ¥é“äº†SpringBootCondtionæ²¡æœ‰å¼•å…¥é¢å¤–çš„ä¸šåŠ¡é€»è¾‘ï¼Œå®ƒèšç„¦åœ¨è®°å½•åŒ¹é…æ—¶çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶æ‰“å°å¯¹åº”çš„æ—¥å¿—ï¼Œåœ¨æ¡ä»¶åŠ è½½å‡ºé—®é¢˜æ—¶æ–¹ä¾¿æˆ‘ä»¬æ’æŸ¥é—®é¢˜</p>
<h5 id="FilteringSpringBootCondition">FilteringSpringBootCondition</h5>
<p>FilteringSpringBootConditionä¹Ÿæ˜¯ä¸€ä¸ªAbstractç±»ï¼Œå¹¶ä¸”FilteringSpringBootConditionä¸­æ²¡æœ‰å®ç°Conditionæ¥å£matchæ–¹æ³•ï¼Œè¿™æ„å‘³ç€FilteringSpringBootConditionçš„å­ç±»éœ€è¦è‡ªå·±å»å®ç°matchæ–¹æ³•<br>
æ³¨æ„è§‚å¯ŸFilteringSpringBootConditionçš„ä¾èµ–</p>
<ul>
<li>ç»§æ‰¿SpringBootConditionï¼Œè¯´æ˜FilteringSpringBootConditionæœ‰è®°å½•matchè¿‡ç¨‹çš„èƒ½åŠ›</li>
<li>ç»§æ‰¿BeanFactoryAwareï¼ŒBeanClassLoaderAwareï¼Œè¯´æ˜FilteringSpringBootConditionæœ‰æ„ŸçŸ¥å®¹å™¨BeanFactoryå’ŒClassLoaderçš„èƒ½åŠ›</li>
<li>ç»§æ‰¿AutoConfigurationImportFilterï¼Œè¯¥æ¥å£æ˜¯ä¸ºäº†å¿«é€Ÿç§»é™¤ä¸æ»¡è¶³æ¡ä»¶çš„AutoConfigurationç±»ï¼Œå› ä¸ºSpring Bootæä¾›çš„AutoConfigurationå®åœ¨æ˜¯å¤ªå¤šäº†ï¼ˆé»˜è®¤å¯¼å…¥144ä¸ªé…ç½®ç±»ï¼‰
<blockquote>
<p>Filter that can be registered in spring.factories to limit the auto-configuration classes considered. This interface is designed to allow fast removal of auto-configuration classes before their bytecode is even read.</p>
</blockquote>
</li>
</ul>
<p>è§‚å¯ŸAutoConfigurationImportFilteræ¥å£ï¼Œè¯¥æ¥å£è¾“å…¥æ—¶å·²æœ‰çš„autoConfigurationç±»ï¼Œè¾“å‡ºæ˜¯ä¸€ä¸ªbooleanæ•°ç»„ï¼Œå’Œè¾“å…¥çš„autoConfigurationClassesæ•°ç»„ä¸€ä¸€å¯¹åº”ï¼Œå½“è¾“å‡ºæ•°ç»„ä¸­æŸä¸€ä½ä¸ºfalseæ—¶ï¼Œè¯´æ˜å¯¹åº”çš„autoConfigurationä¸ä¼šè¢«å¯¼å…¥</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public interface AutoConfigurationImportFilter &#123;

    boolean[] match(String[] autoConfigurationClasses, AutoConfigurationMetadata autoConfigurationMetadata);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¾€ä¸Šæ‰¾ï¼ŒAutoConfigurationImportFilteråœ¨<code>ConfigurationClassFilter</code>ä¸­æœ‰æ˜ç¡®çš„ä½¿ç”¨ã€‚é€»è¾‘å¾ˆç®€å•ï¼Œå°†è¾“å…¥çš„è‡ªåŠ¨é…ç½®ç±»é€šè¿‡filterçš„matchæ–¹æ³•å»è¿‡æ»¤<br>
filtersä¸ºä¸‰ä¸ªå®ç°äº†FilteringSpringBootConditionçš„ä¸‰ä¸ªå­ç±»ï¼šOnClassConditionï¼ŒOnWebApplicationConditionï¼ŒOnBeanCondition</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">List&lt;String&gt; filter(List&lt;String&gt; configurations) &#123;
    long startTime &#x3D; System.nanoTime();
    String[] candidates &#x3D; StringUtils.toStringArray(configurations);
    boolean skipped &#x3D; false;
    &#x2F;&#x2F; filtersä¸ºä¸‰ä¸ªå®ç°äº†FilteringSpringBootConditionçš„ä¸‰ä¸ªå­ç±»
    &#x2F;&#x2F; OnClassCondition 
    &#x2F;&#x2F; OnWebApplicationCondition 
    &#x2F;&#x2F; OnBeanCondition
    for (AutoConfigurationImportFilter filter : this.filters) &#123;
        boolean[] match &#x3D; filter.match(candidates, this.autoConfigurationMetadata);
        for (int i &#x3D; 0; i &lt; match.length; i++) &#123;
            if (!match[i]) &#123;
                &#x2F;&#x2F; ä¸matchçš„configurationè®¾ç½®ä¸ºç©º
                candidates[i] &#x3D; null;
                skipped &#x3D; true;
            &#125;
        &#125;
    &#125;
    if (!skipped) &#123;
        return configurations;
    &#125;
    List&lt;String&gt; result &#x3D; new ArrayList&lt;&gt;(candidates.length);
    for (String candidate : candidates) &#123;
        if (candidate !&#x3D; null) &#123;
            &#x2F;&#x2F; è¿”å›æ»¡è¶³çš„configuration
            result.add(candidate);
        &#125;
    &#125;
    return result;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å†å¾€ä¸Šæ‰¾ï¼ŒConfigurationClassFilteråœ¨ä¸¤ä¸ªåœ°æ–¹æœ‰æ˜ç¡®ä½¿ç”¨</p>
<ol>
<li>
<p>ConfigurationClassPostProcessorä¸­selectImportsæ—¶ï¼Œè¿‡æ»¤AutoConfguration</p>
 <pre class="line-numbers language-java" data-language="java"><code class="language-java">protected AutoConfigurationImportSelector.AutoConfigurationEntry getAutoConfigurationEntry(AnnotationMetadata annotationMetadata) &#123;
    if (!isEnabled(annotationMetadata)) &#123;
        return EMPTY_ENTRY;
    &#125;
    AnnotationAttributes attributes &#x3D; getAttributes(annotationMetadata);
    &#x2F;&#x2F; è·å–æ‰€æœ‰@AutoConfigurationï¼Œæ³¨æ„è¿™é‡Œæ‰«æä¸åˆ°@Configuration
    List&lt;String&gt; configurations &#x3D; getCandidateConfigurations(annotationMetadata, attributes);
    &#x2F;&#x2F; å»é™¤é‡å¤çš„
    configurations &#x3D; removeDuplicates(configurations);
    &#x2F;&#x2F; è·å–æ³¨è§£ä¸Šéœ€è¦æ’é™¤çš„é…ç½®ç±»
    Set&lt;String&gt; exclusions &#x3D; getExclusions(annotationMetadata, attributes);
    checkExcludedClasses(configurations, exclusions);
    configurations.removeAll(exclusions);
    &#x2F;&#x2F; é€šè¿‡FilteringSpringBootConditionè¿‡æ»¤ä¸è¦éœ€è¦çš„é…ç½®ç±»
    configurations &#x3D; getConfigurationClassFilter().filter(configurations);
    fireAutoConfigurationImportEvents(configurations, exclusions);
    return new AutoConfigurationImportSelector.AutoConfigurationEntry(configurations, exclusions);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>å¯¼å…¥importåï¼Œå¯¹æ¯ä¸ªConfigurationå†æ¬¡è¿‡æ»¤</p>
</li>
</ol>
<p>è¿™é‡Œæœ‰ä¸ªæ³¨æ„çš„ç‚¹</p>
<ul>
<li>ConfigurationClassFilteråªæ˜¯å¯¹@AutoConfigurationåšäº†å¿«é€Ÿè¿‡æ»¤</li>
<li>å¯¹@Configurationè¿˜æ˜¯åœ¨SpringBootConditionä¸­å¤„ç†çš„ï¼Œå› ä¸ºConfigurationClassFilterå¹¶æ²¡æœ‰å®ç°Conditionçš„matchæ–¹æ³•</li>
</ul>
<h4 id="å¸¸ç”¨ä¸‰æ–¹ä¾èµ–starter">å¸¸ç”¨ä¸‰æ–¹ä¾èµ–starter</h4>
<p>spring-boot-autoconfigureé‡Œé¢è¿˜æä¾›äº†å¤§é‡ç¬¬ä¸‰æ–¹ä¾èµ–çš„startï¼Œè¿™æ˜¯Spring Bootçº¦å®šä¼˜å…ˆé…ç½®çš„åŸºç¡€ã€‚å¦‚æœå¯¹åº”çš„ä¸‰æ–¹åŒ…æ²¡æœ‰è¢«spring-boot-autoconfigureæ”¯æŒï¼Œéœ€è¦æ‰‹åŠ¨å¼•å…¥å¯¹åº”çš„startï¼Œå¦‚ï¼šmybatisï¼Œå¼•å…¥ä»¥ä¸‹åæ ‡åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨mybatisäº†ã€‚</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°±ä»¥MongoDBä¸ºä¾‹ï¼Œçœ‹çœ‹æ€ä¹ˆå†™ä¸€ä¸ªstarter</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; ä½¿ç”¨@AutoConfigurationæ ‡æ˜ä¸ºé…ç½®ç±»ï¼Œä½¿ç”¨@Configurationä¹Ÿå¯ä»¥
@AutoConfiguration
&#x2F;&#x2F; åœ¨MongoClientå­˜åœ¨æ—¶æ”¹é…ç½®æœ‰æ•ˆï¼Œæœ¬é¡¹ç›®ä¸­éœ€è¦å°†Mongoä½œä¸ºProvideå¼•å…¥
@ConditionalOnClass(MongoClient.class)
&#x2F;&#x2F; åŠ è½½å¯¹åº”propertisï¼Œè¿™æ ·æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­ç”¨spring.data.mongodb.xxå°±å¯ä»¥æ³¨å…¥å¯¹åº”å‚æ•°
@EnableConfigurationProperties(MongoProperties.class)
&#x2F;&#x2F; BeanFactoryä¸å­˜åœ¨MongoDatabaseFactoryï¼Œè¿™æ ·å¦‚æœæˆ‘ä»¬å¯¹è‡ªåŠ¨é…ç½®çš„ä¸æ»¡æ„ï¼Œå¯ä»¥ä½¿ç”¨æ‰‹åŠ¨é…ç½®å»è¦†ç›–starteré‡Œé¢çš„è‡ªåŠ¨é…ç½®
@ConditionalOnMissingBean(type &#x3D; &quot;org.springframework.data.mongodb.MongoDatabaseFactory&quot;)
public class MongoAutoConfiguration &#123;

    @Bean
    &#x2F;&#x2F; åœ¨BeanFactoryä¸­ä¸å­˜åœ¨MongoClientæ—¶ï¼Œåˆå§‹åŒ–MongoClient
    @ConditionalOnMissingBean(MongoClient.class)
    public MongoClient mongo(ObjectProvider&lt;MongoClientSettingsBuilderCustomizer&gt; builderCustomizers,
                             MongoClientSettings settings) &#123;
        return new MongoClientFactory(builderCustomizers.orderedStream().collect(Collectors.toList()))
                .createMongoClient(settings);
    &#125;

    @Configuration(proxyBeanMethods &#x3D; false)
    &#x2F;&#x2F; åœ¨BeanFactoryä¸­ä¸å­˜åœ¨MongoClientSettingsæ—¶ï¼Œåˆå§‹åŒ–MongoClient
    @ConditionalOnMissingBean(MongoClientSettings.class)
    static class MongoClientSettingsConfiguration &#123;

        @Bean
        MongoClientSettings mongoClientSettings() &#123;
            return MongoClientSettings.builder().build();
        &#125;

        @Bean
        MongoPropertiesClientSettingsBuilderCustomizer mongoPropertiesCustomizer(MongoProperties properties,
                                                                                 Environment environment) &#123;
            return new MongoPropertiesClientSettingsBuilderCustomizer(properties, environment);
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring IOC</tag>
      </tags>
  </entry>
  <entry>
    <title>intsetæ•´æ•°é›†åˆ</title>
    <url>/posts/c03ff393.html</url>
    <content><![CDATA[<blockquote>
<p><strong>æœ¬æ–‡æºç <a href="https://download.redis.io/releases/redis-5.0.12.tar.gz">redis5.0.12</a></strong><br>
intsetçš„æ•°æ®ç»“æ„ï¼Œå®šä¹‰åœ¨<code>intset.h</code>ï¼Œå®ç°åœ¨<code>intset.c</code>ä¸­</p>
</blockquote>
<p>intsetï¼Œé¡¾åæ€ä¹‰ï¼Œåªæœ‰intçš„é›†åˆï¼Œè¿™ç§é›†åˆå®Œå…¨ç¬¦åˆrediså†…å­˜èŠ‚çº¦ç‹‚é­”çš„ç§°å·ã€‚å¦‚æœ<code>é›†åˆ</code>æˆ–<code>æœ‰åºé›†åˆ</code>çš„å…ƒç´ åªæœ‰æ•°å­—ï¼ˆæœ€å¤§2<sup>64</sup>-1)ï¼Œåº•å±‚çš„æ•°æ®ç»“æ„å¾ˆå¯èƒ½ä½¿ç”¨çš„intsetã€‚</p>
<span id="more"></span>
<h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2>
<p>åœ¨<code>intset.h</code>ä¸­ï¼Œæˆ‘ä»¬èƒ½æ‰¾åˆ°å”¯ä¸€ä¸€ä¸ªç»“æ„ä½“å®šä¹‰ã€‚ä»è¿™ä¸ªå®šä¹‰æˆ‘ä»¬å‘ç°å’Œsdsçš„å¾ˆåƒï¼Œéƒ½æ˜¯ä½¿ç”¨ä¸€ä¸ªå­—æ®µ<code>flags</code>ã€<code>encoding</code>è®°å½•å®é™…ç±»å‹ï¼Œè®°å½•å·²ä½¿ç”¨äº†é‡<code>uint64_t len</code>ã€<code>uint32_t length</code>,å¹¶ç”¨ä¸€ä¸ªbuffer<code>char buf[]</code>ã€<code>int8_t contents[]</code>æ¥è®°å½•æ•°æ®ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">struct __attribute__ ((__packed__)) sdshdr64 &#123;
    uint64_t len; &#x2F;* used *&#x2F;
    uint64_t alloc; &#x2F;* excluding the header and null terminator *&#x2F;
    unsigned char flags; &#x2F;* 3 lsb of type, 5 unused bits *&#x2F;
    char buf[];
&#125;;

typedef struct intset &#123;
    uint32_t encoding;
    uint32_t length;
    int8_t contents[];
&#125; intset;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>ä»è¿™é‡Œçœ‹å‡ºï¼Œintsetä½¿ç”¨çš„<code>æ•°ç»„</code>çš„æ–¹å¼æ¥å®ç°çš„<code>é›†åˆ</code>ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬è®¤ä¸ºçš„<code>hash</code></p>
</blockquote>
<p>intsetä¸­ï¼Œæˆ‘ä»¬å”¯ä¸€éœ€è¦ææ¸…æ¥šçš„æšä¸¾å€¼å°±æ˜¯<code>encoding</code>ï¼Œåœ¨<code>intset.c</code>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ä»£ç </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">#define INTSET_ENC_INT16 (sizeof(int16_t))
#define INTSET_ENC_INT32 (sizeof(int32_t))
#define INTSET_ENC_INT64 (sizeof(int64_t))

&#x2F;* Return the required encoding for the provided value. *&#x2F;
static uint8_t _intsetValueEncoding(int64_t v) &#123;
    if (v &lt; INT32_MIN || v &gt; INT32_MAX)
        return INTSET_ENC_INT64;
    else if (v &lt; INT16_MIN || v &gt; INT16_MAX)
        return INTSET_ENC_INT32;
    else
        return INTSET_ENC_INT16;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<table>
<thead>
<tr>
<th>encodingæšä¸¾</th>
<th>å€¼</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>INTSET_ENC_INT16</td>
<td>2 sizeof(int16_t)</td>
<td>intsetå€¼èŒƒå›´æ˜¯ [-2<sup>16</sup>,2<sup>16</sup>-1]</td>
</tr>
<tr>
<td>INTSET_ENC_INT32</td>
<td>4 sizeof(int32_t)</td>
<td>intsetå€¼èŒƒå›´æ˜¯ [-2<sup>32</sup>,-2<sup>16</sup>) $\bigcup$ (2<sup>16</sup>-1,2<sup>32</sup>-1]</td>
</tr>
<tr>
<td>INTSET_ENC_INT64</td>
<td>8 sizeof(int64_t)</td>
<td>intsetå€¼èŒƒå›´æ˜¯ [-2<sup>64</sup>,-2<sup>32</sup>) $\bigcup$ (2<sup>32</sup>-1,2<sup>64</sup>-1]</td>
</tr>
</tbody>
</table>
<h2 id="æ“ä½œ">æ“ä½œ</h2>
<p>æ•´æ•°é›†åˆæ²¡æœ‰ä»€ä¹ˆå¤æ‚çš„æ“ä½œ</p>
<h3 id="åˆ›å»º">åˆ›å»º</h3>
<p>åˆ›å»ºå¾ˆç®€å•ï¼Œåˆ†é…å¥½ç©ºé—´å°±è¡Œäº†ï¼Œå¼€å§‹çš„æ•°æ®ç±»å‹ä¸º<code>INTSET_ENC_INT16</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">intset *intsetNew(void) &#123;
    intset *is &#x3D; zmalloc(sizeof(intset));
    is-&gt;encoding &#x3D; intrev32ifbe(INTSET_ENC_INT16);
    is-&gt;length &#x3D; 0;
    return is;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæœ‰ä¸ªå®å®šä¹‰<code>intrev32ifbe</code>ï¼Œè¿™æ˜¯å› ä¸ºreidså¤§éƒ¨åˆ†éƒ½ä½¿ç”¨çš„<code>å°ç«¯</code>ã€‚<br>
åœ¨<code>endianconv.h</code>ä¸­ï¼Œæˆ‘ä»¬èƒ½æ‰¾åˆ°å¯¹åº”çš„å®å®šä¹‰ã€‚è¿™é‡Œç»´æŠ¤äº†ä¸€ç³»åˆ—çš„å®ï¼Œéƒ½æ˜¯å°†æœ€ç»ˆçš„æ•°æ®æ’åˆ—è½¬ä¸º<code>å°ç«¯</code></p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">#if (BYTE_ORDER &#x3D;&#x3D; LITTLE_ENDIAN)
#define memrev16ifbe(p) ((void)(0))
#define memrev32ifbe(p) ((void)(0))
#define memrev64ifbe(p) ((void)(0))
#define intrev16ifbe(v) (v)
#define intrev32ifbe(v) (v)
#define intrev64ifbe(v) (v)
#else
#define memrev16ifbe(p) memrev16(p)
#define memrev32ifbe(p) memrev32(p)
#define memrev64ifbe(p) memrev64(p)
#define intrev16ifbe(v) intrev16(v)
#define intrev32ifbe(v) intrev32(v)
#define intrev64ifbe(v) intrev64(v)
#endif<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="æŸ¥æ‰¾">æŸ¥æ‰¾</h3>
<p>æ•´æ•°é›†åˆçš„æŸ¥æ‰¾é‡‡ç”¨çš„æ˜¯<code>äºŒåˆ†</code>ï¼Œè¦æ³¨æ„ä¸‹çš„æ˜¯posè¿™ä¸ªå‚æ•°</p>
<ol>
<li>å¦‚æœå…ƒç´ åœ¨é›†åˆä¸­ï¼ŒintsetSearchè¿”å›1ï¼Œposä»£è¡¨å…ƒç´ åœ¨é›†åˆä¸­çš„ä¸‹æ ‡</li>
<li>å¦‚æœå…ƒç´ ä¸åœ¨é›†åˆä¸­ï¼ŒintsetSearchè¿”å›0ï¼Œposä»£è¡¨å…ƒç´ å¯ä»¥æ’å…¥é›†åˆçš„ä¸‹æ ‡</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;* Search for the position of &quot;value&quot;. Return 1 when the value was found and
 * sets &quot;pos&quot; to the position of the value within the intset. Return 0 when
 * the value is not present in the intset and sets &quot;pos&quot; to the position
 * where &quot;value&quot; can be inserted. *&#x2F;
static uint8_t intsetSearch(intset *is, int64_t value, uint32_t *pos) &#123;
    int min &#x3D; 0, max &#x3D; intrev32ifbe(is-&gt;length)-1, mid &#x3D; -1;
    int64_t cur &#x3D; -1;

    &#x2F;* The value can never be found when the set is empty *&#x2F;
    if (intrev32ifbe(is-&gt;length) &#x3D;&#x3D; 0) &#123;
        if (pos) *pos &#x3D; 0;
        return 0;
    &#125; else &#123;
        &#x2F;* Check for the case where we know we cannot find the value,
         * but do know the insert position. *&#x2F;
        if (value &gt; _intsetGet(is,max)) &#123;
            if (pos) *pos &#x3D; intrev32ifbe(is-&gt;length);
            return 0;
        &#125; else if (value &lt; _intsetGet(is,0)) &#123;
            if (pos) *pos &#x3D; 0;
            return 0;
        &#125;
    &#125;

    while(max &gt;&#x3D; min) &#123;
        mid &#x3D; ((unsigned int)min + (unsigned int)max) &gt;&gt; 1;
        cur &#x3D; _intsetGet(is,mid);
        if (value &gt; cur) &#123;
            min &#x3D; mid+1;
        &#125; else if (value &lt; cur) &#123;
            max &#x3D; mid-1;
        &#125; else &#123;
            break;
        &#125;
    &#125;

    if (value &#x3D;&#x3D; cur) &#123;
        if (pos) *pos &#x3D; mid;
        return 1;
    &#125; else &#123;
        if (pos) *pos &#x3D; min;
        return 0;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="æ–°å¢">æ–°å¢</h3>
<h4 id="add">add</h4>
<p>ä»£ç ä¸Šçœ‹ï¼Œæ•´æ•°é›†åˆçš„æ–°å¢æ˜¯ä¸ªå¾ˆå¤æ‚çš„è¿‡ç¨‹ã€‚è¿™æ˜¯å› ä¸ºæ•´æ•°é›†åˆçš„åº•å±‚å®ç°æ˜¯<code>æ•°ç»„</code>ï¼Œä¸ºäº†ä¿è¯è‰¯å¥½çš„æŸ¥æ‰¾æ•ˆç‡ï¼Œè¿™ä¸ªæ•°ç»„å¿…é¡»æ˜¯æœ‰åºçš„ã€‚è¿™å°±è¦æ±‚åœ¨æ’å…¥çš„è¿‡ç¨‹ä¸­è¿›è¡Œæ’åºã€‚</p>
<ol>
<li>åˆ¤æ–­æ’å…¥çš„valueæ˜¯å¦è¶…è¿‡å½“å‰é›†åˆèƒ½å¤„ç†çš„èŒƒå›´ï¼ˆencodingï¼‰ï¼Œå¦‚æœè¶…è¿‡äº†ï¼Œéœ€è¦<code>å‡çº§</code>æ•´æ•°æ•°ç»„ã€‚</li>
<li>æ ¹æ®valueæŸ¥æ‰¾è¯¥å…ƒç´ æ˜¯å¦åœ¨intsetä¸­ï¼ŒintsetSearchä¸­ä¼ å…¥äº†ä¸€ä¸ªå‚æ•°posï¼Œposè¡¨ç¤ºäº†searchä¹‹åå¯ä»¥æ’å…¥å…ƒç´ çš„ä½ç½®<br>
2.1 å¦‚æœåœ¨ï¼Œåæ­£é›†åˆåªä¿è¯å…ƒç´ çš„æœ‰æ— ï¼Œå°±ä¸ç”¨å¤„ç†äº†<br>
2.2 å¦‚æœé›†åˆä¸­ä¸åŒ…å«è¯¥å…ƒç´ ï¼Œç°åœ¨å¯ä»¥åœ¨poså¤„æ’å…¥è¯¥å…ƒç´ ã€‚å…ˆå¯¹intsetæ‰©å®¹ï¼Œç„¶ååœ¨posæ’å…¥æ•°æ®ã€‚æ³¨æ„ä¹³æ²Ÿposä¸åœ¨æ•°ç»„çš„æœ«å°¾ï¼Œéœ€è¦å§posåé¢çš„æ•°æ®éƒ½å‘åç§»åŠ¨ä¸€ä½</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">intset *intsetAdd(intset *is, int64_t value, uint8_t *success) &#123;
    uint8_t valenc &#x3D; _intsetValueEncoding(value);
    uint32_t pos;
    if (success) *success &#x3D; 1;

    &#x2F;* Upgrade encoding if necessary. If we need to upgrade, we know that
     * this value should be either appended (if &gt; 0) or prepended (if &lt; 0),
     * because it lies outside the range of existing values. *&#x2F;
    if (valenc &gt; intrev32ifbe(is-&gt;encoding)) &#123;
        &#x2F;* This always succeeds, so we don&#39;t need to curry *success. *&#x2F;
        return intsetUpgradeAndAdd(is,value);
    &#125; else &#123;
        &#x2F;* Abort if the value is already present in the set.
         * This call will populate &quot;pos&quot; with the right position to insert
         * the value when it cannot be found. *&#x2F;
        if (intsetSearch(is,value,&amp;pos)) &#123;
            if (success) *success &#x3D; 0;
            return is;
        &#125;

        is &#x3D; intsetResize(is,intrev32ifbe(is-&gt;length)+1);
        if (pos &lt; intrev32ifbe(is-&gt;length)) intsetMoveTail(is,pos,pos+1);
    &#125;

    _intsetSet(is,pos,value);
    is-&gt;length &#x3D; intrev32ifbe(intrev32ifbe(is-&gt;length)+1);
    return is;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="upgradeAndAdd">upgradeAndAdd</h4>
<p>å¦‚æœæ’å…¥çš„æ•´æ•°è¶…è¿‡æ•´æ•°é›†åˆçš„èŒƒå›´äº†ï¼Œéœ€è¦å‡çº§æ•´æ•°é›†åˆï¼Œæ‰©å®¹å¹¶é‡æ–°åˆ†é…ç©ºé—´ï¼Œæœ€åæ’å…¥æ–°æ•°æ®</p>
<blockquote>
<p>è¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼šæ’å…¥çš„æ•°æ®éƒ½è¶…è¿‡åŸæ¥é›†åˆçš„èŒƒå›´äº†ï¼Œæ‰€ä»¥æ–°æ’å…¥çš„æ•°æ®è¦ä¹ˆåœ¨æ–°é›†åˆä¸­æ˜¯ç¬¬ä¸€ä¸ªï¼Œè¦ä¹ˆæ˜¯æœ€åä¸€ä¸ª<br>
ä»£ç ä¸­ä½¿ç”¨äº†<code>prepend</code>è¿™ä¸ªå˜é‡æ¥å¤„ç†</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">static intset *intsetUpgradeAndAdd(intset *is, int64_t value) &#123;
    uint8_t curenc &#x3D; intrev32ifbe(is-&gt;encoding);
    uint8_t newenc &#x3D; _intsetValueEncoding(value);
    int length &#x3D; intrev32ifbe(is-&gt;length);
    int prepend &#x3D; value &lt; 0 ? 1 : 0;

    &#x2F;* First set new encoding and resize *&#x2F;
    is-&gt;encoding &#x3D; intrev32ifbe(newenc);
    is &#x3D; intsetResize(is,intrev32ifbe(is-&gt;length)+1);

    &#x2F;* Upgrade back-to-front so we don&#39;t overwrite values.
     * Note that the &quot;prepend&quot; variable is used to make sure we have an empty
     * space at either the beginning or the end of the intset. *&#x2F;
    while(length--)
        _intsetSet(is,length+prepend,_intsetGetEncoded(is,length,curenc));

    &#x2F;* Set the value at the beginning or the end. *&#x2F;
    if (prepend)
        _intsetSet(is,0,value);
    else
        _intsetSet(is,intrev32ifbe(is-&gt;length),value);
    is-&gt;length &#x3D; intrev32ifbe(intrev32ifbe(is-&gt;length)+1);
    return is;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="åˆ é™¤">åˆ é™¤</h2>
<p>åˆ é™¤ä½¿ç”¨intsetSearchæ‰¾åˆ°éœ€è¦åˆ é™¤å…ƒç´ çš„ä½ç½®ï¼ˆæ‰¾ä¸åˆ°å°±ä¸åˆ äº†å‘—ï¼‰ï¼Œç§»åŠ¨åé¢çš„å…ƒç´ å¹¶ç¼©å®¹å³å¯</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">intset *intsetRemove(intset *is, int64_t value, int *success) &#123;
    uint8_t valenc &#x3D; _intsetValueEncoding(value);
    uint32_t pos;
    if (success) *success &#x3D; 0;

    if (valenc &lt;&#x3D; intrev32ifbe(is-&gt;encoding) &amp;&amp; intsetSearch(is,value,&amp;pos)) &#123;
        uint32_t len &#x3D; intrev32ifbe(is-&gt;length);

        &#x2F;* We know we can delete *&#x2F;
        if (success) *success &#x3D; 1;

        &#x2F;* Overwrite value with tail and update length *&#x2F;
        if (pos &lt; (len-1)) intsetMoveTail(is,pos+1,pos);
        is &#x3D; intsetResize(is,len-1);
        is-&gt;length &#x3D; intrev32ifbe(len-1);
    &#125;
    return is;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>çœ‹å®Œäº†æ•´æ•°é›†åˆï¼Œè¿™å°±æ˜¯ä¸ªç”¨<code>æ—¶é—´</code>æ¢<code>ç©ºé—´</code>çš„å…¸å‹ã€‚å†…å­˜åˆ°æ˜¯å¾ˆçœï¼Œä½†æ’å…¥ï¼Œåˆ é™¤çš„æ•ˆç‡éƒ½æ˜¯<code>O(N)</code>ï¼ŒæŸ¥æ‰¾çš„æ•ˆç‡æ˜¯<code>O(logN)</code>ã€‚è¿™å°±é™å®šäº†æ•´æ•°é›†åˆä¸é€‚åˆå­˜æ”¾å¤§é‡çš„æ•°æ®ã€‚</p>
]]></content>
      <categories>
        <category>redis</category>
      </categories>
      <tags>
        <tag>redisæºç </tag>
        <tag>redisæ•°æ®ç»“æ„</tag>
      </tags>
  </entry>
  <entry>
    <title>sdså­—ç¬¦ä¸²</title>
    <url>/posts/cffaa119.html</url>
    <content><![CDATA[<blockquote>
<p><strong>æœ¬æ–‡æºç <a href="https://download.redis.io/releases/redis-5.0.12.tar.gz">redis5.0.12</a></strong><br>
Simple Dynamic Stringå®šä¹‰åœ¨<code>sds.h</code>ï¼Œå®ç°åœ¨<code>sds.c</code>ä¸­</p>
</blockquote>
<p>ä½¿ç”¨redisæ—¶ï¼Œå­—ç¬¦ä¸²æ˜¯æˆ‘ä»¬æœ€å…ˆæ¥è§¦ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„æ•°æ®ç»“æ„ã€‚ä½†redisä¸­å¹¶æ²¡æœ‰ä½¿ç”¨Cè¯­è¨€ä¸­å¸¸ç”¨çš„Stringç±»å‹ï¼Œè€Œæ˜¯è‡ªå·±å®ç°äº†Simple Dynamic Stringï¼ˆç®€å•åŠ¨æ€å­—ç¬¦ä¸²SDSï¼‰ã€‚</p>
<span id="more"></span>
<h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2>
<p>åœ¨sds.hä¸­å®šä¹‰äº†sdsçš„æ•°æ®ç»“æ„ã€‚<code>typedef char *sds;</code>å•ä»æ•°æ®ç»“æ„çš„å®šä¹‰ä¸Šçœ‹ï¼Œsdså°±æ˜¯ä¸€ä¸ªcharæ•°ç»„ã€‚ä½†å’Œcçš„charæ•°ç»„ä¸åŒã€‚sdsä¿å­˜äº†é¢å¤–çš„æ•°æ®ä¿¡æ¯ï¼Œä¿è¯<strong>é«˜æ•ˆå­—ç¬¦ä¸²æ“ä½œ</strong>å’Œ<strong>äºŒè¿›åˆ¶å®‰å…¨</strong>ã€‚</p>
<ul>
<li><strong>STRLEN</strong>å¯ä»¥è·å–å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œcä¸­Stringè·å–å­—ç¬¦ä¸²é•¿åº¦æ˜¯O(N)çš„å¤æ‚åº¦ã€‚å®é™…åº”ç”¨ä¸­ä¸€ä¸ªå¤§å‡ ç™¾Kçš„å­—ç¬¦ä¸²ä¹Ÿä¸å°‘è§ï¼Œé‡‡ç”¨O(N)çš„å¤æ‚åº¦å¤ªå¾—ä¸å¿å¤±ï¼Œè¿™æ ·å°±éœ€è¦æœ‰ä¸ªå­—æ®µè®°å½•å®é™…å­—ç¬¦é•¿åº¦ã€‚</li>
<li>å­—ç¬¦ä¸²å®é™…å¤§å°å·²ç»è®°å½•äº†ï¼Œè¿™æ ·å­—ç¬¦å°±ä¸å¿…è¦å¼ºåˆ¶é‡‡ç”¨/0ç»“å°¾ï¼Œè¿™ä¹Ÿä¿è¯äº†äºŒè¿›åˆ¶å®‰å…¨ã€‚</li>
<li><strong>APPEND</strong>å¯ä»¥åœ¨ç°æœ‰å­—ç¬¦ä¸²çš„åŸºç¡€ä¸Šè¿½åŠ å­—ç¬¦ï¼Œcä¸­Stringåˆ†é…çš„ç©ºé—´åˆšåˆšå¥½å­˜æ”¾å­—ç¬¦ï¼Œæ‰€ä»¥åœ¨appendæ—¶éœ€è¦å¯¹æ–°å­—ç¬¦ä¸²é‡æ–°åˆ†é…ç©ºé—´ï¼Œè¿™æ ·çš„æ“ä½œæ˜¯å¾ˆä¸åˆ’ç®—çš„ã€‚è§£å†³æ–¹æ³•å°±æ˜¯é¢„å…ˆåˆ†é…ä¸€å—ç©ºé—´ï¼ˆå¦‚javaä¸­ArrayListï¼‰ï¼Œè¿™å°±è¦æ±‚æœ‰ä¸ªå­—æ®µè®°å½•é¢„åˆ†é…ç©ºé—´çš„å¤§å°ã€‚</li>
</ul>
<p>æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œæ—©æœŸredisçš„æ•°æ®ç»“æ„ä¸­ï¼Œé™¤äº†charæ•°ç»„å¤–ï¼Œè¿˜é¢ä¸ºå®šä¹‰äº†é¢„åˆ†é…æ•°ç»„çš„å¤§å°å’Œå‰©ä½™ç©ºé—´ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡lenå‡å»freeå¾—åˆ°å­—ç¬¦ä¸²çš„å®é™…é•¿åº¦ã€‚å¹¶ä¸”sdsæŒ‡å‘çš„æ˜¯char buf[]ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨*(sds-4)å’Œ*(sds-8)ç›´æ¥è®¿é—®freeå’Œlençš„åœ°å€ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">struct sdshdr &#123;
    int len;    &#x2F;&#x2F; buf å·²å ç”¨é•¿åº¦
    int free;   &#x2F;&#x2F; buf å‰©ä½™å¯ç”¨é•¿åº¦
    char buf[];     &#x2F;&#x2F; å®é™…ä¿å­˜å­—ç¬¦ä¸²æ•°æ®çš„åœ°æ–¹
&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»è¿™ä¸ªsdshdrçš„å®šä¹‰ä¸­å¯ä»¥çœ‹å‡ºï¼Œintç±»å‹çš„lenå’Œfreeå¯ä»¥æè¿°2Gçš„ç©ºé—´ï¼Œä½†å®é™…åº”ç”¨è¿‡ç¨‹ä¸­æˆ‘ä»¬å¹¶ä¸éœ€è¦è¿™ä¹ˆå¤§çš„ç©ºé—´ã€‚æ‰€ä»¥åœ¨redisçš„åç»­å‘å±•ä¸­ï¼Œå®šä¹‰äº†ä¸€ç³»åˆ—sdshdrXï¼Œå¯ä»¥æ ¹æ®ä¸åŒå¤§å°çš„å­—ç¬¦ä¸²åˆ†é…ä¸åŒçš„ç»“æ„é¢˜ï¼Œå·²è¾¾åˆ°èŠ‚çœç©ºé—´çš„ç›®çš„ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;* Note: sdshdr5 is never used, we just access the flags byte directly.
 * However is here to document the layout of type 5 SDS strings. *&#x2F;
struct __attribute__ ((__packed__)) sdshdr5 &#123;
    unsigned char flags; &#x2F;* 3 lsb of type, and 5 msb of string length *&#x2F;
    char buf[];
&#125;;
struct __attribute__ ((__packed__)) sdshdr8 &#123;
    uint8_t len; &#x2F;* used *&#x2F;
    uint8_t alloc; &#x2F;* excluding the header and null terminator *&#x2F;
    unsigned char flags; &#x2F;* 3 lsb of type, 5 unused bits *&#x2F;
    char buf[];
&#125;;
struct __attribute__ ((__packed__)) sdshdr16 &#123;
    uint16_t len; &#x2F;* used *&#x2F;
    uint16_t alloc; &#x2F;* excluding the header and null terminator *&#x2F;
    unsigned char flags; &#x2F;* 3 lsb of type, 5 unused bits *&#x2F;
    char buf[];
&#125;;
struct __attribute__ ((__packed__)) sdshdr32 &#123;
    uint32_t len; &#x2F;* used *&#x2F;
    uint32_t alloc; &#x2F;* excluding the header and null terminator *&#x2F;
    unsigned char flags; &#x2F;* 3 lsb of type, 5 unused bits *&#x2F;
    char buf[];
&#125;;
struct __attribute__ ((__packed__)) sdshdr64 &#123;
    uint64_t len; &#x2F;* used *&#x2F;
    uint64_t alloc; &#x2F;* excluding the header and null terminator *&#x2F;
    unsigned char flags; &#x2F;* 3 lsb of type, 5 unused bits *&#x2F;
    char buf[];
&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»æ•°æ®ç»“æ„å¯ä»¥çœ‹å‡ºï¼Œredisä¸€å…±å®šä¹‰äº†5ä¸­sdshdrç»“æ„ï¼ˆsdshdr5å¹¶æ²¡æœ‰ä½¿ç”¨ï¼‰ï¼Œåˆ†åˆ«å¯ä»¥æ”¯æŒé•¿åº¦ä¸º2<sup>5</sup>ï¼Œ2<sup>8</sup>ï¼Œ2<sup>16</sup>ï¼Œ2<sup>32</sup>å’Œ2<sup>64</sup>çš„å­—ç¬¦ä¸²ï¼ˆå…¶å®Redisä¸­å­—ç¬¦ä¸²é•¿åº¦ä¸èƒ½è¶…è¿‡512Mï¼‰ã€‚rediså¯ä»¥é€šè¿‡å­—ç¬¦ä¸²é•¿åº¦é€‰æ‹©åˆé€‚çš„sdshdrç»“æ„ä½“ã€‚<br>
ç°åœ¨æœ‰å¤šç§sdshdrç»“æ„ä½“äº†ï¼Œæˆ‘ä»¬å°±å¿…é¡»åœ¨ç»“æ„ä½“ä¸­å­˜å‚¨ç»“æ„ä½“çš„ç±»å‹ï¼Œè¿™ä¸ªå­—æ®µå°±æ˜¯unsigned char flagsã€‚å®ƒä½¿ç”¨äº†3ä½æ¥è¡¨ç¤ºè¿™5ç§ç±»å‹</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">#define SDS_TYPE_5  0
#define SDS_TYPE_8  1
#define SDS_TYPE_16 2
#define SDS_TYPE_32 3
#define SDS_TYPE_64 4
static inline char sdsReqType(size_t string_size) &#123;
    if (string_size &lt; 1&lt;&lt;5)
        return SDS_TYPE_5;
    if (string_size &lt; 1&lt;&lt;8)
        return SDS_TYPE_8;
    if (string_size &lt; 1&lt;&lt;16)
        return SDS_TYPE_16;
#if (LONG_MAX &#x3D;&#x3D; LLONG_MAX)
    if (string_size &lt; 1ll&lt;&lt;32)
        return SDS_TYPE_32;
    return SDS_TYPE_64;
#else
    return SDS_TYPE_32;
#endif
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>redisä¸­è¿˜å®šä¹‰äº†ä¸¤ä¸ªå®SDS_HDR_VARå’ŒSDS_HDRï¼Œéƒ½æ˜¯æ ¹æ®sdsçš„åœ°å€è®¡ç®—ç»“æ„ä½“sdshdrçš„åœ°å€ã€‚æˆ‘ä»¬éœ€è¦è®°ä½çš„æ˜¯sdsçš„åœ°å€æ°¸è¿œæŒ‡å‘çš„æ˜¯char[] bufã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">#define SDS_HDR_VAR(T,s) struct sdshdr##T *sh &#x3D; (void*)((s)-(sizeof(struct sdshdr##T)));
#define SDS_HDR(T,s) ((struct sdshdr##T *)((s)-(sizeof(struct sdshdr##T))))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="SDSä½¿ç”¨">SDSä½¿ç”¨</h2>
<p>åœ¨ææ¸…æ¥šSDSåŸºæœ¬æ•°æ®ç»“æ„åï¼Œç°åœ¨æ¥çœ‹çœ‹redisæ˜¯æ€ä¹ˆä½¿ç”¨SDSçš„ã€‚</p>
<h3 id="åˆ›å»º">åˆ›å»º</h3>
<p>sdsé‡‡ç”¨å‡½æ•°sdsnewlenè¿›è¡Œåˆ›å»ºã€‚</p>
<ol>
<li>é€šè¿‡å­—ç¬¦ä¸²é•¿åº¦è·å–sdshdrçš„å®é™…ç±»å‹ã€‚å¦‚æœæ˜¯sdshdr5åˆ™è½¬æ¢ä¸ºsdshdr8</li>
<li>åˆ†é…åˆå§‹åŒ–å†…å­˜ç©ºé—´ç»™shï¼Œåˆ†é…ç©ºé—´å¤§å°ä¸ºsdshdrå¤´å¤§å°+å­—ç¬¦ä¸²å¤§å°+1ï¼Œæ³¨æ„sdsä¾ç„¶æ˜¯\0ç»“å°¾</li>
<li>æ ¹æ®ç±»å‹ï¼ˆtypeï¼‰ä½¿ç”¨å®SDS_HDR_VARè·å–å®é™…ç»“æ„ä½“ï¼Œå¹¶æŠŠåˆå§‹åŒ–headerä¸­lenï¼Œallocå’Œtypeå­—æ®µ</li>
<li>å°†ä¼ å…¥çš„å­—ç¬¦ä¸²æ‹·è´åˆ°sdsä¸­çš„buf</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;* Create a new sds string with the content specified by the &#39;init&#39; pointer
 * and &#39;initlen&#39;.
 * If NULL is used for &#39;init&#39; the string is initialized with zero bytes.
 * If SDS_NOINIT is used, the buffer is left uninitialized;
 *
 * The string is always null-termined (all the sds strings are, always) so
 * even if you create an sds string with:
 *
 * mystring &#x3D; sdsnewlen(&quot;abc&quot;,3);
 *
 * You can print the string with printf() as there is an implicit \0 at the
 * end of the string. However the string is binary safe and can contain
 * \0 characters in the middle, as the length is stored in the sds header. *&#x2F;
sds sdsnewlen(const void *init, size_t initlen) &#123;
    void *sh;
    sds s;
    char type &#x3D; sdsReqType(initlen);
    &#x2F;* Empty strings are usually created in order to append. Use type 8
     * since type 5 is not good at this. *&#x2F;
    if (type &#x3D;&#x3D; SDS_TYPE_5 &amp;&amp; initlen &#x3D;&#x3D; 0) type &#x3D; SDS_TYPE_8;
    int hdrlen &#x3D; sdsHdrSize(type);
    unsigned char *fp; &#x2F;* flags pointer. *&#x2F;

    assert(hdrlen+initlen+1 &gt; initlen); &#x2F;* Catch size_t overflow *&#x2F;
    sh &#x3D; s_malloc(hdrlen+initlen+1);
    if (init&#x3D;&#x3D;SDS_NOINIT)
        init &#x3D; NULL;
    else if (!init)
        memset(sh, 0, hdrlen+initlen+1);
    if (sh &#x3D;&#x3D; NULL) return NULL;
    s &#x3D; (char*)sh+hdrlen;
    fp &#x3D; ((unsigned char*)s)-1;
    switch(type) &#123;
        case SDS_TYPE_5: &#123;
            *fp &#x3D; type | (initlen &lt;&lt; SDS_TYPE_BITS);
            break;
        &#125;
        case SDS_TYPE_8: &#123;
            SDS_HDR_VAR(8,s);
            sh-&gt;len &#x3D; initlen;
            sh-&gt;alloc &#x3D; initlen;
            *fp &#x3D; type;
            break;
        &#125;
        case SDS_TYPE_16: &#123;
            SDS_HDR_VAR(16,s);
            sh-&gt;len &#x3D; initlen;
            sh-&gt;alloc &#x3D; initlen;
            *fp &#x3D; type;
            break;
        &#125;
        case SDS_TYPE_32: &#123;
            SDS_HDR_VAR(32,s);
            sh-&gt;len &#x3D; initlen;
            sh-&gt;alloc &#x3D; initlen;
            *fp &#x3D; type;
            break;
        &#125;
        case SDS_TYPE_64: &#123;
            SDS_HDR_VAR(64,s);
            sh-&gt;len &#x3D; initlen;
            sh-&gt;alloc &#x3D; initlen;
            *fp &#x3D; type;
            break;
        &#125;
    &#125;
    if (initlen &amp;&amp; init)
        memcpy(s, init, initlen);
    s[initlen] &#x3D; &#39;\0&#39;;
    return s;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="é‡Šæ”¾">é‡Šæ”¾</h3>
<p>sdsçš„é‡Šæ”¾æ¯”è¾ƒç®€å•</p>
<ol>
<li>è®°ä½sdsæŒ‡å‘çš„char buf[]ï¼Œé‚£ä¹ˆs[-1]æŒ‡å‘çš„æ˜¯flagsï¼Œå³sdshdrçš„ç±»å‹</li>
<li>sdsHdrSizeè®¡ç®—å‡ºsdsçš„headerå¤§å°</li>
<li>(char*)s-sdsHdrSize(s[-1])ç›´æ¥æŒ‡å‘äº†ç»“æ„ä½“åœ°å€</li>
<li>é‡Šæ”¾ç©ºé—´ï¼Œè¿™é‡Œæ²¡æœ‰å¯¹bufé‡Šæ”¾å› ä¸ºç”³è¯·ç©ºé—´çš„æ—¶å€™bufä½œä¸ºç»“æ„ä½“ä¸€èµ·ç”³è¯·äº†ã€‚</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">void sdsfree(sds s) &#123;
    if (s &#x3D;&#x3D; NULL) return;
    s_free((char*)s-sdsHdrSize(s[-1]));
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="æ¸…ç©º">æ¸…ç©º</h3>
<p>redisä¸­æ›´å¤šçš„æ˜¯ä½¿ç”¨æ¸…ç©ºæ“ä½œï¼ˆæƒ°æ€§åˆ é™¤ï¼‰ï¼Œåªæ˜¯æŠŠå­—ç¬¦ä¸²çš„é•¿åº¦è®¾ç½®ä¸º0ï¼Œå¹¶ä¸é‡Šæ”¾ç©ºé—´ã€‚ä¸‹ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨æ¸…ç©ºçš„sdsï¼Œé¿å…å†…å­˜çš„åˆ†é…æ“ä½œ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">void sdsclear(sds s) &#123;
    sdssetlen(s, 0);
    s[0] &#x3D; &#39;\0&#39;;
&#125;
static inline void sdssetlen(sds s, size_t newlen) &#123;
    unsigned char flags &#x3D; s[-1];
    switch(flags&amp;SDS_TYPE_MASK) &#123;
        case SDS_TYPE_5:
            &#123;
                unsigned char *fp &#x3D; ((unsigned char*)s)-1;
                *fp &#x3D; SDS_TYPE_5 | (newlen &lt;&lt; SDS_TYPE_BITS);
            &#125;
            break;
        case SDS_TYPE_8:
            SDS_HDR(8,s)-&gt;len &#x3D; newlen;
            break;
        case SDS_TYPE_16:
            SDS_HDR(16,s)-&gt;len &#x3D; newlen;
            break;
        case SDS_TYPE_32:
            SDS_HDR(32,s)-&gt;len &#x3D; newlen;
            break;
        case SDS_TYPE_64:
            SDS_HDR(64,s)-&gt;len &#x3D; newlen;
            break;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="æ‰©å®¹">æ‰©å®¹</h3>
<p>æ‰©å®¹çš„æ€æƒ³å¾ˆç®€å•</p>
<ol>
<li>è®¡ç®—å‡ºæ‰©å®¹åéœ€è¦ç©ºé—´å¤§å°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯æ‰©å®¹ç­–ç•¥ï¼šå¦‚æœæ–°å­—ç¬¦ä¸²å¤§å°ï¼ˆnewlenï¼‰å°äºSDS_MAX_PREALLOCï¼ˆ1Mï¼‰ï¼Œ åˆ™æ‰©å®¹ç©ºé—´æ˜¯newlençš„ä¸¤å€ï¼›å¦åˆ™æ‰©å®¹ç©ºé—´æ˜¯newlen+SDS_MAX_PREALLOC</li>
<li>æ ¹æ®æ–°å­—ç¬¦ä¸²å¤§å°ï¼ˆnewlenï¼‰åˆ¤æ–­æ˜¯å¦éœ€è¦å‡çº§sdshdrï¼Œå¦‚æœä¸éœ€è¦å‡çº§ï¼Œåœ¨åŸæœ‰sdshdråŸºç¡€ä¸Šé‡æ–°åˆ†é…ç©ºé—´å³å¯ï¼›å¦‚æœéœ€è¦å‡çº§ï¼Œæ–°å»ºsdshdrèµ‹å€¼ï¼Œç„¶åå°†è€çš„sdshdré‡Šæ”¾</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">#define SDS_MAX_PREALLOC (1024*1024)
sds sdsMakeRoomFor(sds s, size_t addlen) &#123;
    void *sh, *newsh;
    size_t avail &#x3D; sdsavail(s);
    size_t len, newlen;
    char type, oldtype &#x3D; s[-1] &amp; SDS_TYPE_MASK;
    int hdrlen;

    &#x2F;* Return ASAP if there is enough space left. *&#x2F;
    if (avail &gt;&#x3D; addlen) return s;

    len &#x3D; sdslen(s);
    sh &#x3D; (char*)s-sdsHdrSize(oldtype);
    newlen &#x3D; (len+addlen);
    assert(newlen &gt; len);   &#x2F;* Catch size_t overflow *&#x2F;
    if (newlen &lt; SDS_MAX_PREALLOC)
        newlen *&#x3D; 2;
    else
        newlen +&#x3D; SDS_MAX_PREALLOC;

    type &#x3D; sdsReqType(newlen);

    &#x2F;* Don&#39;t use type 5: the user is appending to the string and type 5 is
     * not able to remember empty space, so sdsMakeRoomFor() must be called
     * at every appending operation. *&#x2F;
    if (type &#x3D;&#x3D; SDS_TYPE_5) type &#x3D; SDS_TYPE_8;

    hdrlen &#x3D; sdsHdrSize(type);
    assert(hdrlen+newlen+1 &gt; len);  &#x2F;* Catch size_t overflow *&#x2F;
    if (oldtype&#x3D;&#x3D;type) &#123;
        newsh &#x3D; s_realloc(sh, hdrlen+newlen+1);
        if (newsh &#x3D;&#x3D; NULL) return NULL;
        s &#x3D; (char*)newsh+hdrlen;
    &#125; else &#123;
        &#x2F;* Since the header size changes, need to move the string forward,
         * and can&#39;t use realloc *&#x2F;
        newsh &#x3D; s_malloc(hdrlen+newlen+1);
        if (newsh &#x3D;&#x3D; NULL) return NULL;
        memcpy((char*)newsh+hdrlen, s, len+1);
        s_free(sh);
        s &#x3D; (char*)newsh+hdrlen;
        s[-1] &#x3D; type;
        sdssetlen(s, len);
    &#125;
    sdssetalloc(s, newlen);
    return s;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
]]></content>
      <categories>
        <category>redis</category>
      </categories>
      <tags>
        <tag>redisæºç </tag>
        <tag>redisæ•°æ®ç»“æ„</tag>
      </tags>
  </entry>
  <entry>
    <title>skiplistè·³è¡¨</title>
    <url>/posts/7b62b471.html</url>
    <content><![CDATA[<blockquote>
<p><strong>æœ¬æ–‡æºç <a href="https://download.redis.io/releases/redis-5.0.12.tar.gz">redis5.0.12</a></strong><br>
è·³è¡¨çš„å®šä¹‰åœ¨<code>server.h</code>ä¸­ï¼Œå®ç°åœ¨<code>t_zset.c</code></p>
</blockquote>
<p>è·³è¡¨æ˜¯ä¸ªå¾ˆç¥å¥‡çš„æ•°æ®ç»“æ„ï¼Œç®€å•ä½†æ•ˆç‡é«˜ï¼Œæ²¡æœ‰<strong>çº¢é»‘æ ‘</strong>å¤æ‚ï¼Œå´æœ‰O(logn)çš„æŸ¥æ‰¾æ•ˆç‡ã€‚å…¶å®æˆ‘è§‰å¾—<code>åªæœ‰å³å„¿å­çš„B+æ ‘</code>å’Œè·³è¡¨æŒºç±»ä¼¼çš„ï¼Œéƒ½æ˜¯å¤šçº§ç´¢å¼•æ¥è¾¾åˆ°O(logn)çš„æ•ˆç‡ã€‚<br>
redisä¸­ï¼Œåªæœ‰æœ‰åºé›†åˆzsetä½¿ç”¨äº†è·³è¡¨</p>
<span id="more"></span>
<h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2>
<p>è·³è¡¨çš„æ•°æ®ç»“æ„å¾ˆç®€å•ï¼Œåªæœ‰<code>zskiplistNode</code>å’Œ<code>zskiplist</code>ä¸¤ä¸ª</p>
<ul>
<li>zskiplistä¿å­˜äº†æŒ‡å‘nodeçš„å¤´æŒ‡é’ˆå’Œå°¾æŒ‡é’ˆï¼Œè¿˜æœ‰è·³è¡¨çš„å±‚çº§å’Œé•¿åº¦</li>
<li>zskiplistNodeä½œä¸ºä¿å­˜æ•°æ®çš„nodeï¼Œredisåšäº†ç‰¹åˆ«çš„è®¾è®¡:
<ul>
<li>eleï¼šä¿å­˜çš„å­—ç¬¦ä¸²</li>
<li>scoreï¼šæ•°æ®çš„åˆ†æ•°ï¼Œè·³è¡¨é€šè¿‡scoreæ’åºï¼Œå¦‚æœsourceç›¸åŒï¼Œä½¿ç”¨eleè¿›ä¸€æ­¥æ’åº</li>
<li>backwardï¼šåé€€æŒ‡é’ˆï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œè·³è¡¨æ˜¯å¯¹socoreæ­£å‘æ’åºçš„ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨redisçš„<code>zrevrange</code>ç­‰å‘½ä»¤è¿”å›é€†å‘æ’åºçš„æ•°æ®æ—¶ï¼Œå°±éœ€è¦ä½¿ç”¨åé€€æŒ‡é’ˆã€‚</li>
<li>levelï¼šå¤šå±‚åˆ—è¡¨ï¼Œä¿å­˜æ•°æ®çš„å¤šå±‚ç´¢å¼•ï¼Œä¸€ä¸ªèŠ‚ç‚¹å…·ä½“æœ‰å‡ å±‚æ˜¯éšæœºç”Ÿæˆçš„ã€‚è¿™ä¸ªæ•°æ®ç»“æ„ä¹Ÿä¼šåœ¨ä¸‹é¢é‡ç‚¹åˆ†æ
<ul>
<li>forwardï¼šå‰å‘æŒ‡é’ˆ</li>
<li>spanï¼šè¡¨ç¤ºæœ¬èŠ‚ç‚¹å’Œforwardçš„èŠ‚ç‚¹ä¹‹é—´è·³è¿‡çš„æ•°æ®ä¸ªæ•°ï¼Œä½¿ç”¨spançš„ç›®çš„æ˜¯skipListæä¾›ä¸ä»…æä¾›äº†æŒ‰scoreæ’åºæŸ¥æ‰¾çš„èƒ½åŠ›ï¼Œä¹Ÿæä¾›äº†éšæœºè®¿é—®çš„èƒ½åŠ›ï¼ˆzslGetElementByRankï¼‰ã€‚å¦‚æœæ²¡æœ‰spanï¼Œæˆ‘ä»¬å¯ä»¥è§†<code>level0</code>çš„æ•°æ®ä¸ºå•é“¾è¡¨ï¼Œéšæœºè®¿é—®çš„æ—¶é—´å¤æ‚åº¦ä¸º<code>O(N)</code>ï¼Œä½¿ç”¨spanåï¼Œéšæœºè®¿é—®çš„æ—¶é—´å¯ä»¥åšåˆ°<code>O(logN)</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">typedef struct zskiplistNode &#123;
    sds ele;
    double score;
    struct zskiplistNode *backward;
    struct zskiplistLevel &#123;
        struct zskiplistNode *forward;
        unsigned long span;
    &#125; level[];
&#125; zskiplistNode;

typedef struct zskiplist &#123;
    struct zskiplistNode *header, *tail;
    unsigned long length;
    int level;
&#125; zskiplist;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸‹å›¾ä¸ºè·³è¡¨æ•°æ®ç»“æ„çš„å›¾ä¾‹<br>
<img src="/posts/7b62b471/skiplist.svg" alt="è·³è¡¨æ•°æ®ç»“æ„"></p>
<h2 id="skipListæ“ä½œ">skipListæ“ä½œ</h2>
<h3 id="åˆ›å»º">åˆ›å»º</h3>
<p>è·³è¡¨çš„åˆ›å»ºæ¯”è¾ƒç®€å•ï¼Œåªæ˜¯åˆ†é…çš„ç©ºé—´å’Œåˆå§‹åŒ–æ•°æ®ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œredis5è·³è¡¨ä¸­çš„levelç°åœ¨å·²ç»é»˜è®¤ä¸º64å±‚ï¼Œè€Œä¸æ˜¯ç½‘ä¸Šè€ç‰ˆæœ¬çš„32å±‚äº†ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;&#x2F; åˆ›å»ºè·³è¡¨
zskiplist *zslCreate(void) &#123;
    int j;
    zskiplist *zsl;

    zsl &#x3D; zmalloc(sizeof(*zsl));
    zsl-&gt;level &#x3D; 1;
    zsl-&gt;length &#x3D; 0;
    &#x2F;&#x2F; ZSKIPLIST_MAXLEVEL &#x3D;&#x3D; 64
    zsl-&gt;header &#x3D; zslCreateNode(ZSKIPLIST_MAXLEVEL,0,NULL);
    for (j &#x3D; 0; j &lt; ZSKIPLIST_MAXLEVEL; j++) &#123;
        zsl-&gt;header-&gt;level[j].forward &#x3D; NULL;
        zsl-&gt;header-&gt;level[j].span &#x3D; 0;
    &#125;
    zsl-&gt;header-&gt;backward &#x3D; NULL;
    zsl-&gt;tail &#x3D; NULL;
    return zsl;
&#125;

&#x2F;&#x2F; åˆ›å»ºnode
zskiplistNode *zslCreateNode(int level, double score, sds ele) &#123;
    zskiplistNode *zn &#x3D;
        zmalloc(sizeof(*zn)+level*sizeof(struct zskiplistLevel));
    zn-&gt;score &#x3D; score;
    zn-&gt;ele &#x3D; ele;
    return zn;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="æ’å…¥">æ’å…¥</h3>
<p>è·³è¡¨çš„æ’å…¥åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤</p>
<ol>
<li>æ‰¾åˆ°æ’å…¥å…ƒç´ çš„ä½ç½®ï¼Œå¹¶è®°å½•ç´¢å¼•ã€‚</li>
<li>è®¡ç®—æ’å…¥èŠ‚ç‚¹çš„levelï¼Œlevelçš„å€¼æ˜¯éšæœºçš„ï¼Œæœ€å¤§ä¸º64ï¼Œæ¯å±‚è¢«é€‰ä¸­çš„æ¦‚ç‡æ˜¯0.25ã€‚è¿™éƒ¨åˆ†åœ¨<code>zslRandomLevel</code></li>
<li>æ’å…¥èŠ‚ç‚¹ï¼Œæ›´æ–°æ¯å±‚forwardè¿æ¥å…³ç³»</li>
<li>è°ƒæ•´æ¯å±‚è¿æ¥ä¹‹é—´çš„spanå…³ç³»</li>
<li>è°ƒæ•´å›é€€æŒ‡é’ˆ</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">#define ZSKIPLIST_MAXLEVEL 64 &#x2F;* Should be enough for 2^64 elements *&#x2F;
#define ZSKIPLIST_P 0.25      &#x2F;* Skiplist P &#x3D; 1&#x2F;4 *&#x2F;
&#x2F;&#x2F; æ¯å±‚è¢«é€‰æ‹©çš„æ¦‚ç‡æ˜¯0.25
int zslRandomLevel(void) &#123;
    int level &#x3D; 1;
    while ((random()&amp;0xFFFF) &lt; (ZSKIPLIST_P * 0xFFFF))
        level +&#x3D; 1;
    return (level&lt;ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">zskiplistNode *zslInsert(zskiplist *zsl, double score, sds ele) &#123;
    &#x2F;&#x2F; ZSKIPLIST_MAXLEVEL &#x3D;&#x3D; 64
    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;
    unsigned int rank[ZSKIPLIST_MAXLEVEL];
    int i, level;

    serverAssert(!isnan(score));
    x &#x3D; zsl-&gt;header;
    &#x2F;&#x2F; è®¡ç®—rankï¼Œrankçš„ç›®çš„æ˜¯åé¢æ›´æ–°è®¡ç®—span
    &#x2F;&#x2F; è®¡ç®—updateï¼Œupdateçš„ç›®çš„æ˜¯æ‰¾åˆ°æ¯ä¸ªlevelä¸­æ•°æ®æ’å…¥çš„ä½ç½®
    for (i &#x3D; zsl-&gt;level-1; i &gt;&#x3D; 0; i--) &#123;
        rank[i] &#x3D; i &#x3D;&#x3D; (zsl-&gt;level-1) ? 0 : rank[i+1];
        &#x2F;&#x2F; è¿™é‡Œå¯ä»¥çœ‹å¾—è·³è¡¨ä½¿ç”¨scoreæ’åºï¼Œå¦‚æœä½¿ç”¨scoreç›¸åŒï¼Œä½¿ç”¨eleå†æ¬¡æ’åº
        while (x-&gt;level[i].forward &amp;&amp;
                (x-&gt;level[i].forward-&gt;score &lt; score ||
                    (x-&gt;level[i].forward-&gt;score &#x3D;&#x3D; score &amp;&amp;
                    sdscmp(x-&gt;level[i].forward-&gt;ele,ele) &lt; 0)))
        &#123;
            rank[i] +&#x3D; x-&gt;level[i].span;
            x &#x3D; x-&gt;level[i].forward;
        &#125;
        update[i] &#x3D; x;
    &#125;
    
    &#x2F;&#x2F; æ’å…¥çš„æ•°æ®éšæœºé€‰æ‹©ä¸ªlevel
    level &#x3D; zslRandomLevel();
    &#x2F;&#x2F; å¦‚æœé€‰æ‹©çš„levelå¤§äºäº†å½“å‰è·³è¡¨æœ€å¤§levelï¼Œæ›´æ–°æœ€å¤§levelå¹¶åˆå§‹åŒ–æ•°æ®
    if (level &gt; zsl-&gt;level) &#123;
        for (i &#x3D; zsl-&gt;level; i &lt; level; i++) &#123;
            rank[i] &#x3D; 0;
            update[i] &#x3D; zsl-&gt;header;
            update[i]-&gt;level[i].span &#x3D; zsl-&gt;length;
        &#125;
        zsl-&gt;level &#x3D; level;
    &#125;
    &#x2F;&#x2F; åˆ›å»ºæ’å…¥node
    x &#x3D; zslCreateNode(level,score,ele);
    for (i &#x3D; 0; i &lt; level; i++) &#123;
        x-&gt;level[i].forward &#x3D; update[i]-&gt;level[i].forward;
        update[i]-&gt;level[i].forward &#x3D; x;

        &#x2F;* update span covered by update[i] as x is inserted here *&#x2F;
        x-&gt;level[i].span &#x3D; update[i]-&gt;level[i].span - (rank[0] - rank[i]);
        update[i]-&gt;level[i].span &#x3D; (rank[0] - rank[i]) + 1;
    &#125;

    &#x2F;* increment span for untouched levels *&#x2F;
    for (i &#x3D; level; i &lt; zsl-&gt;level; i++) &#123;
        update[i]-&gt;level[i].span++;
    &#125;
    &#x2F;&#x2F; æ›´æ–°å›é€€æŒ‡é’ˆ
    x-&gt;backward &#x3D; (update[0] &#x3D;&#x3D; zsl-&gt;header) ? NULL : update[0];
    if (x-&gt;level[0].forward)
        x-&gt;level[0].forward-&gt;backward &#x3D; x;
    else
        zsl-&gt;tail &#x3D; x;
    zsl-&gt;length++;
    return x;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="æ ¹æ®scoreæŸ¥æ‰¾">æ ¹æ®scoreæŸ¥æ‰¾</h3>
<p>è·³è¡¨æä¾›äº†é€šè¿‡rangeå»åŒ¹é…scoreçš„æ¥å£ï¼Œ<code>zslFirstInRange</code>å’Œ<code>zslLastInRange</code><br>
è¿™é‡Œæ³¨æ„ä¸‹<code>zrangespec</code>ï¼Œè¿™ä¸ªç»“æ„ä½“æ‰“åŒ…äº†minå’Œmaxï¼Œå¹¶ä¸”æŒ‡å®šäº†æ¯”è¾ƒæ—¶æ˜¯å¦åŒ…å«minå’Œmaxã€‚è·³è¡¨æ¶‰åŠåˆ°scoreæ—¶éƒ½ä½¿ç”¨<code>zrangespec</code>è¡¨ç¤ºåŒ¹é…çš„èŒƒå›´</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">typedef struct &#123;
    double min, max;
    int minex, maxex; &#x2F;* are min or max exclusive? *&#x2F;
&#125; zrangespec;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æŸ¥æ‰¾æ¯”è¾ƒç®€å•ï¼Œåœ¨levelå±‚çº§ä¸­ä¸€å±‚å±‚æ¯”è¾ƒå°±è¡Œäº†ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">zskiplistNode *zslFirstInRange(zskiplist *zsl, zrangespec *range) &#123;
    zskiplistNode *x;
    int i;

    &#x2F;* If everything is out of range, return early. *&#x2F;
    if (!zslIsInRange(zsl,range)) return NULL;

    x &#x3D; zsl-&gt;header;
    for (i &#x3D; zsl-&gt;level-1; i &gt;&#x3D; 0; i--) &#123;
        &#x2F;* Go forward while *OUT* of range. *&#x2F;
        while (x-&gt;level[i].forward &amp;&amp;
            !zslValueGteMin(x-&gt;level[i].forward-&gt;score,range))
                x &#x3D; x-&gt;level[i].forward;
    &#125;

    &#x2F;* This is an inner range, so the next node cannot be NULL. *&#x2F;
    x &#x3D; x-&gt;level[0].forward;
    serverAssert(x !&#x3D; NULL);

    &#x2F;* Check if score &lt;&#x3D; max. *&#x2F;
    if (!zslValueLteMax(x-&gt;score,range)) return NULL;
    return x;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="éšæœºè®¿é—®">éšæœºè®¿é—®</h3>
<p>è·³è¡¨è¿˜æä¾›äº†æŒ‰ä¸‹æ ‡éšæœºè®¿é—®ï¼Œæ³¨æ„ä¸‹æ ‡æ˜¯ä»1å¼€å§‹çš„ã€‚<br>
spançš„ä½œç”¨åœ¨è¿™é‡Œå°±ä½“ç°äº†ï¼Œå®ƒè®°å½•äº†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è·ç¦»ï¼Œæ²¡æœ‰è¿™ä¸ªè·ç¦»æˆ‘ä»¬åªèƒ½ä½¿ç”¨level[0]å»é¡ºåºè®¿é—®ï¼Œé¡ºåºè®¿é—®çš„æ—¶é—´å¤æ‚åº¦æ˜¯<code>O(N)</code>ã€‚ç°åœ¨æœ‰äº†è¿™ä¸ªspanï¼Œæˆ‘ä»¬å¯ä»¥é‡levelä¸Šå±‚å¼€å§‹éå†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸Šè·³è¡¨çš„å¤šçº§ç´¢å¼•ï¼Œæ—¶é—´å¤æ‚åº¦é™ä½åˆ°<code>O(logN)</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">zskiplistNode* zslGetElementByRank(zskiplist *zsl, unsigned long rank) &#123;
    zskiplistNode *x;
    unsigned long traversed &#x3D; 0;
    int i;

    x &#x3D; zsl-&gt;header;
    for (i &#x3D; zsl-&gt;level-1; i &gt;&#x3D; 0; i--) &#123;
        while (x-&gt;level[i].forward &amp;&amp; (traversed + x-&gt;level[i].span) &lt;&#x3D; rank)
        &#123;
            traversed +&#x3D; x-&gt;level[i].span;
            x &#x3D; x-&gt;level[i].forward;
        &#125;
        if (traversed &#x3D;&#x3D; rank) &#123;
            return x;
        &#125;
    &#125;
    return NULL;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
]]></content>
      <categories>
        <category>redis</category>
      </categories>
      <tags>
        <tag>redisæºç </tag>
        <tag>redisæ•°æ®ç»“æ„</tag>
      </tags>
  </entry>
  <entry>
    <title>ziplistå‹ç¼©åˆ—è¡¨</title>
    <url>/posts/2bd24f59.html</url>
    <content><![CDATA[<blockquote>
<p><strong>æœ¬æ–‡æºç <a href="https://download.redis.io/releases/redis-5.0.12.tar.gz">redis5.0.12</a></strong><br>
å‹ç¼©åˆ—è¡¨çš„å®šä¹‰åœ¨<code>ziplist.h</code>ä¸­ï¼Œå®ç°åœ¨<code>ziplist.c</code></p>
</blockquote>
<p>å‹ç¼©åˆ—è¡¨å’Œå…¶ä»–å‡ ä¸ªæ•°æ®ç»“æ„è¿˜ä¸å¤ªä¸€æ ·ï¼Œå¾ˆéš¾ç›´æ¥æƒ³åˆ°æœ‰ä»€ä¹ˆåº”ç”¨åœºæ™¯ï¼Œè€Œä¸”å‹ç¼©åˆ—è¡¨çš„<code>å‹ç¼©</code>ä¸¤å­—å°±æ³¨æ˜äº†è¿™æ˜¯ä¸€ä¸ªä¸å¯»å¸¸çš„æ•°æ®ç»“æ„ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨<code>ziplist.h</code>ä¸­æ‰¾åˆ°å®˜æ–¹å¯¹ziplistçš„å®šä¹‰</p>
<ul>
<li>ziplistæ˜¯ä¸€ä¸ªç»è¿‡ç‰¹æ®Šç¼–ç çš„ åŒå‘é“¾è¡¨ ï¼Œå®ƒçš„è®¾è®¡ç›®æ ‡å°±æ˜¯ä¸ºäº†æé«˜å­˜å‚¨æ•ˆç‡ã€‚ziplistå¯ä»¥ç”¨äºå­˜å‚¨å­—ç¬¦ä¸²æˆ–æ•´æ•°ï¼Œå…¶ä¸­æ•´æ•°æ˜¯æŒ‰çœŸæ­£çš„äºŒè¿›åˆ¶è¡¨ç¤ºè¿›è¡Œç¼–ç çš„ï¼Œè€Œä¸æ˜¯ç¼–ç æˆå­—ç¬¦ä¸²åºåˆ—ã€‚ å®ƒèƒ½ä»¥<code>O(1)</code>çš„æ—¶é—´å¤æ‚åº¦åœ¨è¡¨çš„ä¸¤ç«¯æä¾›<code>push</code>å’Œ<code>pop</code>æ“ä½œã€‚ä½†æ˜¯ç”±äºæ¯ä¸ªæ“ä½œéƒ½éœ€è¦é‡æ–°åˆ†é…å†…å­˜ï¼Œ<code>å®é™…çš„å¤æ‚åº¦</code>å’Œziplistä½¿ç”¨çš„å†…å­˜é‡æœ‰å…³</li>
<li>ä»è¿™æ®µå®šä¹‰ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºziplistçš„å®šä½æ˜¯å°æ•°æ®é‡ä¸‹çš„é«˜æ•ˆå†…å­˜å­˜å‚¨</li>
<li><code>hash</code>å’Œ<code>sorted set</code>åœ¨æ•°æ®é‡æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹éƒ½ä½¿ç”¨äº†ziplist</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;* The ziplist is a specially encoded dually linked list that is designed
 * to be very memory efficient. It stores both strings and integer values,
 * where integers are encoded as actual integers instead of a series of
 * characters. It allows push and pop operations on either side of the list
 * in O(1) time. However, because every operation requires a reallocation of
 * the memory used by the ziplist, the actual complexity is related to the
 * amount of memory used by the ziplist.
 * &#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
 <span id="more"></span>
<h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2>
<p>å’Œå…¶ä»–æ•°æ®ç±»å‹ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬åœ¨<code>ziplist.h</code>ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç»“æ„ä½“çš„å®šä¹‰<br>
æˆ‘ä»¬åœ¨æ¥çœ‹ä¸‹åˆ›å»ºziplistçš„ä»£ç ï¼Œå¥½å®¶ä¼™ï¼Œziplistå°±æ˜¯ä¸ªä¸€ç»´æ•°ç»„</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;* Create a new empty ziplist. *&#x2F;
unsigned char *ziplistNew(void) &#123;
    unsigned int bytes &#x3D; ZIPLIST_HEADER_SIZE+ZIPLIST_END_SIZE;
    unsigned char *zl &#x3D; zmalloc(bytes);
    ZIPLIST_BYTES(zl) &#x3D; intrev32ifbe(bytes);
    ZIPLIST_TAIL_OFFSET(zl) &#x3D; intrev32ifbe(ZIPLIST_HEADER_SIZE);
    ZIPLIST_LENGTH(zl) &#x3D; 0;
    zl[bytes-1] &#x3D; ZIP_END;
    return zl;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œæˆ‘ä»¬è¦å›åˆ°<code>ziplist.h</code>ä¸­ï¼Œå®˜æ–¹å¾ˆè¯¦ç»†çš„å†™äº†ziplistçš„è®¾è®¡æ€è·¯</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;* ZIPLIST OVERALL LAYOUT
* &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
*
* The general layout of the ziplist is as follows:
*
* &lt;zlbytes&gt; &lt;zltail&gt; &lt;zllen&gt; &lt;entry&gt; &lt;entry&gt; ... &lt;entry&gt; &lt;zlend&gt;
* â€¦â€¦â€¦â€¦â€¦â€¦
* &#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
]]></content>
      <categories>
        <category>redis</category>
      </categories>
      <tags>
        <tag>redisæºç </tag>
        <tag>redisæ•°æ®ç»“æ„</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆè§BeanFactory</title>
    <url>/posts/f5f30183.html</url>
    <content><![CDATA[<blockquote>
<p>æœ¬æ–‡åŸºäº<code>Spring Boot 2.7.9</code>ä¸<code>Spring Framework 5.3.25</code></p>
</blockquote>
<p>BeanFactoryï¼ŒSpring IOCæ ¸å¿ƒæ¥å£ï¼Œæ‰¿æ‹…äº†Beanç®¡ç†çš„èŒè´£ã€‚æœ¬æ–‡æ¥çœ‹çœ‹BeanFactoryåœ¨Springä½“ç³»ä¸­æ˜¯æ€ä¹ˆå‘æŒ¥ä½œç”¨çš„</p>
<span id="more"></span>
<h2 id="å‰è¨€">å‰è¨€</h2>
<p>ä»ä¾èµ–å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒBeanFactoryæ¥å£ä¾èµ–ç›¸å¯¹ç®€å•</p>
<p><img src="/posts/f5f30183/BeanFactory.svg" alt="BeanFactory"></p>
<ul>
<li><code>BeanFactory</code>æ˜¯æœ€åº•å±‚çš„ç±»ï¼Œæä¾›äº†ç®€å•çš„beanè·å–å’Œbeanä¿¡æ¯è·å–çš„èƒ½åŠ›</li>
<li>ListableBeanFactoryï¼ŒHierarchicalBeanFactoryï¼ŒAutowireCapableBeanFactoryç»§æ‰¿BeanFactoryï¼Œæä¾›äº†æ›´ä¸ºé«˜çº§çš„æŠ½è±¡
<ul>
<li><code>ListableBeanFactory</code>ï¼šå¯ä»¥ä¸€æ¬¡è·å–å¤šä¸ªbean</li>
<li><code>HierarchicalBeanFactory</code>ï¼šæä¾›è·å–çˆ¶çº§BeanFactoryèƒ½åŠ›</li>
<li><code>AutowireCapableBeanFactory</code>ï¼šæä¾›è‡ªåŠ¨è£…é…çš„èƒ½åŠ›</li>
</ul>
</li>
<li><code>ConfigurableBeanFactory</code>ç»§æ‰¿äº†HierarchicalBeanFactoryï¼Œä¸ºBeanFactoryæä¾›äº†BeanPostProcessorï¼Œä¾èµ–å…³ç³»å¤„ç†ï¼Œæ‰‹åŠ¨æ³¨å†Œbeanç­‰èƒ½åŠ›</li>
<li><code>ConfigurableListableBeanFactory</code>ï¼šç»§æ‰¿äº†ListableBeanFactoryï¼ŒHierarchicalBeanFactoryï¼ŒAutowireCapableBeanFactoryï¼Œæä¾›é«˜çº§ç®¡ç†èƒ½åŠ›ï¼Œå¦‚ï¼šbeané¢„åˆå§‹åŒ–ï¼ŒBeanFactoryå†»ç»“ç­‰</li>
<li>Springæä¾›äº†å››ç§BeanFactoryçš„å®ç°ï¼šXmlBeanFactoryï¼ŒSimpleJndiBeanFactoryï¼ŒStaticListableBeanFactoryå’ŒDefaultListableBeanFactory
<ul>
<li><code>XmlBeanFactory</code>ï¼šç»§æ‰¿äºDefaultListableBeanFactoryï¼Œå®˜æ–¹å·²ç»ä¸æ¨èä½¿ç”¨ï¼Œæ¨èä½¿ç”¨DefaultListableBeanFactory</li>
<li><code>SimpleJndiBeanFactory</code>ï¼šåŸºäºJNDIå»åŠ è½½beanï¼Œç›´æ¥ç»§æ‰¿äº†BeanFactoryï¼Œç”±äºJNDIå·²ç»æ…¢æ…¢æ·¡å‡ºçš„javaä½“ç³»ï¼Œæœ¬æ–‡å°±ä¸å†åˆ†æè¯¥BeanFactoryäº†</li>
<li><code>StaticListableBeanFactory</code>ï¼šç®€å•çš„BeanFactoryå®ç°ï¼Œåº•å±‚é€šè¿‡Map&lt;String,Object&gt;ä¿å­˜beanï¼Œåªèƒ½æ‰‹åŠ¨æ·»åŠ bean</li>
<li><code>DefaultListableBeanFactory</code>ï¼šspringç§æœ€æ ¸å¿ƒçš„BeanFactoryï¼ŒSpringæ‰€æœ‰åŠŸèƒ½éƒ½æ˜¯å›´ç»•è¯¥BeanFactoryå®Œæˆçš„ï¼Œæä¾›äº†å®Œæ•´çš„beanç®¡ç†èƒ½åŠ›</li>
</ul>
</li>
</ul>
<h3 id="BeanFactory">BeanFactory</h3>
<p>BeanFactoryé¡¾åæ€ä¹‰ï¼Œä½œä¸ºBeançš„å·¥å‚ï¼Œæ˜¯IOCä¸­ç»å¯¹æ ¸å¿ƒï¼Œä¹Ÿæ˜¯Beanå·¥å‚ä¸­æœ€å•çº¯çš„</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public interface BeanFactory &#123;

  &#x2F;**
    * å·¥å‚beançš„ç‰¹æœ‰å‰ç¼€
    * æ‰€æœ‰FactoryBeançš„åç§°éƒ½ä»¥&amp;å¼€å¤´
    * æ‰€æœ‰ä»¥&amp;å¼€å¤´çš„beanéƒ½è¢«è®¤ä¸ºæ˜¯FactoryBean
    *&#x2F;
    String FACTORY_BEAN_PREFIX &#x3D; &quot;&amp;&quot;;

   &#x2F;**
    * ä»BeanFactoryä¸­è·å–ä¸€ä¸ªBeanï¼Œ
    * å¦‚æœè¯¥BeanFactoryåŒ…å«çˆ¶BeanFactoryï¼Œä¼šå»çˆ¶BeanFactoryæŸ¥æ‰¾
    * æ³¨æ„ï¼ŒBeanFactoryçš„æ–¹æ³•åªèƒ½è·å–åˆ°ä¸€ä¸ªbean
    * å¦‚æœæœ‰beanè®¾ç½®äº†Primaryå±æ€§ï¼Œä¼˜å…ˆè·å–ï¼Œå¦‚æœéƒ½æ²¡æœ‰ï¼Œè·å–æœ€åä¸€ä¸ª
    *&#x2F;
    Object getBean(String name) throws BeansException;
    &lt;T&gt; T getBean(String name, Class&lt;T&gt; requiredType) throws BeansException;
    Object getBean(String name, Object... args) throws BeansException;
    &lt;T&gt; T getBean(Class&lt;T&gt; requiredType) throws BeansException;
    &lt;T&gt; T getBean(Class&lt;T&gt; requiredType, Object... args) throws BeansException;
    &lt;T&gt; ObjectProvider&lt;T&gt; getBeanProvider(Class&lt;T&gt; requiredType);
    &lt;T&gt; ObjectProvider&lt;T&gt; getBeanProvider(ResolvableType requiredType);

   &#x2F;**
    * åˆ¤æ–­æ˜¯å¦åŒ…å«ç‰¹å®šnameçš„bean
    * å¦‚æœè¯¥BeanFactoryåŒ…å«çˆ¶BeanFactoryï¼Œä¼šå»çˆ¶BeanFactoryæŸ¥æ‰¾
    *&#x2F;
    boolean containsBean(String name);

  &#x2F;**
    * åˆ¤æ–­ç»™å®šbeanæ˜¯Singletonè¿˜æ˜¯Prototype
    *&#x2F;
    boolean isSingleton(String name) throws NoSuchBeanDefinitionException;
    boolean isPrototype(String name) throws NoSuchBeanDefinitionException;

   &#x2F;**
    * åˆ¤æ–­ç»™å®šbeanæ˜¯å¦å’Œç‰¹å®šçš„typeåŒ¹é…
    *&#x2F;
    boolean isTypeMatch(String name, ResolvableType typeToMatch) throws NoSuchBeanDefinitionException;
    boolean isTypeMatch(String name, Class&lt;?&gt; typeToMatch) throws NoSuchBeanDefinitionException;
    
   &#x2F;**
    * è·å–ç»™å®šbeançš„typeæ˜¯ä»€ä¹ˆ
    *&#x2F;
    @Nullable
    Class&lt;?&gt; getType(String name) throws NoSuchBeanDefinitionException;
    @Nullable
    Class&lt;?&gt; getType(String name, boolean allowFactoryBeanInit) throws NoSuchBeanDefinitionException;

    &#x2F;**
    * è·å–beançš„åˆ«å
    *&#x2F;
    String[] getAliases(String name);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»æ¥å£å®šä¹‰ä¸­å¯ä»¥çœ‹å‡ºï¼ŒBeanFactoryæä¾›ä»¥ä¸‹èƒ½åŠ›</p>
<ul>
<li>å®šä¹‰äº†å·¥å‚beançš„æ½œè§„åˆ™</li>
<li>æ ¹æ®nameæˆ–typeè·å–bean</li>
<li>è·å–beanä½œç”¨åŸŸ</li>
<li>beanå’Œç‰¹å®štypeæ˜¯å¦åŒ¹é…</li>
<li>è·å–beanåˆ«å</li>
</ul>
<p>ä»BeanFactoryèƒ½åŠ›ä¸Šçœ‹ï¼Œåªèƒ½ä¸€ä¸ªä¸€ä¸ªè·å–å¯¹åº”ä¿¡æ¯<br>
å¦‚æœå¯¹åº”çš„BeanFactoryæœ‰ç»§æ‰¿å…³ç³»ï¼Œæ‰€æœ‰å¯¹beançš„æŸ¥æ‰¾éƒ½ä¼šæŸ¥çœ‹çˆ¶BeanFactory</p>
<h3 id="ListableBeanFactory">ListableBeanFactory</h3>
<p>ListableBeanFactoryæ˜¯Springå®˜æ–¹æ¨èä½¿ç”¨çš„BeanFactoryï¼Œæ¯•ç«ŸSpringä¸­å”¯ä¸€å¤§é‡ä½¿ç”¨çš„BeanFactoryå«åš<code>DefaultListableBeanFactory</code><br>
ListableBeanFactoryå’ŒBeanFactoryæ¥å£å’‹ä¸€çœ‹å¾ˆåƒï¼Œæä¾›äº†ä¸€æ¬¡è·å–å¤šä¸ªbeançš„æ–¹æ³•ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰äº›ç»†å¾®çš„å·®åˆ«</p>
<ul>
<li>å¯¹å¯ç»§æ‰¿çš„BeanFactoryï¼ŒBeanFactoryä¼šå»æ£€æµ‹çˆ¶BeanFactoryï¼Œè€ŒListableBeanFactoryä¸ä¼š</li>
<li>å¯¹é€šè¿‡<code>registerSingleton</code>æ‰‹åŠ¨åŠ å…¥çš„beanï¼ŒBeanFactoryçš„getBeanæ–¹æ³•å¯ä»¥è·å–åˆ°ï¼Œè€ŒListableBeanFactoryä¸­è·å–beançš„æ–¹æ³•å‡è·å–ä¸åˆ°ï¼Œ</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public interface ListableBeanFactory extends BeanFactory &#123;

   &#x2F;**
    * æ£€æŸ¥å½“å‰å®¹å™¨çš„BeanDefinition
    *&#x2F;
    boolean containsBeanDefinition(String beanName);
    int getBeanDefinitionCount();
    String[] getBeanDefinitionNames();

   &#x2F;**
    * è·å–beanï¼Œè¿™é‡Œå¼•å…¥äº†å»¶è¿ŸåŠ è½½çš„æ¦‚å¿µ
    *&#x2F;
    &lt;T&gt; ObjectProvider&lt;T&gt; getBeanProvider(Class&lt;T&gt; requiredType, boolean allowEagerInit);
    &lt;T&gt; ObjectProvider&lt;T&gt; getBeanProvider(ResolvableType requiredType, boolean allowEagerInit);

   &#x2F;**
    * æä¾›äº†æ›´ä¸°å¯Œçš„è·å–beançš„æ‰‹æ®µï¼Œä½†å¯¹æ‰‹åŠ¨æ³¨å†Œçš„beanä¸èƒ½è·å–
    * å¯ä»¥ä¸€æ¬¡è·å–æ»¡è¶³æ¡ä»¶çš„ä¸€ç³»åˆ—bean
    * å¯ä»¥æ§åˆ¶beanè·å–æ˜¯å¦è¦å»¶è¿ŸåŠ è½½
    * å¯ä»¥æ§åˆ¶è·å–beanæ˜¯å¦ä¸ºsingletons
    *&#x2F;
    String[] getBeanNamesForType(ResolvableType type);
    String[] getBeanNamesForType(ResolvableType type, boolean includeNonSingletons, boolean allowEagerInit);
    String[] getBeanNamesForType(@Nullable Class&lt;?&gt; type);
    String[] getBeanNamesForType(@Nullable Class&lt;?&gt; type, boolean includeNonSingletons, boolean allowEagerInit);
    &lt;T&gt; Map&lt;String, T&gt; getBeansOfType(@Nullable Class&lt;T&gt; type) throws BeansException;
    &lt;T&gt; Map&lt;String, T&gt; getBeansOfType(@Nullable Class&lt;T&gt; type, boolean includeNonSingletons, boolean allowEagerInit) throws BeansException;
    String[] getBeanNamesForAnnotation(Class&lt;? extends Annotation&gt; annotationType);
    Map&lt;String, Object&gt; getBeansWithAnnotation(Class&lt;? extends Annotation&gt; annotationType) throws BeansException;
    @Nullable
    &lt;A extends Annotation&gt; A findAnnotationOnBean(String beanName, Class&lt;A&gt; annotationType) throws NoSuchBeanDefinitionException;
    @Nullable
    &lt;A extends Annotation&gt; A findAnnotationOnBean(String beanName, Class&lt;A&gt; annotationType, boolean allowFactoryBeanInit) throws NoSuchBeanDefinitionException;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="HierarchicalBeanFactory">HierarchicalBeanFactory</h3>
<p>HierarchicalBeanFactoryé€šè¿‡<code>getParentBeanFactory</code>å¼•å…¥äº†BeanFactoryåˆ†å±‚çš„æ€æƒ³ï¼Œå¯ä»¥å®šä¹‰çˆ¶å­ä¸¤ä¸ªBeanFactoryï¼Œä¸¤è€…ç›¸äº’ä¸å½±å“<br>
è¿™ç§åˆ†å±‚æ€æƒ³åœ¨Spring MVCä¸­å‘æŒ¥çš„æ·‹æ¼“å°½è‡´</p>
<ul>
<li>ä½¿ç”¨çˆ¶å®¹å™¨æ§åˆ¶æ•°æ®è®¿é—®ç­‰é€»è¾‘</li>
<li>ä½¿ç”¨å­å®¹å™¨æ§åˆ¶è§†å›¾å±‚é€»è¾‘</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public interface HierarchicalBeanFactory extends BeanFactory &#123;

   &#x2F;**
    * è·å–çˆ¶BeanFactory
    *&#x2F;
    @Nullable
    BeanFactory getParentBeanFactory();

   &#x2F;**
    * å½“å‰BeanFactoryæ˜¯åŒ…å«ç‰¹å®šåå­—çš„beanï¼Œä¸ä¼šå»æŸ¥æ‰¾çˆ¶BeanFactory
    *&#x2F;
    boolean containsLocalBean(String name);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="AutowireCapableBeanFactory">AutowireCapableBeanFactory</h3>
<p>AutowireCapableBeanFactoryç±»å¦‚å…¶åï¼Œå¯ä»¥æä¾›ä¾èµ–æ³¨å…¥èƒ½åŠ›<br>
è¿™é‡Œæœ‰ä¸ªå¾ˆå¥½çš„æ‰©å±•è®¾è®¡</p>
<blockquote>
<p>é€šå¸¸Springä¼šç®¡ç†æ‰€æœ‰beanåˆ›å»ºã€ä¾èµ–æ³¨å…¥è¿‡ç¨‹<br>
å¯¹äºå’Œä¸‰æ–¹æ¡†æ¶é›†æˆæ—¶ï¼Œæœ‰äº›å¯¹è±¡å¯èƒ½ä¸å—Springç®¡ç†ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨AutowireCapableBeanFactoryæ¥å•ç‹¬å¤„ç†è¿™äº›å¯¹è±¡ï¼Œæ¥äº«å—Springä½“ç³»æä¾›çš„èƒ½åŠ›<br>
<code>ApplicationContext</code>è¿”å›çš„å°±æ˜¯AutowireCapableBeanFactory</p>
</blockquote>
  <pre class="line-numbers language-java" data-language="java"><code class="language-java">AutowireCapableBeanFactory getAutowireCapableBeanFactory() throws IllegalStateException;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public interface AutowireCapableBeanFactory extends BeanFactory &#123;

   &#x2F;**
    * è‡ªåŠ¨æ³¨å…¥ç›¸å…³æšä¸¾
    *&#x2F;
   int AUTOWIRE_NO &#x3D; 0;
   int AUTOWIRE_BY_NAME &#x3D; 1;
   int AUTOWIRE_BY_TYPE &#x3D; 2;
   int AUTOWIRE_CONSTRUCTOR &#x3D; 3;
   @Deprecated
   int AUTOWIRE_AUTODETECT &#x3D; 4;

   &#x2F;**
    * çº¦å®šä¿—æˆ
    * ä»¥.ORIGINALç»“å°¾çš„beanNameï¼Œè·å–beanæ—¶ä¼šè¿”å›æœ€åŸå§‹çš„beanï¼Œè€Œä¸ä¼šè¿”å›ä»£ç†å¯¹è±¡ç­‰
    *&#x2F;
   String ORIGINAL_INSTANCE_SUFFIX &#x3D; &quot;.ORIGINAL&quot;;

   &#x2F;**
    * åˆ›å»ºbean
    *&#x2F;
   &lt;T&gt; T createBean(Class&lt;T&gt; beanClass) throws BeansException;
   Object createBean(Class&lt;?&gt; beanClass, int autowireMode, boolean dependencyCheck) throws BeansException;

   &#x2F;**
    * è£…é…ï¼Œæ³¨å…¥
    *&#x2F;
   void autowireBean(Object existingBean) throws BeansException;
   Object autowire(Class&lt;?&gt; beanClass, int autowireMode, boolean dependencyCheck) throws BeansException;
   void autowireBeanProperties(Object existingBean, int autowireMode, boolean dependencyCheck)
           throws BeansException;

   Object configureBean(Object existingBean, String beanName) throws BeansException;
   void applyBeanPropertyValues(Object existingBean, String beanName) throws BeansException;

   &#x2F;**
    * åˆå§‹åŒ–bean
    *&#x2F;
   Object initializeBean(Object existingBean, String beanName) throws BeansException;
   Object applyBeanPostProcessorsBeforeInitialization(Object existingBean, String beanName)
           throws BeansException;
   Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName)
           throws BeansException;

   &#x2F;**
    * é”€æ¯bean
    *&#x2F;
   void destroyBean(Object existingBean);


   &#x2F;**
    * è§£ææ³¨å…¥ç‚¹
    *&#x2F;
   &lt;T&gt; NamedBeanHolder&lt;T&gt; resolveNamedBean(Class&lt;T&gt; requiredType) throws BeansException;
   Object resolveBeanByName(String name, DependencyDescriptor descriptor) throws BeansException;
   @Nullable
   Object resolveDependency(DependencyDescriptor descriptor, @Nullable String requestingBeanName) throws BeansException;
   @Nullable
   Object resolveDependency(DependencyDescriptor descriptor, @Nullable String requestingBeanName,
                               @Nullable Set&lt;String&gt; autowiredBeanNames, @Nullable TypeConverter typeConverter) throws BeansException;

   &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ConfigurableBeanFactory">ConfigurableBeanFactory</h3>
<p>ç›¸æ¯”ä¸Šé¢çš„BeanFactoryï¼ŒConfigurableBeanFactoryæä¾›äº†å¯¹BeanFactoryçš„èƒ½åŠ›ï¼Œè¯¥æ¥å£ä¸€å…±æä¾›äº†40å¤šä¸ªæ–¹æ³•ï¼Œå¯¹BeanFactoryæä¾›å…¨æ–¹ä½é…ç½®èƒ½åŠ›</p>
<p>ConfigurableBeanFactoryä¸­å®šä¹‰äº†ä¸¤ä¸ªå¸¸è§çš„å¸¸é‡ï¼Œ<code>singleton</code>ï¼Œ<code>prototype</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public interface ConfigurableBeanFactory extends HierarchicalBeanFactory, SingletonBeanRegistry &#123;
    &#x2F;&#x2F; å•ä¾‹
    String SCOPE_SINGLETON &#x3D; &quot;singleton&quot;;
    &#x2F;&#x2F; å¤šå®ä¾‹
    String SCOPE_PROTOTYPE &#x3D; &quot;prototype&quot;;

    &#x2F;**
     * è®¾ç½®çˆ¶BeanFacotryï¼Œæä¾›åˆ†å±‚èƒ½åŠ›
     *&#x2F;
    void setParentBeanFactory(BeanFactory parentBeanFactory) throws IllegalStateException;

    &#x2F;**
     * ClassLoaderç›¸å…³
     *&#x2F;
    void setBeanClassLoader(@Nullable ClassLoader beanClassLoader);
    @Nullable
    ClassLoader getBeanClassLoader();

    &#x2F;**
     * ä¸´æ—¶ClassLoaderï¼Œå’ŒLoadTimeWavingæœ‰å…³
     *&#x2F;
    void setTempClassLoader(@Nullable ClassLoader tempClassLoader);
    @Nullable
    ClassLoader getTempClassLoader();

    &#x2F;**
     * æ˜¯å¦ç¼“å­˜BeanDefinitionï¼Œå¦‚æœéœ€è¦çƒ­åŠ è½½beanï¼Œéœ€è¦å°†ç¼“å­˜å…³é—­
     *&#x2F;
    void setCacheBeanMetadata(boolean cacheBeanMetadata);
    boolean isCacheBeanMetadata();

    &#x2F;**
     * ELè¡¨è¾¾å¼è§£æå™¨ç›¸å…³ï¼Œé»˜è®¤ä¸ºSpEL
     *&#x2F;
    void setBeanExpressionResolver(@Nullable BeanExpressionResolver resolver);
    @Nullable
    BeanExpressionResolver getBeanExpressionResolver();

    &#x2F;**
     * Springç±»å‹è½¬æ¢ç›¸å…³
     * XMLæ—¶ä»£ä¸»åŠ›PropertyEditorï¼ŒTypeConverteré…åˆPropertyEditorä¸€èµ·ä½¿ç”¨
     * ConversionServiceæ˜¯åç»­ç»§ä»»è€…
     *
     *&#x2F;
    void setConversionService(@Nullable ConversionService conversionService);
    @Nullable
    ConversionService getConversionService();
    void addPropertyEditorRegistrar(PropertyEditorRegistrar registrar);
    void registerCustomEditor(Class&lt;?&gt; requiredType, Class&lt;? extends PropertyEditor&gt; propertyEditorClass);
    void copyRegisteredEditorsTo(PropertyEditorRegistry registry);
    void setTypeConverter(TypeConverter typeConverter);
    TypeConverter getTypeConverter();

    &#x2F;**
     * å±æ€§è§£æå™¨ï¼Œç”¨äºè§£æ$&#123;&#125;ã€#&#123;&#125;å±æ€§
     *&#x2F;
    void addEmbeddedValueResolver(StringValueResolver valueResolver);
    boolean hasEmbeddedValueResolver();
    @Nullable
    String resolveEmbeddedValue(String value);

    &#x2F;**
     * å¤§åé¼é¼beanåç½®å¤„ç†å™¨
     *&#x2F;
    void addBeanPostProcessor(BeanPostProcessor beanPostProcessor);
    int getBeanPostProcessorCount();

    &#x2F;**
     * æ³¨å†Œscope
     * é™¤äº†å¸¸è§çš„singletonå’Œprototype
     * springè¿˜æä¾›äº†requestï¼Œsessionç­‰
     *&#x2F;
    void registerScope(String scopeName, Scope scope);
    String[] getRegisteredScopeNames();
    @Nullable
    Scope getRegisteredScope(String scopeName);

    &#x2F;**
     * æä¾›ApplicationStartup
     *&#x2F;
    void setApplicationStartup(ApplicationStartup applicationStartup);
    ApplicationStartup getApplicationStartup();

    &#x2F;**
     * è·å–javaå®‰å…¨è®¸å¯
     *&#x2F;
    AccessControlContext getAccessControlContext();

    &#x2F;**
     * Copy ConfigurableBeanFactory
     *&#x2F;
    void copyConfigurationFrom(ConfigurableBeanFactory otherFactory);

    &#x2F;**
     * åˆ«åç›¸å…³
     *&#x2F;
    void registerAlias(String beanName, String alias) throws BeanDefinitionStoreException;
    void resolveAliases(StringValueResolver valueResolver);

    &#x2F;**
     * åˆå¹¶å¹¶åˆ›å»ºRootBeanDefinition
     *&#x2F;
    BeanDefinition getMergedBeanDefinition(String beanName) throws NoSuchBeanDefinitionException;

    &#x2F;**
     * åˆ¤æ–­æ˜¯å¦å·¥å‚bean
     *&#x2F;
    boolean isFactoryBean(String name) throws NoSuchBeanDefinitionException;

    &#x2F;**
     * beanæ˜¯å¦åœ¨åˆ›å»ºä¸­
     *&#x2F;
    void setCurrentlyInCreation(String beanName, boolean inCreation);
    boolean isCurrentlyInCreation(String beanName);

    &#x2F;**
     * beanä¾èµ–ç›¸å…³
     *&#x2F;
    void registerDependentBean(String beanName, String dependentBeanName);
    String[] getDependentBeans(String beanName);
    String[] getDependenciesForBean(String beanName);

    &#x2F;**
     * beané”€æ¯ç›¸å…³
     *&#x2F;
    void destroyBean(String beanName, Object beanInstance);
    void destroyScopedBean(String beanName);
    void destroySingletons();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»æ¥å£å®šä¹‰çœ‹ï¼ŒConfigurableBeanFactoryä¸€å…±æä¾›äº†<code>40</code>ä¸ªæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æ¶‰åŠå¤šä¸ªé¢†åŸŸï¼Œä¸°å¯Œäº†BeanFactoryçš„èƒ½åŠ›</p>
<h3 id="ConfigurableListableBeanFactory">ConfigurableListableBeanFactory</h3>
<p>ConfigurableListableBeanFactoryå’ŒConfigurableBeanFactoryç›¸æ¯”æ›´è¿‘ä¸€æ­¥ï¼Œæä¾›äº†åˆ†æå’Œä¿®æ”¹beanå®šä¹‰ä»¥åŠé¢„å®ä¾‹åŒ–å•ä¾‹çš„å·¥å…·</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public interface ConfigurableListableBeanFactory extends ListableBeanFactory, AutowireCapableBeanFactory, ConfigurableBeanFactory &#123;

  &#x2F;**
   * å¿½ç•¥ä¾èµ–ï¼Œæ³¨å†Œä¾èµ–
   *&#x2F;
  void ignoreDependencyType(Class&lt;?&gt; type);
  void ignoreDependencyInterface(Class&lt;?&gt; ifc);
  void registerResolvableDependency(Class&lt;?&gt; dependencyType, @Nullable Object autowiredValue);

  &#x2F;**
   * è·å–beanæ˜¯å¦å¯ä»¥è‡ªåŠ¨æ³¨å…¥
   *&#x2F;
  boolean isAutowireCandidate(String beanName, DependencyDescriptor descriptor)
          throws NoSuchBeanDefinitionException;

  &#x2F;**
   * BeanFactoryä¸­å”¯ä¸€å¯ä»¥è·å–BeanDefinitionçš„æ–¹æ³•
   * æ„å‘³ç€å¯ä»¥ä¿®æ”¹beançš„å®šä¹‰
   *&#x2F;
  BeanDefinition getBeanDefinition(String beanName) throws NoSuchBeanDefinitionException;
  Iterator&lt;String&gt; getBeanNamesIterator();

  &#x2F;**
   * æ¸…ç©ºMergedBeanDefinitionç¼“å­˜
   * Springæ¡†æ¶ä¸­åªåœ¨BeanFactoryProcessoræ‰§è¡Œï¼Œå’ŒApplicationContextå¯åŠ¨æµç¨‹å¼ºç›¸å…³
   * åœ¨åç»­åˆ†ærefreshæ˜¯ä¼šå…³æ³¨
   *&#x2F;
  void clearMetadataCache();

  &#x2F;**
   * beanDefinitionå†»ç»“ç›¸å…³
   *&#x2F;
  void freezeConfiguration();
  boolean isConfigurationFrozen();

  &#x2F;**
   * é¢„å®ä¾‹åŒ–å•ä¾‹beanï¼Œabstractå’Œlazyé™¤å¤–
   *&#x2F;
  void preInstantiateSingletons() throws BeansException;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="StaticListableBeanFactory">StaticListableBeanFactory</h2>
<p>StaticListableBeanFactoryæ˜¯ä¸€ä¸ªæç®€çš„ListableBeanFactoryï¼Œåªèƒ½é€šè¿‡æ‰‹å·¥æ·»åŠ beanï¼Œæä¾›äº†è·å–/æ‰¹é‡è·å–beanç­‰èƒ½åŠ›ï¼Œåˆ†æStaticListableBeanFactoryå¯ä»¥ç®€å•ç†è§£BeanFactoryçš„ä¸€äº›è®¾è®¡æ€æƒ³</p>
<h3 id="å­˜å‚¨">å­˜å‚¨</h3>
<p>StaticListableBeanFactoryæˆå‘˜å˜é‡åªæœ‰ä¸€ä¸ªLinkedHashMapï¼Œbeançš„å¢åˆ æ”¹æŸ¥éƒ½æ˜¯å›´ç»•è¿™ä¸ªmapè¿›è¡Œçš„</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public class StaticListableBeanFactory implements ListableBeanFactory &#123;

  &#x2F;** Map from bean name to bean instance. *&#x2F;
  private final Map&lt;String, Object&gt; beans;


  &#x2F;**
   * Create a regular &#123;@code StaticListableBeanFactory&#125;, to be populated
   * with singleton bean instances through &#123;@link #addBean&#125; calls.
   *&#x2F;
  public StaticListableBeanFactory() &#123;
      this.beans &#x3D; new LinkedHashMap&lt;&gt;();
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="æ·»åŠ bean">æ·»åŠ bean</h3>
<p>åŒDefaultListableBeanFactoryç›¸æ¯”ï¼ŒStaticListableBeanFactoryæ²¡æœ‰ç»§æ‰¿<code>BeanDefinitionRegistry</code>æ¥å£ï¼Œè¯´æ˜äº†StaticListableBeanFactoryå’ŒBeanDefinitionæ— å…³ï¼Œæ³¨å®šäº†ä¸èƒ½é€šè¿‡xmlç­‰æ–¹å¼å®šä¹‰beanï¼Œåªèƒ½é€šè¿‡æ‰‹å·¥æ·»åŠ beanã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public void addBean(String name, Object bean) &#123;
    this.beans.put(name, bean);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="è·å–bean">è·å–bean</h3>
<p>è·å–beançš„ä»£ç å’Œç®€å•ï¼Œå…¶å®å°±æ˜¯åšäº†ä¸¤ä»¶äº‹</p>
<ol>
<li>ä½¿ç”¨transformedBeanNameå»mapä¸­è·å–bean</li>
<li>å¦‚æœæ˜¯FactoryBeanï¼Œä½¿ç”¨getObejctè¿”å›å¯¹è±¡ï¼Œå¦åˆ™ç›´æ¥è¿”å›å¯¹è±¡</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public Object getBean(String name) throws BeansException &#123;
  String beanName &#x3D; BeanFactoryUtils.transformedBeanName(name);
  Object bean &#x3D; this.beans.get(beanName);

  if (bean &#x3D;&#x3D; null) &#123;
      throw new NoSuchBeanDefinitionException(beanName,
              &quot;Defined beans are [&quot; + StringUtils.collectionToCommaDelimitedString(this.beans.keySet()) + &quot;]&quot;);
  &#125;

  &#x2F;&#x2F; Don&#39;t let calling code try to dereference the
  &#x2F;&#x2F; bean factory if the bean isn&#39;t a factory
  if (BeanFactoryUtils.isFactoryDereference(name) &amp;&amp; !(bean instanceof FactoryBean)) &#123;
      throw new BeanIsNotAFactoryException(beanName, bean.getClass());
  &#125;

  if (bean instanceof FactoryBean &amp;&amp; !BeanFactoryUtils.isFactoryDereference(name)) &#123;
      try &#123;
          Object exposedObject &#x3D; ((FactoryBean&lt;?&gt;) bean).getObject();
          if (exposedObject &#x3D;&#x3D; null) &#123;
              throw new BeanCreationException(beanName, &quot;FactoryBean exposed null object&quot;);
          &#125;
          return exposedObject;
      &#125;
      catch (Exception ex) &#123;
          throw new BeanCreationException(beanName, &quot;FactoryBean threw exception on object creation&quot;, ex);
      &#125;
  &#125;
  else &#123;
      return bean;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="DefaultListableBeanFactory">DefaultListableBeanFactory</h2>
<p>DefaultListableBeanFactoryæ˜¯Springå”¯ä¸€æ­£ç‰ŒBeanFactoryï¼Œæ‰€æœ‰Springç»„ä»¶éƒ½æ˜¯ç”¨çš„DefaultListableBeanFactoryï¼Œåç»­ä¼šæœ‰ä¸€ç³»åˆ—æ–‡ç« é€æ­¥æ‹†è§£DefaultListableBeanFactoryçš„å„ç§åŠŸèƒ½<br>
ä»ä¾èµ–å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼ŒDefaultListableBeanFactoryåœ¨å®ç°äº†ä¸Šæ–‡æåˆ°çš„æ‰€æœ‰æ¥å£çš„åŒæ—¶ï¼Œè¿˜å®ç°äº†<code>BeanDefinitionRegistry</code>ç”¨äºbeançš„æ³¨å†Œ<br>
åŒæ—¶åœ¨ä¾èµ–å›¾ä¸Šè¿˜å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªé‡ç‚¹è™šæ‹Ÿç±»ï¼Œè¿™ä¸ºåé¢æ‹†è§£DefaultListableBeanFactoryæä¾›äº†è·¯å¾„</p>
<ol>
<li>AbstractBeanFactory</li>
<li>AbstractAutowireCapableBeanFactory</li>
</ol>
<p><img src="/posts/f5f30183/DefaultListableBeanFactory.svg" alt="DefaultListableBeanFactory"></p>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring IOC</tag>
      </tags>
  </entry>
  <entry>
    <title>å‘çˆ¹çš„@target</title>
    <url>/posts/2ced797.html</url>
    <content><![CDATA[<blockquote>
<p>æœ¬æ–‡åŸºäºSpring Boot 2.4.5</p>
</blockquote>
<p>AOPæ˜¯Springä¸­æ¯”è¾ƒå¸¸ç”¨çš„ç¼–ç¨‹æŠ€å·§ï¼ŒAspectJå®šä¹‰pointcutä¹Ÿå¾ˆæ–¹ä¾¿ã€‚ç½‘ä¸Šçš„èµ„æ–™å¯¹<a href="https://endwas.cn/blog/75">AspectJ</a>çš„è¯­æ³•ä¹Ÿè®²è§£å¾ˆå¤šäº†ã€‚ä½†å¯¹<code>@target</code>å’Œ<code>@within</code>éƒ½è®²è§£çš„å¾ˆæ¨¡ç³Šï¼Œèƒ½æ‰¾åˆ°çš„è¯´æ˜ä¸€èˆ¬éƒ½æ˜¯ï¼š</p>
<ol>
<li>æˆ‘ä»¬å¯¹è¢«@targetã€@withinæ³¨è§£çš„ç±»ä¸­çš„æ–¹æ³•ä¼šè¿›è¡Œå¢å¼ºï¼Œä½†åªæœ‰@withinå­ç±»é‡å†™çš„æ–¹æ³•ä¼šç”Ÿæ•ˆã€‚</li>
<li>å¯¹äºè¢«@targetæ³¨è§£çš„å­ç±»ï¼Œè‹¥å­ç±»è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ï¼Œè€Œæ²¡æœ‰é‡å†™çˆ¶ç±»çš„æ–¹æ³•é‚£ä¹ˆå°±ä¼šè¢«å¢å¼ºï¼Œä½†@withinä¸ä¼šã€‚</li>
<li>å¯¹äºè¢«@withinæ³¨è§£çš„çˆ¶ç±»ï¼Œè‹¥çˆ¶ç±»æ–¹æ³•å­ç±»æ²¡æœ‰é‡å†™ï¼Œé‚£ä¹ˆå­ç±»è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ï¼Œå°±ä¼šè¢«å¢å¼ºï¼Œä½†@targetä¸ä¼š ï¼ˆ2ï¼Œ3åŒºåˆ«åœ¨äºä¸€ä¸ªæ˜¯@targetå­ç±»è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯å­ç±»è°ƒç”¨@withinçˆ¶ç±»çš„æ–¹æ³•ï¼‰</li>
<li>@targetã€@withinå¯¹å­ç±»æ–°å¢æ–¹æ³•éƒ½ä¸èµ·ä½œç”¨ã€‚</li>
</ol>
<p>å…¶å®åœ¨ä½¿ç”¨@targetä»¥åŠå…¶ä»–å‡ ä¸ªç±»ä¼¼çš„è¯­æ³•ä¼šç»™æˆ‘ä»¬ä¸€ä¸ªæƒŠå–œã€‚è¿™å—ç½‘ä¸Šå¾ˆå°‘æœ‰äººæåˆ°ï¼ŒåŒ…æ‹¬<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#aop-introductions">Spring Reference</a>ä¹Ÿæ²¡æœ‰è¯¦ç»†è¯´æ˜ï¼Œç½‘ä¸Šä¹Ÿæœ‰ç½‘å‹åœ¨é—®è¿™ä¸ªé—®é¢˜ï¼Œä¹Ÿæ²¡æœ‰å¥½çš„è§£ç­”ï¼š</p>
<blockquote>
<p><a href="https://ask.csdn.net/questions/758272">spring Aop @args() å¯¼è‡´å¯åŠ¨æŠ¥é”™</a><br>
<a href="https://segmentfault.com/q/1010000022320564">Spring aop @targetæ³¨è§£é—®é¢˜</a></p>
</blockquote>
<p>ç°åœ¨æˆ‘ä»¬æ¥ç¿»è¯‘ç¿»è¯‘ä»€ä¹ˆæ˜¯@targetçš„æƒŠå–œã€‚</p>
<span id="more"></span>
<h2 id="é—®é¢˜">é—®é¢˜</h2>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªå®é™…çš„åœºæ™¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ—¶ï¼Œä¸€ç§å†™æ³•å¦‚ä¸‹ï¼Œæˆ‘ä»¬ç›´æ¥æ‰«æbeanä¸Šé¢çš„annotationã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">@Component
public class StrategyFactory implements ApplicationContextAware &#123;
    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException &#123;
        Map&lt;String, Object&gt; beans &#x3D; applicationContext.getBeansWithAnnotation(StrategyMark.class);
        for (Map.Entry&lt;String, Object&gt; entry : beans.entrySet()) &#123;
            log.info(&quot;strategy:&#123;&#125;&quot;, entry.getValue().getClass().getAnnotation(StrategyMark.class));
        &#125;
    &#125;
&#125;

@Component
@StrategyMark(value &#x3D; &quot;hello-word&quot;)
public class HelloWordStrategy implements Strategy &#123;
    @Override
    public String execute() &#123;
        return &quot;helloWord&quot;;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»æ—¥å¿—å¯ä»¥çœ‹å‡ºï¼Œç°åœ¨ä»£ç ä¸€åˆ‡æ­£å¸¸ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">strategy:@com.polaris.he.target.annotation.StrategyMark(value&#x3D;hello-word)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ç°åœ¨éšç€ä¸šåŠ¡çš„å‘å±•ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªä¸šåŠ¡è·¯ç”±ï¼Œæ¯”å¦‚è¯»å†™åˆ†ç¦»ã€‚æˆ‘ä»¬å¸Œæœ›æ³¨è§£åˆ°classä¸Šï¼Œclassä¸Šæœ‰è¿™ä¸ªæ³¨è§£çš„éƒ½èµ°ä»åº“ã€‚åœ¨è¿™ä¸ªæ€è·¯çš„æŒ‡å¯¼ä¸‹ï¼Œå¾ˆå¿«å°±å¯ä»¥å†™æˆä¸‹é¢çš„ä»£ç ã€‚</p>
<blockquote>
<p><strong>è·¯ç”±çš„å®šä¹‰å’Œä¸Šé¢çš„ç­–ç•¥æ¨¡å¼å®Œå…¨æ²¡æœ‰ä»»ä½•å…³ç³»</strong></p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">@Router
public class StatServiceImpl &#123;
&#125;

@Aspect
@Component
public class RouteAspect &#123;
    &#x2F;&#x2F; ä¸ºä»€ä¹ˆåŠ withinï¼Ÿä¸åŠ withinï¼Œspringéƒ½ä¸èƒ½å¯åŠ¨ã€‚æƒŠå–œå§
    @Around(&quot;within(com.polaris.he.target..*) &amp;&amp; @target(com.polaris.he.target.annotation.Router)&quot;)
    public Object route(ProceedingJoinPoint pjp) throws Throwable &#123;
        return pjp.proceed();
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨æˆ‘ä»¬æ¥æ‰§è¡Œä¸‹ä»£ç </p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">strategy:null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>çœ‹å§ï¼Œè¿™å°±æ˜¯æƒŠå–œã€‚åŠ äº†ä¸ªæ¯«æ— å…³è”çš„@targetï¼Œå°±å†’ä¸€ä¸ªç©ºæŒ‡é’ˆå‡ºæ¥äº†ã€‚</p>
<h2 id="åˆ†æ">åˆ†æ</h2>
<p>å…ˆä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€ï¼Œæ‰“ä¸ªæ–­ç‚¹å†è¯´ã€‚ä¸€çœ‹è¿™ä¸‹å¥½å®¶ä¼™ï¼Œè¿™ä¸ªç±»è¢«ä»£ç†äº†ï¼Œä»£ç†ç±»ä¸Šé¢è‡ªç„¶æ²¡æœ‰anntationã€‚<br>
<img src="/posts/2ced797/1.jpg" alt="ä»£ç "><br>
ç°åœ¨é—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆä¼šè¢«ä»£ç†å‘¢ï¼Ÿ<br>
å¦‚æœä½ å¯¹Springæ¯”è¾ƒç†Ÿæ‚‰ï¼Œå¯ä»¥å®šä½åˆ°AOPå‘ç”Ÿä»£ç†çš„ä½ç½®<br>
<code>AbstractAutoProxyCreator.wrapIfNecessary(Object bean, String beanName, Object cacheKey)</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &#123;
 if (StringUtils.hasLength(beanName) &amp;&amp; this.targetSourcedBeans.contains(beanName)) &#123;
  return bean;
 &#125;
 if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) &#123;
  return bean;
 &#125;
 if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;
  this.advisedBeans.put(cacheKey, Boolean.FALSE);
  return bean;
 &#125;

 &#x2F;&#x2F; æ ¹æ®beanClasså’ŒbeanNameåˆ¤æ–­æ˜¯å¦æ˜¯éœ€è¦åˆ›å»ºproxy
 Object[] specificInterceptors &#x3D; getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);
 if (specificInterceptors !&#x3D; DO_NOT_PROXY) &#123;
  this.advisedBeans.put(cacheKey, Boolean.TRUE);
  Object proxy &#x3D; createProxy(
    bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));
  this.proxyTypes.put(cacheKey, proxy.getClass());
  return proxy;
 &#125;

 this.advisedBeans.put(cacheKey, Boolean.FALSE);
 return bean;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ ·ä¸€è·¯è·Ÿè¸ªä¸‹å»ï¼Œæˆ‘ä»¬èƒ½æ‰¾åˆ°è¿™ä¸ªé—®é¢˜çš„æ ¸å¿ƒæ–¹æ³•<code>AopUtils.canApply(Pointcut pc, Class&lt;?&gt; targetClass, boolean hasIntroductions)</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public static boolean canApply(Pointcut pc, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123;
 Assert.notNull(pc, &quot;Pointcut must not be null&quot;);
 if (!pc.getClassFilter().matches(targetClass)) &#123;
  return false;
 &#125;
 &#x2F;&#x2F; è¿™é‡Œåªæœ‰TruePointcutæ‰ä¼šè¿”å›MethodMatcher.TRUE
 &#x2F;&#x2F; æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Aspectè¯­æ³•ï¼Œå¯¹åº”çš„æ˜¯AspectJExpressionPointcut
 MethodMatcher methodMatcher &#x3D; pc.getMethodMatcher();
 if (methodMatcher &#x3D;&#x3D; MethodMatcher.TRUE) &#123;
  &#x2F;&#x2F; No need to iterate the methods if we&#39;re matching any method anyway...
  return true;
 &#125;

 IntroductionAwareMethodMatcher introductionAwareMethodMatcher &#x3D; null;
 if (methodMatcher instanceof IntroductionAwareMethodMatcher) &#123;
  introductionAwareMethodMatcher &#x3D; (IntroductionAwareMethodMatcher) methodMatcher;
 &#125;

 Set&lt;Class&lt;?&gt;&gt; classes &#x3D; new LinkedHashSet&lt;&gt;();
 if (!Proxy.isProxyClass(targetClass)) &#123;
  classes.add(ClassUtils.getUserClass(targetClass));
 &#125;
 classes.addAll(ClassUtils.getAllInterfacesForClassAsSet(targetClass));

 for (Class&lt;?&gt; clazz : classes) &#123;
  Method[] methods &#x3D; ReflectionUtils.getAllDeclaredMethods(clazz);
  &#x2F;&#x2F; è¿™é‡Œéå†classä¸­çš„æ¯ä¸€ä¸ªclassï¼Œçœ‹æ˜¯å¦æ»¡è¶³pointcut
  for (Method method : methods) &#123;
   if (introductionAwareMethodMatcher !&#x3D; null ?
     introductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions) :
     methodMatcher.matches(method, targetClass)) &#123;
    return true;
   &#125;
  &#125;
 &#125;
 return false;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬çŸ¥é“äº†<code>ntroductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions)</code>è¿™ä¸ªåˆ¤æ–­äº†æ˜¯ä¸æ˜¯æ»¡è¶³åˆ‡ç‚¹ï¼Œä»ä¸Šæ–‡å¯çŸ¥ï¼ŒintroductionAwareMethodMatcherçš„å®ç°ç±»å°±æ˜¯<code>AspectJExpressionPointcut</code>ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">public static boolean canApply(Pointcut pc, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123;
    Assert.notNull(pc, &quot;Pointcut must not be null&quot;);
    if (!pc.getClassFilter().matches(targetClass)) &#123;
        return false;
    &#125;
    &#x2F;&#x2F; è¿™é‡Œåªæœ‰TruePointcutæ‰ä¼šè¿”å›MethodMatcher.TRUE
    &#x2F;&#x2F; æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Aspectè¯­æ³•ï¼Œå¯¹åº”çš„æ˜¯AspectJExpressionPointcut
    MethodMatcher methodMatcher &#x3D; pc.getMethodMatcher();
    if (methodMatcher &#x3D;&#x3D; MethodMatcher.TRUE) &#123;
        &#x2F;&#x2F; No need to iterate the methods if we&#39;re matching any method anyway...
        return true;
    &#125;

    IntroductionAwareMethodMatcher introductionAwareMethodMatcher &#x3D; null;
    if (methodMatcher instanceof IntroductionAwareMethodMatcher) &#123;
        introductionAwareMethodMatcher &#x3D; (IntroductionAwareMethodMatcher) methodMatcher;
    &#125;

    Set&lt;Class&lt;?&gt;&gt; classes &#x3D; new LinkedHashSet&lt;&gt;();
    if (!Proxy.isProxyClass(targetClass)) &#123;
        classes.add(ClassUtils.getUserClass(targetClass));
    &#125;
    classes.addAll(ClassUtils.getAllInterfacesForClassAsSet(targetClass));

    for (Class&lt;?&gt; clazz : classes) &#123;
        Method[] methods &#x3D; ReflectionUtils.getAllDeclaredMethods(clazz);
        &#x2F;&#x2F; è¿™é‡Œéå†classä¸­çš„æ¯ä¸€ä¸ªclassï¼Œçœ‹æ˜¯å¦æ»¡è¶³pointcut
        for (Method method : methods) &#123;
            if (introductionAwareMethodMatcher !&#x3D; null ?
                    introductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions) :
                    methodMatcher.matches(method, targetClass)) &#123;
                return true;
            &#125;
        &#125;
    &#125;
    return false;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸Šé¢æåˆ°introductionAwareMethodMatcheræ¥è‡ªäº<code>AspectJExpressionPointcut</code>ï¼Œæˆ‘ä»¬è¿›å»æ¥ç€çœ‹ä¸‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">@Override
public boolean matches(Method method, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123;
 obtainPointcutExpression();
 ShadowMatch shadowMatch &#x3D; getTargetShadowMatch(method, targetClass);

 &#x2F;&#x2F; Special handling for this, target, @this, @target, @annotation
 &#x2F;&#x2F; in Spring - we can optimize since we know we have exactly this class,
 &#x2F;&#x2F; and there will never be matching subclass at runtime.
 if (shadowMatch.alwaysMatches()) &#123;
  return true;
 &#125;
 else if (shadowMatch.neverMatches()) &#123;
  return false;
 &#125;
 else &#123;
  &#x2F;&#x2F; the maybe case
  if (hasIntroductions) &#123;
   return true;
  &#125;
  &#x2F;&#x2F; A match test returned maybe - if there are any subtype sensitive variables
  &#x2F;&#x2F; involved in the test (this, target, at_this, at_target, at_annotation) then
  &#x2F;&#x2F; we say this is not a match as in Spring there will never be a different
  &#x2F;&#x2F; runtime subtype.
  RuntimeTestWalker walker &#x3D; getRuntimeTestWalker(shadowMatch);
  return (!walker.testsSubtypeSensitiveVars() || walker.testTargetInstanceOfResidue(targetClass));
 &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸ç”¨çœ‹é€»è¾‘äº†ï¼ŒSpringçš„æ³¨é‡Šå·²ç»å†™çš„å¾ˆæ˜ç™½äº†ã€‚æ„æ€æ˜¯æœ‰éƒ¨åˆ†è¡¨è¾¾å¼ä¸ä¼šæ¶‰åŠåˆ°<code>subclass at runtime</code>ï¼ŒSpringå¯åŠ¨çš„æ—¶å€™å°±å¯ä»¥å†³å®šæ˜¯å¦éœ€è¦ä»£ç†ï¼Œä½†æœ‰éƒ¨åˆ†è¡¨è¾¾å¼æ¶‰åŠ<code>è¿è¡Œæ—¶å­ç±»</code>ï¼Œè¿™æ ·Springæ²¡æœ‰åŠæ³•äº†ï¼Œç›´æ¥æŠŠæ‰€æœ‰beanéƒ½ä»£ç†äº†ï¼Œè¿™æ ·åœ¨è¿è¡Œæ—¶åˆ¤æ–­æ˜¯å¦æ»¡è¶³åˆ‡ç‚¹ã€‚<br>
å¾ˆä¸å¹¸ï¼Œä½¿ç”¨äº†@targetï¼Œä½ çš„æ‰€æœ‰beanéƒ½ä¼šè¢«ä»£ç†ï¼Œè¿™æ ·ä¹Ÿå°±å›ç­”äº†å¼€å§‹æ—¶ç½‘å‹ä»¬æåˆ°çš„é—®é¢˜ã€‚</p>
<h2 id="æ·±å…¥åˆ†æ">æ·±å…¥åˆ†æ</h2>
<blockquote>
<p>é€ æˆè¿™ä¸ªé—®é¢˜çš„ä¸»è¦æ˜¯Aspectjçš„è¯­ä¹‰ï¼ŒAspectjä½¿ç”¨ç»‡å…¥ï¼Œè€ŒSpring AOPé‡‡ç”¨çš„åŠ¨æ€ä»£ç†å®ç°AOPã€‚</p>
<p>Aspectjå’ŒSpring AOPæ˜¯AOPå®ç°çš„ä¸¤ç§æ–¹å¼ï¼Œåªæ˜¯<code>@Aspectj</code>è®©Springèƒ½ä½¿ç”¨Aspectjçš„è¯­æ³•</p>
<p>æ—¢ç„¶ä½¿ç”¨Aspectjè¯­æ³•ï¼Œ<a href="https://www.eclipse.org/aspectj/doc/released/adk15notebook/annotations-pointcuts-and-advice.html#runtime-type-matching-and-context-exposure">è¿™ä¸ªcaseåœ¨è¯­ä¹‰å±‚é¢æ˜¯éœ€è¦ <strong>Runtime type matching</strong></a>ï¼Œæ‰€ä»¥@targetä¼šä»£ç†æ‰€æœ‰beanåœ¨è¿è¡ŒæœŸåˆ¤å®šã€‚</p>
</blockquote>
<p>ä½†æˆ‘è®¤ä¸ºè¿™å—æ˜¯æœ‰é—®é¢˜çš„</p>
<ol>
<li>æ³¨é‡Šä¸­å’ŒAspectjè¯­æ³•æåˆ°<code>this</code>,<code>target</code>,<code>args</code>,<code>@this</code>,<code>@target</code>,<code>@annotaiton</code>,<code>@args</code>éƒ½ä¼šä½¿ç”¨åœ¨è¿è¡ŒæœŸåˆ¤æ–­ï¼Œä½†å®é™…æµ‹è¯•åªæœ‰<code>@target</code>ï¼Œ<code>@args</code>è¢«ç‰¹æ®Šå¤„ç†äº†ã€‚</li>
<li><code>@target</code>çš„è§£æç±»æ˜¯<code>ThisOrTargetAnnotationPointcut</code>ï¼Œä»ç±»çš„åä¸Šçœ‹å¤„ç†äº†<code>@this</code>å’Œ<code>@target</code>ï¼Œä½†<code>@this</code>å¹¶ä¸è¢«Springæ”¯æŒï¼Œåº”è¯¥æ˜¯è¦å¤„ç†<code>@this</code>çš„ä¸€äº›è¯­ä¹‰ï¼Œä½†æ²¡å®ç°å®Œã€‚ä»<code>@this</code>è¯­ä¹‰ä¸Šçœ‹ï¼Œå’Œè¿è¡Œä¸Šä¸‹æ–‡æ˜¯å¼ºç›¸å…³çš„ã€‚</li>
<li>ä»<a href="https://blog.csdn.net/zl3450341/article/details/7673979">è·Ÿæˆ‘å­¦aspectjä¹‹åä¸€ ----- target() this() within()çš„åŒºåˆ«<br>
</a>å’Œ<a href="https://blog.csdn.net/yangshangwei/article/details/77861658">Spring-AOP @AspectJåˆ‡ç‚¹å‡½æ•°ä¹‹target()å’Œthis()</a>ä¸Šçœ‹ï¼Œ<code>this</code>åœ¨<code>Spring AOP</code>å’Œ<code>Aspectj</code>ä¸Šçš„è¯­ä¹‰ä¼¼ä¹ä¸ä¸€æ ·ï¼Œè¿™å—æˆ‘ç¡®è®¤äº†Spring AOPï¼Œæœ‰æ—¶é—´äº†è¦è¯•è¯•åŸç”ŸAspectj</li>
</ol>
<p>æœ€åï¼Œå®˜æ–¹å›å¤ä¸Šçœ‹ï¼Œä¼¼ä¹è®¤å®šäº†æ˜¯ä¸€ä¸ªbug</p>
<p><a href="https://github.com/spring-projects/spring-framework/issues/20092">@target PointCut causes unrelated beans to be proxied [SPR-15533]</a></p>
<p><a href="https://github.com/spring-projects/spring-framework/issues/6859">@target() advices beans it should not [SPR-2168] #6859</a></p>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring AOP</tag>
        <tag>Aspect</tag>
      </tags>
  </entry>
</search>
